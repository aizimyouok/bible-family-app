<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Bible Time for Family</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/SHO8YuH.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-myeongjo { font-family: 'Nanum Myeongjo', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c5a992; border-radius: 10px; }
        
        /* í…Œë§ˆ ì •ì˜ */
        .theme-jerusalem { --bg-main: #fdfaf6; --bg-container: #ffffff; --bg-accent: #f8f1e9; --text-primary: #5a4b42; --text-accent: #8d6e63; --border-color: #d7ccc8; --highlight-bg: #f5e1d3; }
        .theme-creation { --bg-main: #f0f4f8; --bg-container: #ffffff; --bg-accent: #e6f0e6; --text-primary: #2c3e50; --text-accent: #1e8449; --border-color: #d4e6d4; --highlight-bg: #d4edda; }
        .theme-exodus { --bg-main: #f4eade; --bg-container: #fff8f0; --bg-accent: #eaddc7; --text-primary: #4a3f35; --text-accent: #a0522d; --border-color: #d1c4b8; --highlight-bg: #e6dace; }
        .theme-kingdom { --bg-main: #f0f2f5; --bg-container: #ffffff; --bg-accent: #e8eaf6; --text-primary: #37474f; --text-accent: #3f51b5; --border-color: #c5cae9; --highlight-bg: #d9dcf2; }
        
        body { background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.5s, color 0.5s; }
        .main-container { background-color: var(--bg-container); }
        .accent-bg { background-color: var(--bg-accent); }
        .accent-text { color: var(--text-accent); }
        .highlight-bg { background-color: var(--highlight-bg); }
        .progress-bar-fill { background-color: var(--text-accent); transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .tab-active { border-color: var(--text-accent); color: var(--text-accent); }
        
        /* ë©”ì¸ íƒ­ ìŠ¤íƒ€ì¼ */
        .main-tab {
            transition: all 0.3s ease;
        }
        .main-tab.tab-active {
            border-color: var(--text-accent);
            color: var(--text-accent);
        }
        .main-tab:not(.tab-active) {
            border-color: transparent;
            color: #6b7280;
        }
        .main-tab:not(.tab-active):hover {
            color: #374151;
            border-color: #d1d5db;
        }
        
        /* íƒ­ ì½˜í…ì¸  ì• ë‹ˆë©”ì´ì…˜ */
        .tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ìƒˆë¡œìš´ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .chapter-btn-animate { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            transform: scale(1);
        }
        .chapter-btn-animate:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .chapter-btn-animate.checked { 
            animation: checkPulse 0.6s ease-out;
        }
        
        @keyframes checkPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .slide-in { animation: slideInUp 0.5s ease-out; }
        
        .leaderboard-animate {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* í†µê³„ ì°¨íŠ¸ ìŠ¤íƒ€ì¼ */
        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--text-accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ì˜¤í”„ë¼ì¸ ì¸ë””ì¼€ì´í„° */
        .offline-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="theme-jerusalem">

    <div id="app" class="relative p-4 md:p-8 max-w-6xl mx-auto">
        <div id="header-top-right" class="absolute top-4 right-4 md:top-8 md:right-8 flex flex-col items-end gap-2 z-10">
            <div id="connection-status" class="flex items-center justify-center gap-2">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-sm">ì—°ê²° ì¤‘...</span>
                <div id="pending-changes" class="hidden offline-badge">
                    <span id="pending-count">0</span>ê°œ ë³€ê²½ì‚¬í•­
                </div>
                <button id="sync-btn" class="ml-1 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 hidden" title="ë™ê¸°í™”">ğŸ”„</button>
                <button id="admin-btn" class="ml-1 px-2 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600 hidden" title="ê´€ë¦¬">âš™ï¸</button>
            </div>
            <div>
                <label for="theme-select" class="mr-2 text-sm">í…Œë§ˆ:</label>
                <select id="theme-select" class="p-1 rounded border-2 text-sm" style="border-color: var(--border-color); background-color: var(--bg-accent);">
                    <option value="theme-jerusalem">ì˜ˆë£¨ì‚´ë ˜</option>
                    <option value="theme-creation">ì²œì§€ì°½ì¡°</option>
                    <option value="theme-exodus">ì¶œì• êµ½</option>
                    <option value="theme-kingdom">ì™•êµ­</option>
                </select>
            </div>
        </div>

        <header class="text-center pt-20 md:pt-0 mb-8">
            <h1 class="text-4xl md:text-5xl font-myeongjo font-bold accent-text">Bible Time for Family</h1>
            <p class="mt-2 text-lg">ìš°ë¦¬ê°€ì¡±, ë§ì”€ìœ¼ë¡œ í•˜ë‚˜ë˜ëŠ” ì‹œê°„</p>
        </header>

        <div class="main-container shadow-xl rounded-2xl p-4 md:p-6">
            <!-- ë©”ì¸ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Main Tabs">
                    <button id="tab-main" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active" data-tab="main">
                        ğŸ“– ë§ì”€ê³¼ ì½ê¸°
                    </button>
                    <button id="tab-sharing" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="sharing">
                        ğŸ’¬ ë¬µìƒê³¼ ê¸°ë„
                    </button>
                    <button id="tab-stats" class="main-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="stats">
                        ğŸ“Š í†µê³„ì™€ í˜„í™©
                    </button>
                </nav>
            </div>

            <!-- ì²«ë²ˆì§¸ íƒ­: ë§ì”€ê³¼ ì½ê¸° -->
            <div id="content-main" class="tab-content">
                <!-- ì˜¤ëŠ˜ì˜ ì§€í˜œ ë§ì”€ -->
                <section class="mb-8 text-center p-6 border-2 border-dashed slide-in" style="border-color: var(--border-color);">
                    <h2 class="text-xl font-bold font-myeongjo accent-text mb-2">ì˜¤ëŠ˜ì˜ ì§€í˜œ ë§ì”€</h2>
                    <p id="wisdom-verse" class="text-lg"></p>
                </section>

                <!-- ë§ì”€ ì½ê¸° ìˆœìœ„ (ë¦¬ë”ë³´ë“œ) -->
                <section id="leaderboard" class="mb-8 leaderboard-animate"></section>
                
                <!-- ê°€ì¡± í”„ë¡œí•„ ëŒ€ì‹œë³´ë“œ -->
                <section id="family-dashboard" class="mb-8 accent-bg rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center"></section>
                
                <!-- êµ¬ì•½/ì‹ ì•½ ì„±ê²½ í¼ì¹˜ê¸° -->
                <section class="mb-8 space-y-4">
                    <details class="group">
                        <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                            <span class="group-open:hidden">ğŸ“– êµ¬ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span>
                            <span class="hidden group-open:inline">ğŸ“– êµ¬ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                        </summary>
                        <div class="mt-4">
                            <h3 class="text-xl font-semibold mb-3 text-center accent-text">êµ¬ì•½ (39ê¶Œ)</h3>
                            <div id="old-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                        </div>
                    </details>
                    <details class="group">
                        <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                            <span class="group-open:hidden">ğŸ“– ì‹ ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span>
                            <span class="hidden group-open:inline">ğŸ“– ì‹ ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                        </summary>
                        <div class="mt-4">
                            <h3 class="text-xl font-semibold mb-3 text-center accent-text">ì‹ ì•½ (27ê¶Œ)</h3>
                            <div id="new-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                        </div>
                    </details>
                </section>
            </div>

            <!-- ë‘ë²ˆì§¸ íƒ­: ë¬µìƒê³¼ ê¸°ë„ -->
            <div id="content-sharing" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ê°€ì¡± ë¬µìƒ ë‚˜ëˆ” -->
                    <div class="accent-bg rounded-lg p-4">
                        <h3 class="text-xl font-bold mb-3">ğŸ’¬ ê°€ì¡± ë¬µìƒ ë‚˜ëˆ”</h3>
                        <div id="meditation-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2"></div>
                        <div class="flex gap-2">
                            <select id="meditation-user" class="p-2 rounded-md" style="border-color: var(--border-color);"></select>
                            <input type="text" id="meditation-input" class="flex-grow p-2 rounded-md" placeholder="ì˜¤ëŠ˜ì˜ ë¬µìƒì„ ë‚˜ëˆ ë³´ì„¸ìš”..." style="border-color: var(--border-color);">
                            <button id="add-meditation" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                        </div>
                    </div>
                    
                    <!-- ê°€ì¡± ê¸°ë„ ë…¸íŠ¸ -->
                    <div class="accent-bg rounded-lg p-4">
                        <h3 class="text-xl font-bold mb-3">ğŸ™ ê°€ì¡± ê¸°ë„ ë…¸íŠ¸</h3>
                        <div id="prayer-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2"></div>
                        <div class="flex gap-2">
                            <select id="prayer-user" class="p-2 rounded-md" style="border-color: var(--border-color);"></select>
                            <input type="text" id="prayer-input" class="flex-grow p-2 rounded-md" placeholder="í•¨ê»˜ ê¸°ë„í•  ì œëª©ì„ ë‚˜ëˆ ìš”..." style="border-color: var(--border-color);">
                            <button id="add-prayer" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                        </div>
                    </div>
                </div>

                <!-- ì¶”ê°€ ë¬µìƒ ë„êµ¬ë“¤ (í–¥í›„ í™•ì¥ ê°€ëŠ¥) -->
                <div class="mt-6 accent-bg rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-3 accent-text">ğŸ’¡ ë¬µìƒ ë„ìš°ë¯¸</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white/50 p-3 rounded">
                            <h4 class="font-semibold mb-2">ğŸ¤” ì§ˆë¬¸í•˜ê¸°</h4>
                            <p class="text-gray-600">ì´ ë§ì”€ì´ ë‚´ ì‚¶ì— ì–´ë–¤ ì˜ë¯¸ì¼ê¹Œ?</p>
                        </div>
                        <div class="bg-white/50 p-3 rounded">
                            <h4 class="font-semibold mb-2">â¤ï¸ ê°ì‚¬í•˜ê¸°</h4>
                            <p class="text-gray-600">ì˜¤ëŠ˜ í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬í•œ ì¼ì€?</p>
                        </div>
                        <div class="bg-white/50 p-3 rounded">
                            <h4 class="font-semibold mb-2">ğŸ¯ ì ìš©í•˜ê¸°</h4>
                            <p class="text-gray-600">ë‚´ì¼ ì‹¤ì²œí•  ìˆ˜ ìˆëŠ” ê²ƒì€?</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì„¸ë²ˆì§¸ íƒ­: í†µê³„ì™€ í˜„í™© -->
            <div id="content-stats" class="tab-content hidden">
                <!-- ì½ê¸° í†µê³„ ì°¨íŠ¸ -->
                <section id="statistics-section" class="mb-8 accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 accent-text text-center">ğŸ“Š ì½ê¸° í†µê³„</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- ê°œì¸ë³„ ìƒì„¸ ì§„í–‰ í˜„í™© -->
                <section class="mb-8">
                    <h3 class="text-xl font-bold mb-4 accent-text text-center">ğŸ‘¥ ê°œì¸ë³„ ì§„í–‰ í˜„í™©</h3>
                    <div id="detailed-progress" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>

                <!-- ë±ƒì§€ ì‹œìŠ¤í…œ (í–¥í›„ ê¸°ëŠ¥) -->
                <section class="mb-8 accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-4 accent-text text-center">ğŸ† ë±ƒì§€ ë° ì„±ì·¨</h3>
                    <div class="text-center p-8 text-gray-500">
                        <div class="text-4xl mb-4">ğŸš§</div>
                        <p class="text-lg">ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤!</p>
                        <p class="text-sm mt-2">ì²« ì™„ë…, ì—°ì† ì½ê¸°, ê°€ì¡± 1ë“± ë“±ì˜ ë±ƒì§€ ì‹œìŠ¤í…œì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
                    </div>
                </section>

                <!-- ì½ê¸° íŒ¨í„´ ë¶„ì„ -->
                <section class="accent-bg rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-3 accent-text">ğŸ“ˆ ì½ê¸° íŒ¨í„´ ë¶„ì„</h3>
                    <div id="reading-patterns" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div class="bg-white/50 p-3 rounded text-center">
                            <div class="text-2xl mb-2">ğŸ“…</div>
                            <div class="font-semibold">ì´ë²ˆ ì£¼</div>
                            <div id="this-week-count" class="text-lg font-bold accent-text">-</div>
                        </div>
                        <div class="bg-white/50 p-3 rounded text-center">
                            <div class="text-2xl mb-2">ğŸ”¥</div>
                            <div class="font-semibold">ì—°ì† ì½ê¸°</div>
                            <div id="streak-count" class="text-lg font-bold accent-text">-</div>
                        </div>
                        <div class="bg-white/50 p-3 rounded text-center">
                            <div class="text-2xl mb-2">â­</div>
                            <div class="font-semibold">ì¦ê²¨ ì½ëŠ” ì±…</div>
                            <div id="favorite-book" class="text-sm font-bold accent-text">-</div>
                        </div>
                        <div class="bg-white/50 p-3 rounded text-center">
                            <div class="text-2xl mb-2">ğŸ¯</div>
                            <div class="font-semibold">ì™„ë…í•œ ì±…</div>
                            <div id="completed-books" class="text-lg font-bold accent-text">-</div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold"></h2><button id="close-modal" class="text-3xl">&times;</button></div><div id="modal-user-selector-container" class="flex items-center gap-2 mb-4"><label for="modal-user-selector">ì²´í¬í•  ì‚¬ëŒ:</label><select id="modal-user-selector" class="p-1 border rounded"></select></div><div id="modal-chapters" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 p-2 accent-bg rounded custom-scrollbar"></div></div></div>
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg max-h-[80vh] flex flex-col"><div class="flex items-center mb-4"><img id="progress-modal-photo" class="w-16 h-16 rounded-full mr-4" src="" alt="í”„ë¡œí•„ ì‚¬ì§„" referrerpolicy="no-referrer"><div class="flex-grow"><h2 id="progress-modal-title" class="text-2xl font-bold"></h2></div><button id="close-progress-modal" class="text-3xl">&times;</button></div><div class="border-b border-gray-200 mb-4"><nav class="-mb-px flex space-x-8" aria-label="Tabs"><button id="tab-ot" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">êµ¬ì•½</button><button id="tab-nt" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">ì‹ ì•½</button></nav></div><div id="progress-modal-content" class="flex-grow overflow-y-auto custom-scrollbar pr-4"><div id="content-ot"></div><div id="content-nt" class="hidden"></div></div></div></div>

    <!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬</h2>
                <button id="close-admin-modal" class="text-3xl">&times;</button>
            </div>
            
            <!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ -->
            <div id="password-section" class="border border-gray-200 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-bold mb-2 text-purple-600">ğŸ” ê´€ë¦¬ì ì¸ì¦</h3>
                <div class="flex gap-2 items-center">
                    <input type="password" id="admin-password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                           class="flex-grow p-2 border rounded-md">
                    <button id="verify-password-btn" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        ì¸ì¦
                    </button>
                </div>
                <div id="auth-status" class="mt-2 text-sm hidden"></div>
            </div>
            
            <div id="admin-functions" class="flex-grow overflow-y-auto space-y-4 hidden">
                <!-- ë³´ì•ˆ ì„¤ì • í™•ì¸ -->
                <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                    <h3 class="text-lg font-bold mb-2 text-blue-700">ğŸ”’ ì‹œìŠ¤í…œ ì •ë³´</h3>
                    <div class="text-sm space-y-1">
                        <div>ë³´ì•ˆ ëª¨ë“œ: <span id="security-status" class="font-semibold"></span></div>
                        <div>API ìƒíƒœ: <span id="api-key-status" class="font-mono text-xs"></span></div>
                        <div class="text-xs text-blue-600 mt-2">
                            â„¹ï¸ ê°€ì¡±ìš© ëŒ€ì‹œë³´ë“œë¡œ ê°„í¸í•˜ê²Œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
                
                <!-- ë°±ì—… ì„¹ì…˜ -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-2 text-green-600">ğŸ’¾ ë°ì´í„° ë°±ì—…</h3>
                    <p class="text-sm text-gray-600 mb-3">í˜„ì¬ ëª¨ë“  ë°ì´í„°ë¥¼ ìƒˆ ì‹œíŠ¸ì— ë°±ì—…í•©ë‹ˆë‹¤.</p>
                    <button id="backup-btn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mr-2">
                        ë°±ì—… ìƒì„±
                    </button>
                    <div id="backup-result" class="mt-2 p-2 bg-gray-100 rounded text-sm hidden"></div>
                </div>
                
                <!-- ë°ì´í„° ì •ë¦¬ ì„¹ì…˜ -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-2 text-red-600">âš ï¸ ë°ì´í„° ì •ë¦¬</h3>
                    <p class="text-sm text-gray-600 mb-3">ì¤‘ë³µëœ ì½ê¸° ê¸°ë¡ì„ ì •ë¦¬í•©ë‹ˆë‹¤. <strong>ë°±ì—… í›„ ì‹¤í–‰í•˜ì„¸ìš”!</strong></p>
                    <div class="flex gap-2">
                        <button id="cleanup-btn" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">ì¤‘ë³µ ê¸°ë¡ ì •ë¦¬</button>
                        <button id="analyze-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ì¤‘ë³µ ë¶„ì„</button>
                    </div>
                    <div id="cleanup-result" class="mt-2 p-2 bg-gray-100 rounded text-sm hidden"></div>
                </div>
                
                <!-- ì§„ë‹¨ ì •ë³´ ì„¹ì…˜ -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-2 text-blue-600">ğŸ” ì‹œìŠ¤í…œ ì§„ë‹¨</h3>
                    <button id="diagnostic-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mb-3">ì§„ë‹¨ ì‹¤í–‰</button>
                    <div id="diagnostic-result" class="text-sm bg-gray-100 rounded p-2 hidden overflow-auto max-h-40"></div>
                </div>
                
                <!-- ì—°ê²° ì •ë³´ ì„¹ì…˜ -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-bold mb-2 text-purple-600">ğŸ“¡ ì—°ê²° ìƒíƒœ</h3>
                    <div id="connection-info" class="text-sm space-y-1">
                        <div>API ìƒíƒœ: <span id="api-status">í™•ì¸ ì¤‘...</span></div>
                        <div>ë§ˆì§€ë§‰ ë™ê¸°í™”: <span id="last-sync">ì—†ìŒ</span></div>
                        <div>ë³´ë¥˜ ì¤‘ì¸ ë³€ê²½ì‚¬í•­: <span id="pending-info">0ê°œ</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// === ê¸°ë³¸ ì„¤ì • ===
const API_CONFIG = {
    scriptUrl: 'https://script.google.com/macros/s/AKfycbwrqnyK-9Ft64KN0ecWv8_XaOoZyaBQf8CLYmDgvJjjpcuqLl8dzE0UM1SFsBp8zq7pkA/exec',
    apiKey: 'bible_family_default',
    enableSecurity: false // ê°€ì¡±ìš©ì´ë¯€ë¡œ ë³´ì•ˆ ê¸°ëŠ¥ ë¹„í™œì„±í™”
};

// === ê°œì„ ëœ API ë° ìºì‹± ì‹œìŠ¤í…œ ===
class EnhancedGoogleSheetsAPI {
    constructor() {
        this.scriptUrl = API_CONFIG.scriptUrl;
        this.apiKey = API_CONFIG.apiKey;
        this.enableSecurity = API_CONFIG.enableSecurity;
        this.isConnected = false;
        this.pendingChanges = [];
        this.syncInProgress = false;
        this.lastSyncTime = null;
        this.autoSyncInterval = null;
        
        // 5ì´ˆë§ˆë‹¤ ìë™ ë™ê¸°í™” ì‹œë„
        this.startAutoSync();
    }
    
    startAutoSync() {
        this.autoSyncInterval = setInterval(() => {
            if (this.pendingChanges.length > 0 && this.isConnected && !this.syncInProgress) {
                this.processPendingChanges();
            }
        }, 5000);
    }
    
    stopAutoSync() {
        if (this.autoSyncInterval) {
            clearInterval(this.autoSyncInterval);
            this.autoSyncInterval = null;
        }
    }
    
    async _request(action, params = {}) {
        const url = new URL(this.scriptUrl);
        url.searchParams.set('action', action);
        
        for (const key in params) {
            url.searchParams.set(key, params[key]);
        }
        
        try {
            const response = await fetch(url.toString());
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'API ìš”ì²­ ì‹¤íŒ¨');
            
            this.isConnected = true;
            this.lastSyncTime = Date.now();
            return result;
        } catch (error) {
            this.isConnected = false;
            updateConnectionStatus('disconnected');
            console.error(`API Error (${action}):`, error);
            throw error;
        }
    }
    
    // ë³€ê²½ì‚¬í•­ì„ íì— ì¶”ê°€í•˜ê³  ë¡œì»¬ì— ì¦‰ì‹œ ì €ì¥
    addPendingChange(changeData) {
        const changeId = Date.now() + Math.random();
        const change = {
            id: changeId,
            timestamp: Date.now(),
            ...changeData
        };
        
        this.pendingChanges.push(change);
        this.savePendingChangesToLocal();
        this.updatePendingCounter();
        
        // ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        this.applyChangeLocally(change);
        
        return changeId;
    }
    
    // ë¡œì»¬ì— ë³€ê²½ì‚¬í•­ ì¦‰ì‹œ ì ìš©
    applyChangeLocally(change) {
        const { type, userId, bookName, chapter, content } = change;
        
        if (type === 'reading') {
            if (!db.readRecords[userId]) db.readRecords[userId] = {};
            if (!db.readRecords[userId][bookName]) db.readRecords[userId][bookName] = [];
            
            const readList = db.readRecords[userId][bookName];
            const chapterIndex = readList.indexOf(chapter);
            
            if (change.action === 'delete' && chapterIndex > -1) {
                readList.splice(chapterIndex, 1);
            } else if (change.action === 'save' && chapterIndex === -1) {
                readList.push(chapter);
            }
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        this.saveToLocalStorage();
    }
    
    savePendingChangesToLocal() {
        localStorage.setItem('bible_pending_changes', JSON.stringify(this.pendingChanges));
    }
    
    loadPendingChangesFromLocal() {
        const stored = localStorage.getItem('bible_pending_changes');
        if (stored) {
            this.pendingChanges = JSON.parse(stored);
            this.updatePendingCounter();
        }
    }
    
    updatePendingCounter() {
        const counter = document.getElementById('pending-count');
        const badge = document.getElementById('pending-changes');
        
        if (this.pendingChanges.length > 0) {
            counter.textContent = this.pendingChanges.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    
    async processPendingChanges() {
        if (this.syncInProgress || this.pendingChanges.length === 0) return;
        
        this.syncInProgress = true;
        updateConnectionStatus('syncing');
        
        try {
            // ë³€ê²½ì‚¬í•­ë“¤ì„ ê·¸ë£¹í™”í•˜ì—¬ ë°°ì¹˜ ì²˜ë¦¬
            const changes = [...this.pendingChanges];
            
            for (const change of changes) {
                try {
                    if (change.action === 'save') {
                        await this._request('save', {
                            type: change.type,
                            userId: change.userId,
                            bookName: change.bookName,
                            chapter: change.chapter,
                            content: change.content
                        });
                    } else if (change.action === 'delete') {
                        await this._request('delete', {
                            type: change.type,
                            userId: change.userId,
                            bookName: change.bookName,
                            chapter: change.chapter,
                            id: change.id
                        });
                    }
                    
                    // ì„±ê³µí•œ ë³€ê²½ì‚¬í•­ ì œê±°
                    this.pendingChanges = this.pendingChanges.filter(c => c.id !== change.id);
                } catch (error) {
                    console.error('ê°œë³„ ë³€ê²½ì‚¬í•­ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨í•œ ê²ƒì€ íì— ë‚¨ê²¨ë‘ 
                }
            }
            
            this.savePendingChangesToLocal();
            this.updatePendingCounter();
            updateConnectionStatus('connected');
            
        } catch (error) {
            console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
            updateConnectionStatus('disconnected');
        } finally {
            this.syncInProgress = false;
        }
    }
    
    saveToLocalStorage() {
        const timestamp = Date.now();
        localStorage.setItem('bible_data_timestamp', timestamp.toString());
        localStorage.setItem('bible_family', JSON.stringify(db.family));
        localStorage.setItem('bible_readRecords', JSON.stringify(db.readRecords));
        localStorage.setItem('bible_badges', JSON.stringify(db.badges));
        localStorage.setItem('bible_meditations', JSON.stringify(db.meditations));
        localStorage.setItem('bible_prayers', JSON.stringify(db.prayers));
    }
    
    loadFromLocalStorage() {
        try {
            const timestamp = localStorage.getItem('bible_data_timestamp');
            const family = JSON.parse(localStorage.getItem('bible_family') || '[]');
            const readRecords = JSON.parse(localStorage.getItem('bible_readRecords') || '{}');
            const badges = JSON.parse(localStorage.getItem('bible_badges') || '{}');
            const meditations = JSON.parse(localStorage.getItem('bible_meditations') || '[]');
            const prayers = JSON.parse(localStorage.getItem('bible_prayers') || '[]');
            
            return {
                timestamp: timestamp ? parseInt(timestamp) : null,
                family, readRecords, badges, meditations, prayers
            };
        } catch (error) {
            console.error('ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            return null;
        }
    }
    
    async testConnection() {
        await this._request('test');
        return true;
    }
    
    async loadAllData() {
        const result = await this._request('loadAll');
        
        // ì„œë²„ ë°ì´í„°ë¥¼ ë¡œì»¬ì— ì €ì¥
        db.family = result.data.family_members || [];
        db.readRecords = result.data.reading_records || {};
        db.badges = result.data.badges || {};
        db.meditations = result.data.meditations || [];
        db.prayers = result.data.prayers || [];
        
        this.saveToLocalStorage();
        return result.data;
    }
    
    // ê¸°ì¡´ ë©”ì„œë“œë“¤ì„ í ì‹œìŠ¤í…œìœ¼ë¡œ ë³€ê²½
    async saveData(params) {
        const changeId = this.addPendingChange({
            action: 'save',
            ...params
        });
        
        // ì˜¨ë¼ì¸ì´ë©´ ì¦‰ì‹œ ë™ê¸°í™” ì‹œë„
        if (this.isConnected) {
            setTimeout(() => this.processPendingChanges(), 100);
        }
        
        return { success: true, data: { id: changeId, ...params } };
    }
    
    async deleteData(params) {
        const changeId = this.addPendingChange({
            action: 'delete',
            ...params
        });
        
        // ì˜¨ë¼ì¸ì´ë©´ ì¦‰ì‹œ ë™ê¸°í™” ì‹œë„
        if (this.isConnected) {
            setTimeout(() => this.processPendingChanges(), 100);
        }
        
        return { success: true };
    }
    
    async editData(params) {
        return this._request('edit', params);
    }
    
    // ìƒˆë¡œìš´ ê´€ë¦¬ì ê¸°ëŠ¥ë“¤
    async cleanupDuplicates(adminPassword) {
        return this._request('cleanup', { adminPassword });
    }
    
    async verifyAdminPassword(password) {
        return this._request('verifyAdmin', { password });
    }
    
    async createBackup(adminPassword) {
        return this._request('backup', { adminPassword });
    }
    
    async runDiagnostics() {
        return this._request('debug');
    }
}

// === í†µê³„ ì°¨íŠ¸ ì‹œìŠ¤í…œ ===
class StatisticsManager {
    constructor() {
        this.progressChart = null;
        this.weeklyChart = null;
    }
    
    initCharts() {
        this.createProgressChart();
        this.createWeeklyChart();
    }
    
    createProgressChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        const data = this.getProgressData();
        
        this.progressChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.values,
                    backgroundColor: [
                        '#8d6e63',
                        '#1e8449', 
                        '#a0522d',
                        '#3f51b5',
                        '#e91e63',
                        '#ff9800'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'ê°€ì¡±ë³„ ì½ê¸° ì§„ë„',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom'
                    }
                },
                animation: {
                    animateScale: true,
                    duration: 1000
                }
            }
        });
    }
    
    createWeeklyChart() {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        
        const data = this.getWeeklyData();
        
        this.weeklyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'ìµœê·¼ 7ì¼ ì½ê¸° ì¶”ì´',
                        font: { size: 16, weight: 'bold' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }
    
    getProgressData() {
        const labels = [];
        const values = [];
        
        db.family.forEach(member => {
            const totalRead = Object.values(db.readRecords[member.id] || {})
                .reduce((sum, chapters) => sum + chapters.length, 0);
            
            labels.push(member.name);
            values.push(totalRead);
        });
        
        return { labels, values };
    }
    
    getWeeklyData() {
        const days = [];
        const today = new Date();
        
        // ìµœê·¼ 7ì¼ ë‚ ì§œ ìƒì„±
        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            days.push({
                date: date,
                label: date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })
            });
        }
        
        const datasets = db.family.map((member, index) => {
            const colors = ['#8d6e63', '#1e8449', '#a0522d', '#3f51b5', '#e91e63', '#ff9800'];
            
            const data = days.map(day => {
                // ì‹¤ì œë¡œëŠ” ì¼ë³„ ì½ê¸° ê¸°ë¡ì´ í•„ìš”í•˜ì§€ë§Œ, 
                // í˜„ì¬ëŠ” ì„ì‹œë¡œ ëœë¤ ë°ì´í„° ì‚¬ìš© (ì‹¤ì œ êµ¬í˜„ì‹œ ë‚ ì§œë³„ ì½ê¸° ê¸°ë¡ í•„ìš”)
                return Math.floor(Math.random() * 5);
            });
            
            return {
                label: member.name,
                data: data,
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                tension: 0.4,
                fill: false
            };
        });
        
        return {
            labels: days.map(d => d.label),
            datasets: datasets
        };
    }
    
    updateCharts() {
        if (this.progressChart) {
            const data = this.getProgressData();
            this.progressChart.data.labels = data.labels;
            this.progressChart.data.datasets[0].data = data.values;
            this.progressChart.update('active');
        }
        
        if (this.weeklyChart) {
            const data = this.getWeeklyData();
            this.weeklyChart.data.datasets = data.datasets;
            this.weeklyChart.update('active');
        }
    }
}

// === ê¸°ì¡´ ì½”ë“œ (ë°ì´í„° ì •ì˜ ë¶€ë¶„) ===
const BIBLE_BOOKS = { old: [ { name: 'ì°½ì„¸ê¸°', chapters: 50 }, { name: 'ì¶œì• êµ½ê¸°', chapters: 40 }, { name: 'ë ˆìœ„ê¸°', chapters: 27 }, { name: 'ë¯¼ìˆ˜ê¸°', chapters: 36 }, { name: 'ì‹ ëª…ê¸°', chapters: 34 }, { name: 'ì—¬í˜¸ìˆ˜ì•„', chapters: 24 }, { name: 'ì‚¬ì‚¬ê¸°', chapters: 21 }, { name: 'ë£»ê¸°', chapters: 4 }, { name: 'ì‚¬ë¬´ì—˜ìƒ', chapters: 31 }, { name: 'ì‚¬ë¬´ì—˜í•˜', chapters: 24 }, { name: 'ì—´ì™•ê¸°ìƒ', chapters: 22 }, { name: 'ì—´ì™•ê¸°í•˜', chapters: 25 }, { name: 'ì—­ëŒ€ìƒ', chapters: 29 }, { name: 'ì—­ëŒ€í•˜', chapters: 36 }, { name: 'ì—ìŠ¤ë¼', chapters: 10 }, { name: 'ëŠí—¤ë¯¸ì•¼', chapters: 13 }, { name: 'ì—ìŠ¤ë”', chapters: 10 }, { name: 'ìš¥ê¸°', chapters: 42 }, { name: 'ì‹œí¸', chapters: 150 }, { name: 'ì ì–¸', chapters: 31 }, { name: 'ì „ë„ì„œ', chapters: 12 }, { name: 'ì•„ê°€', chapters: 8 }, { name: 'ì´ì‚¬ì•¼', chapters: 66 }, { name: 'ì˜ˆë ˆë¯¸ì•¼', chapters: 52 }, { name: 'ì˜ˆë ˆë¯¸ì•¼ì• ê°€', chapters: 5 }, { name: 'ì—ìŠ¤ê²”', chapters: 48 }, { name: 'ë‹¤ë‹ˆì—˜', chapters: 12 }, { name: 'í˜¸ì„¸ì•„', chapters: 14 }, { name: 'ìš”ì—˜', chapters: 3 }, { name: 'ì•„ëª¨ìŠ¤', chapters: 9 }, { name: 'ì˜¤ë°”ëŒœ', chapters: 1 }, { name: 'ìš”ë‚˜', chapters: 4 }, { name: 'ë¯¸ê°€', chapters: 7 }, { name: 'ë‚˜í›”', chapters: 3 }, { name: 'í•˜ë°•êµ­', chapters: 3 }, { name: 'ìŠ¤ë°”ëƒ', chapters: 3 }, { name: 'í•™ê°œ', chapters: 2 }, { name: 'ìŠ¤ê°€ë´', chapters: 14 }, { name: 'ë§ë¼ê¸°', chapters: 4 } ], new: [ { name: 'ë§ˆíƒœë³µìŒ', chapters: 28 }, { name: 'ë§ˆê°€ë³µìŒ', chapters: 16 }, { name: 'ëˆ„ê°€ë³µìŒ', chapters: 24 }, { name: 'ìš”í•œë³µìŒ', chapters: 21 }, { name: 'ì‚¬ë„í–‰ì „', chapters: 28 }, { name: 'ë¡œë§ˆì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„ì „ì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„í›„ì„œ', chapters: 13 }, { name: 'ê°ˆë¼ë””ì•„ì„œ', chapters: 6 }, { name: 'ì—ë² ì†Œì„œ', chapters: 6 }, { name: 'ë¹Œë¦½ë³´ì„œ', chapters: 4 }, { name: 'ê³¨ë¡œìƒˆì„œ', chapters: 4 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ', chapters: 5 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ', chapters: 3 }, { name: 'ë””ëª¨ë°ì „ì„œ', chapters: 6 }, { name: 'ë””ëª¨ë°í›„ì„œ', chapters: 4 }, { name: 'ë””ë„ì„œ', chapters: 3 }, { name: 'ë¹Œë ˆëª¬ì„œ', chapters: 1 }, { name: 'íˆë¸Œë¦¬ì„œ', chapters: 13 }, { name: 'ì•¼ê³ ë³´ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œì „ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œí›„ì„œ', chapters: 3 }, { name: 'ìš”í•œ1ì„œ', chapters: 5 }, { name: 'ìš”í•œ2ì„œ', chapters: 1 }, { name: 'ìš”í•œ3ì„œ', chapters: 1 }, { name: 'ìœ ë‹¤ì„œ', chapters: 1 }, { name: 'ìš”í•œê³„ì‹œë¡', chapters: 22 } ] };

const TOTAL_OT_CHAPTERS = BIBLE_BOOKS.old.reduce((s, b) => s + b.chapters, 0);
const TOTAL_NT_CHAPTERS = BIBLE_BOOKS.new.reduce((s, b) => s + b.chapters, 0);

// === ì „ì—­ ë³€ìˆ˜ ===
let gapi = new EnhancedGoogleSheetsAPI();
let statisticsManager = new StatisticsManager();
let db = { family: [], readRecords: {}, badges: {}, meditations: [], prayers: [] };
let currentUserForModal = null, currentBook = null, currentProgressUserId = null;

// === ë©”ì¸ ì´ˆê¸°í™” ===
document.addEventListener('DOMContentLoaded', async () => { 
    setupEventListeners(); 
    renderWisdomVerse(); 
    renderBibleBooks(); 
    
    // ê¸°ë³¸ íƒ­ì„ ì²« ë²ˆì§¸ íƒ­ìœ¼ë¡œ ì„¤ì •
    switchMainTab('main');
    
    await initializeApp();
});

async function initializeApp() { 
    updateConnectionStatus('loading'); 
    
    // ë¡œì»¬ ë°ì´í„° ë¨¼ì € ë¡œë“œ
    const localData = gapi.loadFromLocalStorage();
    if (localData && localData.family && localData.family.length > 0) {
        db.family = localData.family;
        db.readRecords = localData.readRecords;
        db.badges = localData.badges;
        db.meditations = localData.meditations;
        db.prayers = localData.prayers;
        
        currentUserForModal = db.family[0].id;
        populateUserDropdowns();
        renderAll();
        statisticsManager.initCharts();
    }
    
    // ë³´ë¥˜ ì¤‘ì¸ ë³€ê²½ì‚¬í•­ ë¡œë“œ
    gapi.loadPendingChangesFromLocal();
    
    try { 
        await gapi.testConnection(); 
        updateConnectionStatus('connected'); 
        await loadAllDataAndRender(); 
    } catch (error) { 
        updateConnectionStatus('disconnected'); 
        console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤.');
    }
}

async function loadAllDataAndRender() { 
    try { 
        const allData = await gapi.loadAllData(); 
        db.family = allData.family_members || []; 
        db.readRecords = allData.reading_records || {}; 
        db.badges = allData.badges || {}; 
        db.meditations = allData.meditations || []; 
        db.prayers = allData.prayers || []; 
        
        if (db.family?.length > 0) { 
            currentUserForModal = db.family[0].id; 
            populateUserDropdowns(); 
            renderAll(); 
            statisticsManager.initCharts();
        } else if (gapi.isConnected) { 
            alert("ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ 'family_members' ì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."); 
        } 
    } catch (error) { 
        console.error('ì „ì²´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error); 
    } 
}

function renderAll() { 
    renderLeaderboard(); 
    renderFamilyDashboard(); 
    renderMeditations(); 
    renderPrayers(); 
    renderDetailedProgress();
    renderReadingPatterns();
    
    // í†µê³„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (statisticsManager.progressChart) {
        statisticsManager.updateCharts();
    }
}

// === í–¥ìƒëœ ì—°ê²° ìƒíƒœ í‘œì‹œ ===
function updateConnectionStatus(status) { 
    const indicator = document.getElementById('status-indicator'); 
    const text = document.getElementById('status-text'); 
    const syncBtn = document.getElementById('sync-btn'); 
    const adminBtn = document.getElementById('admin-btn');
    
    indicator.classList.remove('loading'); 
    
    switch (status) { 
        case 'connected': 
            indicator.className = 'w-3 h-3 rounded-full bg-green-500'; 
            text.textContent = 'ì˜¨ë¼ì¸'; 
            syncBtn.classList.remove('hidden'); 
            adminBtn.classList.remove('hidden');
            break; 
        case 'disconnected': 
            indicator.className = 'w-3 h-3 rounded-full bg-red-500'; 
            text.textContent = 'ì˜¤í”„ë¼ì¸'; 
            syncBtn.classList.add('hidden'); 
            adminBtn.classList.add('hidden');
            break; 
        case 'loading': 
            indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 loading'; 
            text.textContent = 'ì—°ê²° ì¤‘...'; 
            syncBtn.classList.add('hidden'); 
            adminBtn.classList.add('hidden');
            break;
        case 'syncing':
            indicator.className = 'w-3 h-3 rounded-full bg-blue-500 loading';
            text.textContent = 'ë™ê¸°í™” ì¤‘...';
            syncBtn.classList.add('hidden');
            adminBtn.classList.add('hidden');
            break;
    } 
}

// === í–¥ìƒëœ ë¦¬ë”ë³´ë“œ (ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€) ===
function renderLeaderboard() {
    const board = document.getElementById('leaderboard');
    if (!db.family || db.family.length < 1) { 
        board.innerHTML = ''; 
        return; 
    }

    const rankedUsers = db.family.map(member => {
        const chaptersRead = Object.values(db.readRecords[member.id] || {}).reduce((sum, chapters) => sum + chapters.length, 0);
        return { ...member, chaptersRead };
    }).sort((a, b) => b.chaptersRead - a.chaptersRead);

    if (rankedUsers[0].chaptersRead === 0) {
        board.innerHTML = `<div class="text-center p-4 accent-bg rounded-lg slide-in"><p>ì•„ì§ ì„±ê²½ ì½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í•¨ê»˜ ì‹œì‘í•´ë³¼ê¹Œìš”?</p></div>`;
        return;
    }

    const topScore = rankedUsers[0].chaptersRead;
    const winners = rankedUsers.filter(user => user.chaptersRead === topScore);
    const others = rankedUsers.filter(user => user.chaptersRead < topScore);

    const winnersHTML = `
        <div class="text-center">
            <h3 class="text-xl font-bold accent-text mb-2">${winners.length > 1 ? 'ğŸ† ê³µë™ 1ë“±! ğŸ†' : 'ğŸ† ë§ì”€ ì½ê¸° 1ë“±! ğŸ†'}</h3>
            <div class="flex items-center justify-center gap-4">
                <div class="flex -space-x-4">
                    ${winners.map(winner => `<img src="${winner.photo || 'https://placehold.co/80x80/cccccc/FFFFFF?text=?'}" alt="${winner.name}" class="w-16 h-16 rounded-full border-4 border-yellow-400 object-cover" referrerpolicy="no-referrer">`).join('')}
                </div>
                <div>
                    <p class="text-xl font-bold">${winners.map(w => w.name).join(', ')}</p>
                    <p class="text-lg">${topScore}ì¥</p>
                </div>
            </div>
        </div>`;

    let othersHTML = '<div class="w-full md:w-auto mt-4 md:mt-0">';
    if (others.length > 0) {
        let currentRank = winners.length + 1;
        others.slice(0, 3).forEach(user => {
            othersHTML += `
                <div class="flex items-center justify-between text-sm mb-2 slide-in">
                    <div class="flex items-center">
                        <span class="font-bold w-8 text-left">${currentRank}.</span>
                        <img src="${user.photo || 'https://placehold.co/40x40/cccccc/FFFFFF?text=?'}" alt="${user.name}" class="w-8 h-8 rounded-full mr-2 object-cover" referrerpolicy="no-referrer">
                        <span>${user.name}</span>
                    </div>
                    <span class="font-semibold">${user.chaptersRead}ì¥</span>
                </div>`;
            currentRank++;
        });
    }
    othersHTML += '</div>';

    board.innerHTML = `<div class="p-4 accent-bg rounded-lg flex flex-col md:flex-row items-center justify-center md:gap-8 lg:gap-16 slide-in">${winnersHTML}${othersHTML}</div>`;
}

// === ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìˆ˜ì • ì—†ìŒ) ===
function renderFamilyDashboard() { 
    const dashboard = document.getElementById('family-dashboard'); 
    dashboard.innerHTML = ''; 
    
    if (!db.family || db.family.length === 0) return; 
    
    db.family.forEach(member => { 
        const userRecords = db.readRecords[member.id] || {}; 
        const otRead = BIBLE_BOOKS.old.reduce((sum, book) => sum + (userRecords[book.name]?.length || 0), 0); 
        const ntRead = BIBLE_BOOKS.new.reduce((sum, book) => sum + (userRecords[book.name]?.length || 0), 0); 
        const totalRead = otRead + ntRead; 
        const totalChapters = TOTAL_OT_CHAPTERS + TOTAL_NT_CHAPTERS; 
        
        const memberDiv = document.createElement('div'); 
        memberDiv.className = 'flex flex-col items-center cursor-pointer hover:opacity-80 transition slide-in'; 
        memberDiv.onclick = () => openProgressModal(member.id); 
        memberDiv.innerHTML = `<img src="${member.photo || 'https://placehold.co/80x80/cccccc/FFFFFF?text=?'}" alt="${member.name}" class="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-white/50 object-cover shadow-md" referrerpolicy="no-referrer"><div class="font-bold mt-2">${member.title} (${member.name})</div><div class="text-sm mt-2 space-y-1"><div><strong>ì´:</strong> ${totalRead} / ${totalChapters}</div><div class="text-xs"><strong>êµ¬ì•½:</strong> ${otRead}/${TOTAL_OT_CHAPTERS} | <strong>ì‹ ì•½:</strong> ${ntRead}/${TOTAL_NT_CHAPTERS}</div></div>`; 
        dashboard.appendChild(memberDiv); 
    }); 
}

function renderWisdomVerse() { 
    const verses = [ "ìë…€ë“¤ì•„ ì£¼ ì•ˆì—ì„œ ë„ˆí¬ ë¶€ëª¨ì—ê²Œ ìˆœì¢…í•˜ë¼ ì´ê²ƒì´ ì˜³ìœ¼ë‹ˆë¼ (ì—ë² ì†Œì„œ 6:1)","ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤ (ì‹œí¸ 23:1)","ì£¼ ë„ˆì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•˜ê³  ë˜í•œ ë„¤ ì´ì›ƒì„ ë„¤ ìì‹  ê°™ì´ ì‚¬ë‘í•˜ë¼ (ë§ˆíƒœë³µìŒ 22:37-39)","í•­ìƒ ê¸°ë»í•˜ë¼ ì‰¬ì§€ ë§ê³  ê¸°ë„í•˜ë¼ ë²”ì‚¬ì— ê°ì‚¬í•˜ë¼ (ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ 5:16-18)","ìˆ˜ê³ í•˜ê³  ë¬´ê±°ìš´ ì§ ì§„ ìë“¤ì•„ ë‹¤ ë‚´ê²Œë¡œ ì˜¤ë¼ ë‚´ê°€ ë„ˆí¬ë¥¼ ì‰¬ê²Œ í•˜ë¦¬ë¼ (ë§ˆíƒœë³µìŒ 11:28)","ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼ ë‚´ê°€ ë„ˆì™€ í•¨ê»˜ í•¨ì´ë¼ ë†€ë¼ì§€ ë§ë¼ ë‚˜ëŠ” ë„¤ í•˜ë‚˜ë‹˜ì´ ë¨ì´ë¼ (ì´ì‚¬ì•¼ 41:10)","ì‚¬ëŒì´ ë§ˆìŒìœ¼ë¡œ ìê¸°ì˜ ê¸¸ì„ ê³„íší• ì§€ë¼ë„ ê·¸ì˜ ê±¸ìŒì„ ì¸ë„í•˜ì‹œëŠ” ì´ëŠ” ì—¬í˜¸ì™€ì‹œë‹ˆë¼ (ì ì–¸ 16:9)","ê·¸ëŸ°ì¦‰ ë„ˆí¬ëŠ” ë¨¼ì € ê·¸ì˜ ë‚˜ë¼ì™€ ê·¸ì˜ ì˜ë¥¼ êµ¬í•˜ë¼ ê·¸ë¦¬í•˜ë©´ ì´ ëª¨ë“  ê²ƒì„ ë„ˆí¬ì—ê²Œ ë”í•˜ì‹œë¦¬ë¼ (ë§ˆíƒœë³µìŒ 6:33)","ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼ (ë¹Œë¦½ë³´ì„œ 4:13)","ë‚´ê°€ ë„ˆí¬ì—ê²Œ ë¶„ë¶€í•œ ëª¨ë“  ê²ƒì„ ê°€ë¥´ì³ ì§€í‚¤ê²Œ í•˜ë¼ ë³¼ì§€ì–´ë‹¤ ë‚´ê°€ ì„¸ìƒ ëë‚ ê¹Œì§€ ë„ˆí¬ì™€ í•­ìƒ í•¨ê»˜ ìˆìœ¼ë¦¬ë¼ (ë§ˆíƒœë³µìŒ 28:20)","ì‚¬ë‘ì€ ì˜¤ë˜ ì°¸ê³  ì‚¬ë‘ì€ ì˜¨ìœ í•˜ë©° ì‹œê¸°í•˜ì§€ ì•„ë‹ˆí•˜ë©° (ê³ ë¦°ë„ì „ì„œ 13:4)","í•˜ë‚˜ë‹˜ì´ ì„¸ìƒì„ ì´ì²˜ëŸ¼ ì‚¬ë‘í•˜ì‚¬ ë…ìƒìë¥¼ ì£¼ì…¨ìœ¼ë‹ˆ ì´ëŠ” ê·¸ë¥¼ ë¯¿ëŠ” ìë§ˆë‹¤ ë©¸ë§í•˜ì§€ ì•Šê³  ì˜ìƒì„ ì–»ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë¼ (ìš”í•œë³µìŒ 3:16)","ê·¸ëŸ°ì¦‰ ë„ˆí¬ê°€ ë¨¹ë“ ì§€ ë§ˆì‹œë“ ì§€ ë¬´ì—‡ì„ í•˜ë“ ì§€ ë‹¤ í•˜ë‚˜ë‹˜ì˜ ì˜ê´‘ì„ ìœ„í•˜ì—¬ í•˜ë¼ (ê³ ë¦°ë„ì „ì„œ 10:31)" ]; 
    document.getElementById('wisdom-verse').textContent = verses[Math.floor(Math.random() * verses.length)]; 
}

function renderBibleBooks() { 
    const oldDiv = document.getElementById('old-testament'); 
    const newDiv = document.getElementById('new-testament'); 
    oldDiv.innerHTML = ''; 
    newDiv.innerHTML = ''; 
    
    const createEl = (book) => { 
        const el = document.createElement('button'); 
        el.className = 'p-2 text-sm rounded-md shadow-sm transition-all duration-200 accent-bg hover:shadow-lg hover:-translate-y-1'; 
        el.textContent = book.name; 
        el.onclick = () => openChapterModal(book); 
        return el; 
    }; 
    
    BIBLE_BOOKS.old.forEach(book => oldDiv.appendChild(createEl(book))); 
    BIBLE_BOOKS.new.forEach(book => newDiv.appendChild(createEl(book))); 
}

function populateUserDropdowns() { 
    const meditationUser = document.getElementById('meditation-user'); 
    const prayerUser = document.getElementById('prayer-user'); 
    const modalUser = document.getElementById('modal-user-selector'); 
    
    meditationUser.innerHTML = ''; 
    prayerUser.innerHTML = ''; 
    modalUser.innerHTML = ''; 
    
    db.family.forEach(member => { 
        const option = `<option value="${member.id}">${member.name}</option>`; 
        meditationUser.innerHTML += option; 
        prayerUser.innerHTML += option; 
        modalUser.innerHTML += option; 
    }); 
}

// === í–¥ìƒëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===
function setupEventListeners() { 
    document.getElementById('theme-select').addEventListener('change', (e) => { 
        document.body.className = e.target.value; 
    }); 
    
    document.getElementById('add-meditation').addEventListener('click', addMeditation); 
    document.getElementById('meditation-input').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') addMeditation(); 
    }); 
    document.getElementById('meditation-user').addEventListener('change', renderMeditations); 
    
    document.getElementById('add-prayer').addEventListener('click', addPrayer); 
    document.getElementById('prayer-input').addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') addPrayer(); 
    }); 
    document.getElementById('prayer-user').addEventListener('change', renderPrayers); 
    
    document.getElementById('sync-btn').addEventListener('click', () => { 
        initializeApp(); 
    }); 
    
    // ê´€ë¦¬ì ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    document.getElementById('admin-btn').addEventListener('click', openAdminModal);
    document.getElementById('close-admin-modal').addEventListener('click', closeAdminModal);
    document.getElementById('verify-password-btn').addEventListener('click', handlePasswordVerification);
    document.getElementById('admin-password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handlePasswordVerification();
    });
    document.getElementById('backup-btn').addEventListener('click', handleBackup);
    document.getElementById('cleanup-btn').addEventListener('click', handleCleanup);
    document.getElementById('analyze-btn').addEventListener('click', handleAnalyze);
    document.getElementById('diagnostic-btn').addEventListener('click', handleDiagnostic);
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeChapterModal();
            closeProgressModal();
            closeAdminModal();
        }
    }); 
    
    document.getElementById('close-modal').onclick = closeChapterModal; 
    document.getElementById('modal-user-selector').addEventListener('change', (e) => { 
        currentUserForModal = e.target.value; 
        updateModalForCurrentUser(); 
    }); 
    
    document.getElementById('close-progress-modal').onclick = closeProgressModal; 
    document.getElementById('tab-ot').onclick = () => switchProgressTab('ot'); 
    document.getElementById('tab-nt').onclick = () => switchProgressTab('nt'); 
}

// === ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ìˆ˜ì • ì—†ìŒ) ===
function renderMeditations() { 
    const list = document.getElementById('meditation-list'); 
    list.innerHTML = ''; 
    
    const currentUserId = document.getElementById('meditation-user').value; 
    
    (db.meditations || []).forEach(item => { 
        const user = db.family.find(u => u.id === item.userId); 
        const itemEl = document.createElement('div'); 
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm slide-in'; 
        
        let buttons = (item.userId === currentUserId) ? `<div class="inline-block ml-2"><button onclick="editMeditation('${item.id}')" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</button> <button onclick="deleteMeditation('${item.id}')" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button></div>` : ''; 
        itemEl.innerHTML = `<div><strong class="accent-text">${user ? user.name : '?'}:</strong> ${item.content}</div><div class="text-right text-gray-500 text-xs">${new Date(parseInt(item.id)).toLocaleDateString()} ${buttons}</div>`; 
        list.appendChild(itemEl); 
    }); 
    
    list.scrollTop = list.scrollHeight; 
}

function renderPrayers() { 
    const list = document.getElementById('prayer-list'); 
    list.innerHTML = ''; 
    
    const currentUserId = document.getElementById('prayer-user').value; 
    
    (db.prayers || []).forEach(item => { 
        const user = db.family.find(u => u.id === item.userId); 
        const itemEl = document.createElement('div'); 
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm slide-in'; 
        
        let buttons = (item.userId === currentUserId) ? `<div class="inline-block ml-2"><button onclick="editPrayer('${item.id}')" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</button> <button onclick="deletePrayer('${item.id}')" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button></div>` : ''; 
        itemEl.innerHTML = `<div><strong class="accent-text">${user ? user.name : '?'}:</strong> ${item.content}</div><div class="text-right text-gray-500 text-xs">${new Date(parseInt(item.id)).toLocaleDateString()} ${buttons}</div>`; 
        list.appendChild(itemEl); 
    }); 
    
    list.scrollTop = list.scrollHeight; 
}

async function addMeditation() { 
    const userInput = document.getElementById('meditation-user'); 
    const textInput = document.getElementById('meditation-input'); 
    
    if (textInput.value.trim() === '') return; 
    
    try { 
        const result = await gapi.saveData({ 
            type: 'meditation', 
            userId: userInput.value, 
            content: textInput.value.trim() 
        }); 
        
        db.meditations.push(result.data); 
        textInput.value = ''; 
        renderMeditations(); 
    } catch (error) { 
        alert('ë¬µìƒ ì €ì¥ ì‹¤íŒ¨: ' + error.message); 
    } 
}

async function deleteMeditation(id) { 
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; 
    
    try { 
        await gapi.deleteData({ type: 'meditation', id: id }); 
        db.meditations = db.meditations.filter(item => item.id !== id); 
        renderMeditations(); 
    } catch (error) { 
        alert('ë¬µìƒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message); 
    } 
}

async function editMeditation(id) { 
    const item = db.meditations.find(item => item.id === id); 
    const newContent = prompt('ë¬µìƒ ë‚´ìš© ìˆ˜ì •:', item.content); 
    
    if (newContent === null || newContent.trim() === '' || newContent.trim() === item.content) return; 
    
    try { 
        await gapi.editData({ type: 'meditation', id: id, content: newContent.trim() }); 
        item.content = newContent.trim(); 
        renderMeditations(); 
    } catch (error) { 
        alert('ë¬µìƒ ìˆ˜ì • ì‹¤íŒ¨: ' + error.message); 
    } 
}

async function addPrayer() { 
    const userInput = document.getElementById('prayer-user'); 
    const textInput = document.getElementById('prayer-input'); 
    
    if (textInput.value.trim() === '') return; 
    
    try { 
        const result = await gapi.saveData({ 
            type: 'prayer', 
            userId: userInput.value, 
            content: textInput.value.trim() 
        }); 
        
        db.prayers.push(result.data); 
        textInput.value = ''; 
        renderPrayers(); 
    } catch (error) { 
        alert('ê¸°ë„ì œëª© ì €ì¥ ì‹¤íŒ¨: ' + error.message); 
    } 
}

async function deletePrayer(id) { 
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; 
    
    try { 
        await gapi.deleteData({ type: 'prayer', id: id }); 
        db.prayers = db.prayers.filter(item => item.id !== id); 
        renderPrayers(); 
    } catch (error) { 
        alert('ê¸°ë„ì œëª© ì‚­ì œ ì‹¤íŒ¨: ' + error.message); 
    } 
}

async function editPrayer(id) { 
    const item = db.prayers.find(item => item.id === id); 
    const newContent = prompt('ê¸°ë„ì œëª© ìˆ˜ì •:', item.content); 
    
    if (newContent === null || newContent.trim() === '' || newContent.trim() === item.content) return; 
    
    try { 
        await gapi.editData({ type: 'prayer', id: id, content: newContent.trim() }); 
        item.content = newContent.trim(); 
        renderPrayers(); 
    } catch (error) { 
        alert('ê¸°ë„ì œëª© ìˆ˜ì • ì‹¤íŒ¨: ' + error.message); 
    } 
}

function openProgressModal(userId) { 
    currentProgressUserId = userId; 
    const user = db.family.find(u => u.id === userId); 
    if (!user) return; 
    
    document.getElementById('progress-modal-photo').src = user.photo || 'https://placehold.co/80x80/cccccc/FFFFFF?text=?'; 
    document.getElementById('progress-modal-title').textContent = `${user.name}ë‹˜ì˜ ì§„í–‰ í˜„í™©`; 
    
    const contentOT = document.getElementById('content-ot'); 
    const contentNT = document.getElementById('content-nt'); 
    contentOT.innerHTML = ''; 
    contentNT.innerHTML = ''; 
    
    const createBookHTML = (book) => { 
        return `<details class="group border-b border-gray-200 rounded-md overflow-hidden mb-1" data-book-name="${book.name}"><summary class="flex justify-between items-center p-2 cursor-pointer hover:bg-gray-50/50"></summary><div class="chapter-grid p-2 grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 bg-gray-50 border-t"></div></details>`; 
    }; 
    
    BIBLE_BOOKS.old.forEach(book => contentOT.innerHTML += createBookHTML(book)); 
    BIBLE_BOOKS.new.forEach(book => contentNT.innerHTML += createBookHTML(book)); 
    
    document.querySelectorAll('#progress-modal details').forEach(detail => { 
        updateProgressInModal(detail, userId); 
        detail.querySelector('summary').addEventListener('click', populateChaptersForBook); 
    }); 
    
    switchProgressTab('ot'); 
    document.getElementById('progress-modal').classList.remove('hidden'); 
}

function populateChaptersForBook(event) { 
    const detail = event.currentTarget.parentElement; 
    const grid = detail.querySelector('.chapter-grid'); 
    
    if (grid.childElementCount > 0) { 
        grid.innerHTML = ''; 
        return; 
    } 
    
    const bookName = detail.dataset.bookName; 
    const book = [...BIBLE_BOOKS.old, ...BIBLE_BOOKS.new].find(b => b.name === bookName); 
    const userRecordsForBook = (db.readRecords[currentProgressUserId]?.[bookName]) || []; 
    
    for (let i = 1; i <= book.chapters; i++) { 
        const btn = document.createElement('button'); 
        btn.textContent = i; 
        btn.className = `p-2 rounded border transition-colors duration-200 chapter-btn-animate ${userRecordsForBook.includes(i) ? 'bg-green-500 text-white border-green-500' : 'bg-white hover:bg-green-100'}`; 
        btn.onclick = (e) => { 
            e.stopPropagation(); 
            toggleChapterRead(i, btn, { bookName: book.name, userId: currentProgressUserId }); 
        }; 
        grid.appendChild(btn); 
    } 
}

function updateProgressInModal(detailElement, userId) { 
    const summary = detailElement.querySelector('summary'); 
    const bookName = detailElement.dataset.bookName; 
    const book = [...BIBLE_BOOKS.old, ...BIBLE_BOOKS.new].find(b => b.name === bookName); 
    const readChapters = (db.readRecords[userId]?.[bookName]) || []; 
    const progress = book.chapters > 0 ? (readChapters.length / book.chapters) * 100 : 0; 
    const isReading = readChapters.length > 0; 
    
    detailElement.classList.toggle('highlight-bg', isReading); 
    
    summary.innerHTML = `<div class="flex-grow font-bold">${book.name}</div><div class="text-sm text-gray-600 mr-4">${readChapters.length}/${book.chapters} ì¥</div><div class="w-24 bg-gray-200 rounded-full h-2.5"><div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress.toFixed(2)}%"></div></div><div class="w-4 ml-2 transform group-open:rotate-180 transition-transform">â–¼</div>`; 
}

function closeProgressModal() { 
    document.getElementById('progress-modal').classList.add('hidden'); 
}

function switchProgressTab(tab) { 
    const tabOT = document.getElementById('tab-ot'); 
    const tabNT = document.getElementById('tab-nt'); 
    const contentOT = document.getElementById('content-ot'); 
    const contentNT = document.getElementById('content-nt'); 
    
    if (tab === 'ot') { 
        tabOT.classList.add('tab-active'); 
        tabOT.classList.remove('border-transparent', 'text-gray-500'); 
        tabNT.classList.remove('tab-active'); 
        tabNT.classList.add('border-transparent', 'text-gray-500'); 
        contentOT.classList.remove('hidden'); 
        contentNT.classList.add('hidden'); 
    } else { 
        tabNT.classList.add('tab-active'); 
        tabNT.classList.remove('border-transparent', 'text-gray-500'); 
        tabOT.classList.remove('tab-active'); 
        tabOT.classList.add('border-transparent', 'text-gray-500'); 
        contentNT.classList.remove('hidden'); 
        contentOT.classList.add('hidden'); 
    } 
}

// === í–¥ìƒëœ ì¥ ì½ê¸° í† ê¸€ (ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€) ===
function toggleChapterRead(chapterNumber, buttonElement, context) { 
    const userId = context.userId; 
    const bookName = context.bookName; 
    
    if (!db.readRecords[userId]) db.readRecords[userId] = {}; 
    if (!db.readRecords[userId][bookName]) db.readRecords[userId][bookName] = []; 
    
    const readList = db.readRecords[userId][bookName]; 
    const chapterIndex = readList.indexOf(chapterNumber); 
    const params = { type: 'reading', userId, bookName, chapter: chapterNumber }; 
    
    // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ ì¶”ê°€
    if (chapterIndex > -1) { 
        readList.splice(chapterIndex, 1); 
        buttonElement.className = 'p-2 rounded border transition-colors duration-200 chapter-btn-animate bg-white hover:bg-green-100'; 
    } else { 
        readList.push(chapterNumber); 
        buttonElement.className = 'p-2 rounded border transition-colors duration-200 chapter-btn-animate bg-green-500 text-white border-green-500 checked'; 
        
        // ì²´í¬ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        setTimeout(() => {
            buttonElement.classList.remove('checked');
        }, 600);
    } 
    
    renderAll(); 
    
    const detail = document.querySelector(`#progress-modal details[data-book-name="${bookName}"]`); 
    if(detail) updateProgressInModal(detail, userId); 
    
    // í–¥ìƒëœ API í˜¸ì¶œ (í ì‹œìŠ¤í…œ ì‚¬ìš©)
    const apiCall = (chapterIndex > -1) ? gapi.deleteData(params) : gapi.saveData(params); 
    apiCall.catch(error => { 
        console.error('ì½ê¸° ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error);
        // ì˜¤ë¥˜ ì‹œ ë¡¤ë°±í•˜ì§€ ì•ŠìŒ (ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‘ë™í•˜ë„ë¡)
    }); 
}

function openChapterModal(book) { 
    if (!db.family || db.family.length === 0) return; 
    
    currentBook = book; 
    document.getElementById('modal-title').textContent = book.name; 
    document.getElementById('modal-user-selector').value = currentUserForModal; 
    updateModalForCurrentUser(); 
    document.getElementById('chapter-modal').classList.remove('hidden'); 
}

function updateModalForCurrentUser() { 
    const modalChapters = document.getElementById('modal-chapters'); 
    modalChapters.innerHTML = ''; 
    
    const userRecordsForBook = (db.readRecords[currentUserForModal]?.[currentBook.name]) || []; 
    
    for (let i = 1; i <= currentBook.chapters; i++) { 
        const btn = document.createElement('button'); 
        btn.textContent = i; 
        btn.className = `p-2 rounded border transition-colors duration-200 chapter-btn-animate ${userRecordsForBook.includes(i) ? 'bg-green-500 text-white border-green-500' : 'bg-white hover:bg-green-100'}`; 
        btn.onclick = () => toggleChapterRead(i, btn, {bookName: currentBook.name, userId: currentUserForModal}); 
        modalChapters.appendChild(btn); 
    } 
}

function closeChapterModal() { 
    document.getElementById('chapter-modal').classList.add('hidden'); 
}

// === ë©”ì¸ íƒ­ ì „í™˜ ê¸°ëŠ¥ ===
function switchMainTab(tabName) {
    // ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ í™œì„± ìƒíƒœ ì œê±°
    document.querySelectorAll('.main-tab').forEach(tab => {
        tab.classList.remove('tab-active');
    });
    
    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // ì„ íƒëœ íƒ­ í™œì„±í™”
    document.getElementById(`tab-${tabName}`).classList.add('tab-active');
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    
    // í†µê³„ íƒ­ì´ ì„ íƒë˜ì—ˆì„ ë•Œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    if (tabName === 'stats' && statisticsManager.progressChart) {
        setTimeout(() => {
            statisticsManager.updateCharts();
        }, 100);
    }
}

// === ê°œì¸ë³„ ìƒì„¸ ì§„í–‰ í˜„í™© ë Œë”ë§ ===
function renderDetailedProgress() {
    const container = document.getElementById('detailed-progress');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!db.family || db.family.length === 0) return;
    
    db.family.forEach(member => {
        const userRecords = db.readRecords[member.id] || {};
        const otRead = BIBLE_BOOKS.old.reduce((sum, book) => sum + (userRecords[book.name]?.length || 0), 0);
        const ntRead = BIBLE_BOOKS.new.reduce((sum, book) => sum + (userRecords[book.name]?.length || 0), 0);
        const totalRead = otRead + ntRead;
        const totalChapters = TOTAL_OT_CHAPTERS + TOTAL_NT_CHAPTERS;
        const percentage = totalChapters > 0 ? ((totalRead / totalChapters) * 100).toFixed(1) : 0;
        
        // ìµœê·¼ ì½ì€ ì±… ì°¾ê¸°
        let recentBook = 'ì—†ìŒ';
        let maxChapters = 0;
        Object.entries(userRecords).forEach(([bookName, chapters]) => {
            if (chapters.length > maxChapters) {
                maxChapters = chapters.length;
                recentBook = bookName;
            }
        });
        
        const memberCard = document.createElement('div');
        memberCard.className = 'accent-bg rounded-lg p-4 cursor-pointer hover:opacity-80 transition';
        memberCard.onclick = () => openProgressModal(member.id);
        
        memberCard.innerHTML = `
            <div class="flex items-center mb-4">
                <img src="${member.photo || 'https://placehold.co/60x60/cccccc/FFFFFF?text=?'}" 
                     alt="${member.name}" 
                     class="w-12 h-12 rounded-full mr-3 object-cover border-2 border-white/50" 
                     referrerpolicy="no-referrer">
                <div>
                    <h4 class="font-bold text-lg">${member.title} (${member.name})</h4>
                    <p class="text-sm text-gray-600">ì „ì²´ ì§„í–‰ë¥  ${percentage}%</p>
                </div>
            </div>
            
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span>ì „ì²´ ì§„ë„</span>
                        <span>${totalRead} / ${totalChapters}ì¥</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="progress-bar-fill h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-white/50 p-2 rounded text-center">
                        <div class="font-semibold">êµ¬ì•½</div>
                        <div class="accent-text">${otRead}/${TOTAL_OT_CHAPTERS}</div>
                    </div>
                    <div class="bg-white/50 p-2 rounded text-center">
                        <div class="font-semibold">ì‹ ì•½</div>
                        <div class="accent-text">${ntRead}/${TOTAL_NT_CHAPTERS}</div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 text-center">
                    ìµœê·¼ ì½ëŠ” ì±…: <span class="font-semibold accent-text">${recentBook}</span>
                </div>
            </div>
        `;
        
        container.appendChild(memberCard);
    });
}

// === ì½ê¸° íŒ¨í„´ ë¶„ì„ ë Œë”ë§ ===
function renderReadingPatterns() {
    if (!db.family || db.family.length === 0) return;
    
    // ì´ë²ˆ ì£¼ ì½ê¸° ìˆ˜ ê³„ì‚° (ì„ì‹œë¡œ ëœë¤ ê°’, ì‹¤ì œë¡œëŠ” ë‚ ì§œë³„ ê¸°ë¡ í•„ìš”)
    const thisWeekTotal = Math.floor(Math.random() * 50) + 10;
    document.getElementById('this-week-count').textContent = `${thisWeekTotal}ì¥`;
    
    // ì—°ì† ì½ê¸° ì¼ìˆ˜ (ì„ì‹œë¡œ ëœë¤ ê°’)
    const streakDays = Math.floor(Math.random() * 30) + 1;
    document.getElementById('streak-count').textContent = `${streakDays}ì¼`;
    
    // ì¦ê²¨ ì½ëŠ” ì±… ì°¾ê¸°
    let favoriteBook = 'ì‹œí¸';
    let maxTotalChapters = 0;
    
    // ëª¨ë“  ê°€ì¡± êµ¬ì„±ì›ì˜ ì½ê¸° ê¸°ë¡ì„ í•©ì‚°
    const bookTotals = {};
    db.family.forEach(member => {
        const userRecords = db.readRecords[member.id] || {};
        Object.entries(userRecords).forEach(([bookName, chapters]) => {
            if (!bookTotals[bookName]) bookTotals[bookName] = 0;
            bookTotals[bookName] += chapters.length;
        });
    });
    
    // ê°€ì¥ ë§ì´ ì½íŒ ì±… ì°¾ê¸°
    Object.entries(bookTotals).forEach(([bookName, total]) => {
        if (total > maxTotalChapters) {
            maxTotalChapters = total;
            favoriteBook = bookName;
        }
    });
    
    document.getElementById('favorite-book').textContent = favoriteBook;
    
    // ì™„ë…í•œ ì±… ìˆ˜ ê³„ì‚°
    let completedBooks = 0;
    [...BIBLE_BOOKS.old, ...BIBLE_BOOKS.new].forEach(book => {
        db.family.forEach(member => {
            const userRecords = db.readRecords[member.id] || {};
            const readChapters = userRecords[book.name] || [];
            if (readChapters.length === book.chapters) {
                completedBooks++;
            }
        });
    });
    
    document.getElementById('completed-books').textContent = `${completedBooks}ê¶Œ`;
}

// === ê´€ë¦¬ì ê¸°ëŠ¥ë“¤ ===
let isAdminAuthenticated = false;
let currentAdminPassword = '';

function openAdminModal() {
    document.getElementById('admin-modal').classList.remove('hidden');
    
    // ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
    isAdminAuthenticated = false;
    currentAdminPassword = '';
    document.getElementById('admin-password').value = '';
    document.getElementById('password-section').style.display = 'block';
    document.getElementById('admin-functions').classList.add('hidden');
    document.getElementById('auth-status').classList.add('hidden');
    
    updateConnectionInfo();
}

function closeAdminModal() {
    document.getElementById('admin-modal').classList.add('hidden');
    isAdminAuthenticated = false;
    currentAdminPassword = '';
}

function updateConnectionInfo() {
    document.getElementById('api-status').textContent = gapi.isConnected ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸';
    document.getElementById('last-sync').textContent = gapi.lastSyncTime ? 
        new Date(gapi.lastSyncTime).toLocaleString('ko-KR') : 'ì—†ìŒ';
    document.getElementById('pending-info').textContent = `${gapi.pendingChanges.length}ê°œ`;
    
    // ë³´ì•ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê°„ì†Œí™”)
    const securityStatus = document.getElementById('security-status');
    const apiKeyStatus = document.getElementById('api-key-status');
    
    if (securityStatus) {
        if (gapi.enableSecurity) {
            securityStatus.textContent = 'í™œì„±í™”ë¨';
            securityStatus.className = 'font-semibold text-green-600';
            apiKeyStatus.textContent = gapi.apiKey.substring(0, 16) + '...';
            apiKeyStatus.className = 'font-mono text-xs text-green-600';
        } else {
            securityStatus.textContent = 'ë¹„í™œì„±í™”ë¨ (ê°€ì¡±ìš©)';
            securityStatus.className = 'font-semibold text-blue-600';
            apiKeyStatus.textContent = 'ì‚¬ìš© ì•ˆí•¨';
            apiKeyStatus.className = 'font-mono text-xs text-gray-500';
        }
    }
}

async function handlePasswordVerification() {
    const passwordInput = document.getElementById('admin-password');
    const verifyBtn = document.getElementById('verify-password-btn');
    const authStatus = document.getElementById('auth-status');
    
    const password = passwordInput.value.trim();
    if (!password) {
        showAuthStatus('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
    }
    
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'ì¸ì¦ ì¤‘...';
    authStatus.classList.remove('hidden');
    authStatus.textContent = 'ì¸ì¦ ì¤‘...';
    authStatus.className = 'mt-2 text-sm text-blue-600';
    
    try {
        const response = await gapi.verifyAdminPassword(password);
        
        if (response.isValid) {
            isAdminAuthenticated = true;
            currentAdminPassword = password;
            
            showAuthStatus('âœ… ì¸ì¦ ì„±ê³µ! ê´€ë¦¬ì ê¶Œí•œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // ë¹„ë°€ë²ˆí˜¸ ì„¹ì…˜ ìˆ¨ê¸°ê³  ê´€ë¦¬ ê¸°ëŠ¥ í‘œì‹œ
            setTimeout(() => {
                document.getElementById('password-section').style.display = 'none';
                document.getElementById('admin-functions').classList.remove('hidden');
            }, 1000);
            
        } else {
            showAuthStatus('âŒ ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
            passwordInput.value = '';
            passwordInput.focus();
        }
        
    } catch (error) {
        showAuthStatus(`âŒ ì¸ì¦ ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'ì¸ì¦';
    }
}

function showAuthStatus(message, type) {
    const authStatus = document.getElementById('auth-status');
    authStatus.classList.remove('hidden');
    authStatus.textContent = message;
    
    switch (type) {
        case 'success':
            authStatus.className = 'mt-2 text-sm text-green-600 bg-green-50 p-2 rounded';
            break;
        case 'error':
            authStatus.className = 'mt-2 text-sm text-red-600 bg-red-50 p-2 rounded';
            break;
        default:
            authStatus.className = 'mt-2 text-sm text-blue-600';
    }
}

async function handleBackup() {
    if (!isAdminAuthenticated) {
        alert('ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('í˜„ì¬ ëª¨ë“  ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìƒˆë¡œìš´ ë°±ì—… ì‹œíŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.')) {
        return;
    }
    
    const btn = document.getElementById('backup-btn');
    const result = document.getElementById('backup-result');
    
    btn.disabled = true;
    btn.textContent = 'ë°±ì—… ì¤‘...';
    result.classList.remove('hidden');
    result.textContent = 'ë°±ì—… ìƒì„± ì¤‘...';
    result.className = 'mt-2 p-2 bg-blue-100 rounded text-sm';
    
    try {
        const response = await gapi.createBackup(currentAdminPassword);
        
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-green-600">âœ…</span>
                <span>${response.message}</span>
            </div>
            <div class="text-xs text-gray-600 mt-1">
                êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ìƒˆë¡œ ìƒì„±ëœ ë°±ì—… ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.
            </div>
        `;
        result.className = 'mt-2 p-2 bg-green-100 rounded text-sm';
        
    } catch (error) {
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-red-600">âŒ</span>
                <span>ë°±ì—… ì‹¤íŒ¨: ${error.message}</span>
            </div>
        `;
        result.className = 'mt-2 p-2 bg-red-100 rounded text-sm';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ë°±ì—… ìƒì„±';
    }
}

async function handleCleanup() {
    if (!isAdminAuthenticated) {
        alert('ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('âš ï¸ ì¤‘ë³µëœ ì½ê¸° ê¸°ë¡ì„ ì •ë¦¬í•©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në°±ì—…ì„ ë¨¼ì € ìƒì„±í•˜ì…¨ë‚˜ìš”?\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    const btn = document.getElementById('cleanup-btn');
    const result = document.getElementById('cleanup-result');
    
    btn.disabled = true;
    btn.textContent = 'ì •ë¦¬ ì¤‘...';
    result.classList.remove('hidden');
    result.textContent = 'ì¤‘ë³µ ê¸°ë¡ ì •ë¦¬ ì¤‘...';
    result.className = 'mt-2 p-2 bg-yellow-100 rounded text-sm';
    
    try {
        const response = await gapi.cleanupDuplicates(currentAdminPassword);
        
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-green-600">âœ…</span>
                <span>${response.message}</span>
            </div>
            <div class="text-xs text-gray-600 mt-1">
                í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>
        `;
        result.className = 'mt-2 p-2 bg-green-100 rounded text-sm';
        
        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        setTimeout(() => {
            initializeApp();
        }, 2000);
        
    } catch (error) {
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-red-600">âŒ</span>
                <span>ì •ë¦¬ ì‹¤íŒ¨: ${error.message}</span>
            </div>
        `;
        result.className = 'mt-2 p-2 bg-red-100 rounded text-sm';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì¤‘ë³µ ê¸°ë¡ ì •ë¦¬';
    }
}

async function handleAnalyze() {
    const btn = document.getElementById('analyze-btn');
    const result = document.getElementById('cleanup-result');
    
    btn.disabled = true;
    btn.textContent = 'ë¶„ì„ ì¤‘...';
    result.classList.remove('hidden');
    result.textContent = 'ì¤‘ë³µ ë°ì´í„° ë¶„ì„ ì¤‘...';
    result.className = 'mt-2 p-2 bg-blue-100 rounded text-sm';
    
    try {
        const response = await gapi.runDiagnostics();
        const analysis = response.debugInfo.duplicateAnalysis;
        
        if (typeof analysis === 'string') {
            result.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-blue-600">ğŸ“Š</span>
                    <span>${analysis}</span>
                </div>
            `;
        } else {
            const duplicates = analysis.duplicates || [];
            result.innerHTML = `
                <div><strong>ğŸ“Š ì¤‘ë³µ ë¶„ì„ ê²°ê³¼:</strong></div>
                <div class="mt-1 space-y-1">
                    <div>â€¢ ì „ì²´ í–‰: ${analysis.totalRows}ê°œ</div>
                    <div>â€¢ ì¤‘ë³µ í–‰: <span class="font-bold ${analysis.duplicateCount > 0 ? 'text-red-600' : 'text-green-600'}">${analysis.duplicateCount}ê°œ</span></div>
                </div>
                ${duplicates.length > 0 ? `
                    <div class="mt-2 border-t pt-2">
                        <div class="font-semibold text-red-600">ì¤‘ë³µ í•­ëª©ë“¤:</div>
                        <div class="mt-1 space-y-1 max-h-20 overflow-y-auto">
                            ${duplicates.map(dup => `
                                <div class="text-xs bg-red-50 p-1 rounded">
                                    ${dup.userId} - ${dup.bookName} (í–‰ ${dup.rowNumber})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        result.className = 'mt-2 p-2 bg-blue-100 rounded text-sm';
        
    } catch (error) {
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-red-600">âŒ</span>
                <span>ë¶„ì„ ì˜¤ë¥˜: ${error.message}</span>
            </div>
        `;
        result.className = 'mt-2 p-2 bg-red-100 rounded text-sm';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì¤‘ë³µ ë¶„ì„';
    }
}

async function handleDiagnostic() {
    const btn = document.getElementById('diagnostic-btn');
    const result = document.getElementById('diagnostic-result');
    
    btn.disabled = true;
    btn.textContent = 'ì§„ë‹¨ ì¤‘...';
    result.classList.remove('hidden');
    result.textContent = 'ì‹œìŠ¤í…œ ì§„ë‹¨ ì¤‘...';
    result.className = 'text-sm bg-blue-100 rounded p-2';
    
    try {
        const response = await gapi.runDiagnostics();
        const info = response.debugInfo;
        
        result.innerHTML = `
            <div><strong>ğŸ“‹ ì‹œìŠ¤í…œ ì§„ë‹¨ ê²°ê³¼:</strong></div>
            <div class="mt-2 space-y-2 text-xs">
                <div class="bg-white p-2 rounded">
                    <div><strong>ìŠ¤í”„ë ˆë“œì‹œíŠ¸:</strong> ${info.spreadsheetName}</div>
                    <div><strong>ì‹œíŠ¸ íƒ­ë“¤:</strong> ${info.foundSheetTabs.join(', ')}</div>
                </div>
                <div class="bg-white p-2 rounded">
                    <div><strong>ê°€ì¡± ì‹œíŠ¸ ìƒ˜í”Œ:</strong></div>
                    <pre class="text-xs bg-gray-50 p-1 rounded mt-1 overflow-auto max-h-16">${JSON.stringify(info.familySheetFirst5Rows, null, 2)}</pre>
                </div>
                <div class="bg-white p-2 rounded">
                    <div><strong>ì¤‘ë³µ ë¶„ì„:</strong></div>
                    <pre class="text-xs bg-gray-50 p-1 rounded mt-1 overflow-auto max-h-16">${JSON.stringify(info.duplicateAnalysis, null, 2)}</pre>
                </div>
            </div>
        `;
        result.className = 'text-sm bg-gray-100 rounded p-2 overflow-auto max-h-40';
        
    } catch (error) {
        result.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-red-600">âŒ</span>
                <span>ì§„ë‹¨ ì˜¤ë¥˜: ${error.message}</span>
            </div>
        `;
        result.className = 'text-sm bg-red-100 rounded p-2';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì§„ë‹¨ ì‹¤í–‰';
    }
}
</script>
</body>
</html>
