<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Time for Family</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .font-myeongjo {
            font-family: 'Nanum Myeongjo', serif;
        }
        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5a992;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a88d76;
        }
        /* í…Œë§ˆ ì „í™˜ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .theme-creation {
            --bg-main: #f0f4f8; /* í•˜ëŠ˜ */
            --bg-container: #ffffff;
            --bg-accent: #e6f0e6; /* ì´ˆë¡ */
            --text-primary: #2c3e50;
            --text-accent: #1e8449;
            --border-color: #d4e6d4;
        }
        .theme-jerusalem {
            --bg-main: #fdfaf6; /* ëª¨ë˜ */
            --bg-container: #ffffff;
            --bg-accent: #f8f1e9; /* ì˜…ì€ í™ */
            --text-primary: #5a4b42;
            --text-accent: #8d6e63;
            --border-color: #d7ccc8;
        }
        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.5s, color 0.5s;
        }
        .main-container {
            background-color: var(--bg-container);
            transition: background-color 0.5s;
        }
        .accent-bg {
            background-color: var(--bg-accent);
            transition: background-color 0.5s;
        }
        .accent-text {
            color: var(--text-accent);
            transition: color 0.5s;
        }
        .border-custom {
            border-color: var(--border-color);
            transition: border-color 0.5s;
        }
        .progress-bar-fill {
            background-color: var(--text-accent);
            transition: background-color 0.5s;
        }

        /* ë±ƒì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes badgeGlow {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }
        
        @keyframes badgePop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .badge-earned {
            animation: badgeGlow 2s infinite, badgePop 0.6s ease-out;
        }
        
        .badge-locked {
            filter: grayscale(100%) opacity(0.3);
        }

        /* ì¶•í•˜ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes celebrate {
            0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(0deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .celebration-modal {
            animation: celebrate 0.8s ease-out;
        }

        /* íŒŒí‹°í´ íš¨ê³¼ */
        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 1000;
            animation: confetti 3s linear infinite;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            animation: spin 1s linear infinite;
        }

        /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .status-loading { color: #f59e0b; }
    </style>
</head>
<body class="theme-jerusalem">

    <div id="app" class="p-4 md:p-8 max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-myeongjo font-bold accent-text">Bible Time for Family</h1>
            <p class="mt-2 text-lg">ìš°ë¦¬ê°€ì¡±, ë§ì”€ìœ¼ë¡œ í•˜ë‚˜ë˜ëŠ” ì‹œê°„</p>
            
            <div id="connection-status" class="mt-2 flex items-center justify-center gap-2">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-sm">ì—°ê²° í™•ì¸ ì¤‘...</span>
                <button id="sync-btn" class="ml-2 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 hidden">
                    ğŸ”„ ë™ê¸°í™”
                </button>
            </div>
            
            <div class="mt-4 flex justify-center items-center gap-4 flex-wrap">
                <div>
                    <label for="theme-select" class="mr-2">í…Œë§ˆ ì„ íƒ:</label>
                    <select id="theme-select" class="p-1 rounded border-custom border-2 accent-bg">
                        <option value="theme-jerusalem">ì˜ˆë£¨ì‚´ë ˜ (í™ê³¼ ëŒ)</option>
                        <option value="theme-creation">ì²œì§€ì°½ì¡° (í•˜ëŠ˜ê³¼ í’€)</option>
                    </select>
                </div>
                <button id="badges-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-all">
                    ğŸ† ë±ƒì§€ ì»¬ë ‰ì…˜
                </button>
                <button id="settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-all">
                    âš™ï¸ ì„¤ì •
                </button>
            </div>
        </header>

        <div class="main-container shadow-xl rounded-2xl p-4 md:p-6">
            
            <section id="family-dashboard" class="mb-8 accent-bg rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center">
                </section>

            <section class="mb-8 text-center p-6 border-2 border-dashed border-custom rounded-lg">
                <h2 class="text-xl font-bold font-myeongjo accent-text mb-2">ì˜¤ëŠ˜ì˜ ì§€í˜œ ë§ì”€</h2>
                <p id="wisdom-verse" class="text-lg"></p>
            </section>

            <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-center">ğŸ“– ì„±ê²½ ì½ê¸°í‘œ (66ê¶Œ)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-center accent-text">êµ¬ì•½ (39ê¶Œ)</h3>
                        <div id="old-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-3 text-center accent-text">ì‹ ì•½ (27ê¶Œ)</h3>
                        <div id="new-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                    </div>
                </div>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">ğŸ’¬ ê°€ì¡± ë¬µìƒ ë‚˜ëˆ”</h3>
                    <div id="meditation-list" class="h-48 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2">
                        </div>
                    <div class="flex gap-2">
                        <select id="meditation-user" class="p-2 border-custom border rounded-md"></select>
                        <input type="text" id="meditation-input" class="flex-grow p-2 border-custom border rounded-md" placeholder="ì˜¤ëŠ˜ì˜ ë¬µìƒì„ ë‚˜ëˆ ë³´ì„¸ìš”...">
                        <button id="add-meditation" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                    </div>
                </div>
                <div class="accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">ğŸ™ ê°€ì¡± ê¸°ë„ ë…¸íŠ¸</h3>
                    <div id="prayer-list" class="h-48 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2">
                        </div>
                    <div class="flex gap-2">
                        <select id="prayer-user" class="p-2 border-custom border rounded-md"></select>
                        <input type="text" id="prayer-input" class="flex-grow p-2 border-custom border rounded-md" placeholder="í•¨ê»˜ ê¸°ë„í•  ì œëª©ì„ ë‚˜ëˆ ìš”...">
                        <button id="add-prayer" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="close-modal" class="text-3xl">&times;</button>
            </div>
            <p class="mb-2">ì½ê¸°ë¥¼ ì™„ë£Œí•œ ì¥ì„ ì²´í¬í•´ì£¼ì„¸ìš”. (ì²´í¬í•œ ì‚¬ëŒì€ <span id="modal-user-name" class="font-bold"></span>)</p>
            <div id="modal-chapters" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 p-2 accent-bg rounded custom-scrollbar">
                </div>
        </div>
    </div>

    <div id="badges-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ğŸ† ìš°ë¦¬ ê°€ì¡± ë±ƒì§€ ì»¬ë ‰ì…˜</h2>
                <button id="close-badges-modal" class="text-3xl">&times;</button>
            </div>
            
            <div id="badge-tabs" class="flex mb-4 border-b">
                </div>
            
            <div id="badges-content" class="flex-grow overflow-y-auto custom-scrollbar">
                </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">âš™ï¸ êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì •</h2>
                <button id="close-settings-modal" class="text-3xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Google Apps Script URL</label>
                    <input type="text" id="script-url" class="w-full p-2 border rounded-md" 
                           placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    <p class="text-xs text-gray-500 mt-1">Apps Script ë°°í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
                
                <div class="flex gap-2">
                    <button id="test-connection" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <button id="save-settings" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        ì €ì¥
                    </button>
                </div>
                
                <div class="text-sm">
                    <h4 class="font-bold mb-2">ì„¤ì • ë°©ë²•:</h4>
                    <ol class="list-decimal list-inside space-y-1 text-xs">
                        <li>êµ¬ê¸€ ì‹œíŠ¸ ìƒì„± (6ê°œ íƒ­: family_members, reading_records, badges, meditations, prayers, settings)</li>
                        <li>Google Apps Script ìƒì„± ë° ì½”ë“œ ë°°í¬ (ì ‘ê·¼ ê¶Œí•œ: **ëˆ„êµ¬ë‚˜**)</li>
                        <li>ë°°í¬ URLì„ ìœ„ì— ì…ë ¥ í›„ ì €ì¥</li>
                        <li>**family_members ì‹œíŠ¸ì— ê°€ì¡± ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.**</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div id="celebration-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="celebration-modal bg-white rounded-lg shadow-2xl p-8 text-center max-w-md">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-2xl font-bold mb-2" id="celebration-title">ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
            <p class="text-lg mb-4" id="celebration-message">ìƒˆë¡œìš´ ë±ƒì§€ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!</p>
            <div class="text-4xl mb-4" id="celebration-badge"></div>
            <button id="close-celebration" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">í™•ì¸</button>
        </div>
    </div>

<script>
// --- êµ¬ê¸€ ì‹œíŠ¸ API í´ë˜ìŠ¤ (ìˆ˜ì •ë¨) ---
class GoogleSheetsAPI {
    constructor() {
        this.scriptUrl = localStorage.getItem('bible_script_url') || '';
        this.isConnected = false;
    }

    _getUrl() {
        if (!this.scriptUrl) {
            throw new Error('Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        return this.scriptUrl;
    }

    async testConnection() {
        const url = this._getUrl();
        try {
            const response = await fetch(`${url}?action=test`);
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            const result = await response.json();
            if (result.success) {
                this.isConnected = true;
                return true;
            } else {
                throw new Error(result.error || 'Connection test failed');
            }
        } catch (error) {
            this.isConnected = false;
            console.error('Test Connection Error:', error);
            throw error;
        }
    }

    async loadData(sheet) {
        if (!this.isConnected) {
            return this.loadFromLocalStorage(sheet);
        }

        try {
            const url = `${this._getUrl()}?action=load&sheet=${sheet}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            const result = await response.json();

            if (result.success) {
                this.saveToLocalStorage(sheet, result.data); // Cache successful load
                return result.data;
            } else {
                console.warn(`API Error loading '${sheet}', using local data:`, result.error);
                return this.loadFromLocalStorage(sheet);
            }
        } catch (error) {
            console.warn(`Network Error loading '${sheet}', using local data:`, error);
            return this.loadFromLocalStorage(sheet);
        }
    }

    async saveData(params) {
        if (!this.isConnected) {
            throw new Error('ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œëŠ” ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        const url = new URL(this._getUrl());
        url.searchParams.set('action', 'save');
        for (const key in params) {
            url.searchParams.set(key, params[key]);
        }

        try {
            const response = await fetch(url.toString());
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error('Save Data Error:', error);
            throw error;
        }
    }
    
    // Specific save functions using the generic saveData
    async saveReading(userId, bookName, chapter) {
        return this.saveData({ type: 'reading', userId, bookName, chapter });
    }

    async saveMeditation(userId, content) {
        return this.saveData({ type: 'meditation', userId, content });
    }

    async savePrayer(userId, content) {
        return this.saveData({ type: 'prayer', userId, content });
    }

    // Local storage functions remain the same
    saveToLocalStorage(sheet, data) {
        const key = `bible_${sheet}`;
        localStorage.setItem(key, JSON.stringify(data));
    }

    loadFromLocalStorage(sheet) {
        const key = `bible_${sheet}`;
        const data = localStorage.getItem(key);
        // Return default empty structures if nothing in local storage
        if (!data) {
            if (sheet === 'family_members' || sheet === 'meditations' || sheet === 'prayers') return [];
            if (sheet === 'reading_records' || sheet === 'badges') return {};
            return null;
        }
        return JSON.parse(data);
    }
}


// --- ë°ì´í„°ë² ì´ìŠ¤ ë° ì„¤ì • ---
const BIBLE_BOOKS = {
    old: [
        { name: 'ì°½ì„¸ê¸°', chapters: 50 }, { name: 'ì¶œì• êµ½ê¸°', chapters: 40 }, { name: 'ë ˆìœ„ê¸°', chapters: 27 },
        { name: 'ë¯¼ìˆ˜ê¸°', chapters: 36 }, { name: 'ì‹ ëª…ê¸°', chapters: 34 }, { name: 'ì—¬í˜¸ìˆ˜ì•„', chapters: 24 },
        { name: 'ì‚¬ì‚¬ê¸°', chapters: 21 }, { name: 'ë£»ê¸°', chapters: 4 }, { name: 'ì‚¬ë¬´ì—˜ìƒ', chapters: 31 },
        { name: 'ì‚¬ë¬´ì—˜í•˜', chapters: 24 }, { name: 'ì—´ì™•ê¸°ìƒ', chapters: 22 }, { name: 'ì—´ì™•ê¸°í•˜', chapters: 25 },
        { name: 'ì—­ëŒ€ìƒ', chapters: 29 }, { name: 'ì—­ëŒ€í•˜', chapters: 36 }, { name: 'ì—ìŠ¤ë¼', chapters: 10 },
        { name: 'ëŠí—¤ë¯¸ì•¼', chapters: 13 }, { name: 'ì—ìŠ¤ë”', chapters: 10 }, { name: 'ìš¥ê¸°', chapters: 42 },
        { name: 'ì‹œí¸', chapters: 150 }, { name: 'ì ì–¸', chapters: 31 }, { name: 'ì „ë„ì„œ', chapters: 12 },
        { name: 'ì•„ê°€', chapters: 8 }, { name: 'ì´ì‚¬ì•¼', chapters: 66 }, { name: 'ì˜ˆë ˆë¯¸ì•¼', chapters: 52 },
        { name: 'ì˜ˆë ˆë¯¸ì•¼ì• ê°€', chapters: 5 }, { name: 'ì—ìŠ¤ê²”', chapters: 48 }, { name: 'ë‹¤ë‹ˆì—˜', chapters: 12 },
        { name: 'í˜¸ì„¸ì•„', chapters: 14 }, { name: 'ìš”ì—˜', chapters: 3 }, { name: 'ì•„ëª¨ìŠ¤', chapters: 9 },
        { name: 'ì˜¤ë°”ëŒœ', chapters: 1 }, { name: 'ìš”ë‚˜', chapters: 4 }, { name: 'ë¯¸ê°€', chapters: 7 },
        { name: 'ë‚˜í›”', chapters: 3 }, { name: 'í•˜ë°•êµ­', chapters: 3 }, { name: 'ìŠ¤ë°”ëƒ', chapters: 3 },
        { name: 'í•™ê°œ', chapters: 2 }, { name: 'ìŠ¤ê°€ë´', chapters: 14 }, { name: 'ë§ë¼ê¸°', chapters: 4 }
    ],
    new: [
        { name: 'ë§ˆíƒœë³µìŒ', chapters: 28 }, { name: 'ë§ˆê°€ë³µìŒ', chapters: 16 }, { name: 'ëˆ„ê°€ë³µìŒ', chapters: 24 },
        { name: 'ìš”í•œë³µìŒ', chapters: 21 }, { name: 'ì‚¬ë„í–‰ì „', chapters: 28 }, { name: 'ë¡œë§ˆì„œ', chapters: 16 },
        { name: 'ê³ ë¦°ë„ì „ì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„í›„ì„œ', chapters: 13 }, { name: 'ê°ˆë¼ë””ì•„ì„œ', chapters: 6 },
        { name: 'ì—ë² ì†Œì„œ', chapters: 6 }, { name: 'ë¹Œë¦½ë³´ì„œ', chapters: 4 }, { name: 'ê³¨ë¡œìƒˆì„œ', chapters: 4 },
        { name: 'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ', chapters: 5 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ', chapters: 3 }, { name: 'ë””ëª¨ë°ì „ì„œ', chapters: 6 },
        { name: 'ë””ëª¨ë°í›„ì„œ', chapters: 4 }, { name: 'ë””ë„ì„œ', chapters: 3 }, { name: 'ë¹Œë ˆëª¬ì„œ', chapters: 1 },
        { name: 'íˆë¸Œë¦¬ì„œ', chapters: 13 }, { name: 'ì•¼ê³ ë³´ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œì „ì„œ', chapters: 5 },
        { name: 'ë² ë“œë¡œí›„ì„œ', chapters: 3 }, { name: 'ìš”í•œ1ì„œ', chapters: 5 }, { name: 'ìš”í•œ2ì„œ', chapters: 1 },
        { name: 'ìš”í•œ3ì„œ', chapters: 1 }, { name: 'ìœ ë‹¤ì„œ', chapters: 1 }, { name: 'ìš”í•œê³„ì‹œë¡', chapters: 22 }
    ]
};
const TOTAL_CHAPTERS = BIBLE_BOOKS.old.reduce((s, b) => s + b.chapters, 0) + BIBLE_BOOKS.new.reduce((s, b) => s + b.chapters, 0);

const BADGE_DEFINITIONS = {
    'streak_3': { emoji: 'ğŸ”¥', name: 'ë¶ˆíƒ€ëŠ” ì—´ì •', description: '3ì¼ ì—°ì† ì½ê¸°', condition: 'streak', value: 3 },
    'streak_7': { emoji: 'âš¡', name: 'ê¾¸ì¤€í•œ ë¯¿ìŒ', description: '7ì¼ ì—°ì† ì½ê¸°', condition: 'streak', value: 7 },
    'streak_30': { emoji: 'ğŸ‘‘', name: 'ì™•ê´€ì˜ ì˜ê´‘', description: '30ì¼ ì—°ì† ì½ê¸°', condition: 'streak', value: 30 },
    'chapters_100': { emoji: 'ğŸ“š', name: 'ë§ì”€ ì‚¬ë‘', description: 'ì´ 100ì¥ ì½ê¸°', condition: 'chapters', value: 100 },
    'chapters_500': { emoji: 'ğŸ“', name: 'ë§ì”€ ì„ì‚¬', description: 'ì´ 500ì¥ ì½ê¸°', condition: 'chapters', value: 500 },
    'book_genesis': { emoji: 'ğŸŒŸ', name: 'ì°½ì¡°ì˜ ì‹œì‘', description: 'ì°½ì„¸ê¸° ì™„ë…', condition: 'book', value: 'ì°½ì„¸ê¸°' },
    'book_psalms': { emoji: 'ğŸµ', name: 'ì°¬ì–‘ì˜ ë§ˆìŒ', description: 'ì‹œí¸ ì™„ë…', condition: 'book', value: 'ì‹œí¸' },
    'book_john': { emoji: 'â¤ï¸', name: 'ì‚¬ë‘ì˜ ë³µìŒ', description: 'ìš”í•œë³µìŒ ì™„ë…', condition: 'book', value: 'ìš”í•œë³µìŒ' },
    'first_read': { emoji: 'ğŸŒ…', name: 'ì²« ê±¸ìŒ', description: 'ì²« ì„±ê²½ ì½ê¸°', condition: 'first', value: 1 },
};

let gapi = null;
let db = {
    family: [],
    readRecords: {},
    readingHistory: {},
    badges: {},
    meditations: [],
    prayers: [],
    wisdomVerses: [
        "íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼ (ì°½ 1:1)",
        "í•­ìƒ ê¸°ë»í•˜ë¼ ì‰¬ì§€ ë§ê³  ê¸°ë„í•˜ë¼ ë²”ì‚¬ì— ê°ì‚¬í•˜ë¼ (ì‚´ì „ 5:16-18)",
        "ë„¤ ë§ˆìŒì„ ë‹¤í•˜ê³  ëª©ìˆ¨ì„ ë‹¤í•˜ê³  ëœ»ì„ ë‹¤í•˜ì—¬ ì£¼ ë„ˆì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•˜ë¼ (ë§ˆ 22:37)",
        "ë‚´ê°€ ë„ˆí¬ì—ê²Œ ë¶„ë¶€í•œ ëª¨ë“  ê²ƒì„ ê°€ë¥´ì³ ì§€í‚¤ê²Œ í•˜ë¼ (ë§ˆ 28:20)",
        "ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼ ë‚´ê°€ ë„ˆì™€ í•¨ê»˜ í•¨ì´ë¼ (ì‚¬ 41:10)"
    ]
};

// --- ì•± ì´ˆê¸°í™” ë° ë Œë”ë§ ---
document.addEventListener('DOMContentLoaded', async () => {
    gapi = new GoogleSheetsAPI();
    
    setupEventListeners();
    renderWisdomVerse();
    renderBibleBooks();

    await initializeApp();
});

async function initializeApp() {
    await initializeGoogleSheets();
    await loadAllDataAndRender();
}

async function initializeGoogleSheets() {
    updateConnectionStatus('loading');
    if (!gapi.scriptUrl) {
        updateConnectionStatus('disconnected');
        console.log('êµ¬ê¸€ ì‹œíŠ¸ URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì • ëª¨ë‹¬ì„ ì—´ì–´ì£¼ì„¸ìš”.');
        openSettingsModal(); // URL ì—†ìœ¼ë©´ ì„¤ì •ì°½ ë°”ë¡œ ì—´ê¸°
        return;
    }

    try {
        await gapi.testConnection();
        updateConnectionStatus('connected');
        console.log('êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ì„±ê³µ');
    } catch (error) {
        updateConnectionStatus('disconnected');
        console.log('êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨, ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì§„í–‰:', error.message);
    }
}

function updateConnectionStatus(status) {
    const indicator = document.getElementById('status-indicator');
    const text = document.getElementById('status-text');
    const syncBtn = document.getElementById('sync-btn');
    
    indicator.classList.remove('loading');

    switch (status) {
        case 'connected':
            indicator.className = 'w-3 h-3 rounded-full bg-green-500';
            text.textContent = 'ì˜¨ë¼ì¸';
            text.className = 'text-sm status-connected';
            syncBtn.classList.remove('hidden');
            break;
        case 'disconnected':
            indicator.className = 'w-3 h-3 rounded-full bg-red-500';
            text.textContent = 'ì˜¤í”„ë¼ì¸';
            text.className = 'text-sm status-disconnected';
            syncBtn.classList.add('hidden');
            break;
        case 'loading':
            indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 loading';
            text.textContent = 'ì—°ê²° ì¤‘...';
            text.className = 'text-sm status-loading';
            syncBtn.classList.add('hidden');
            break;
    }
}

async function loadAllDataAndRender() {
    try {
        const [family, reading, badges, meditations, prayers] = await Promise.all([
            gapi.loadData('family_members'),
            gapi.loadData('reading_records'),
            gapi.loadData('badges'),
            gapi.loadData('meditations'),
            gapi.loadData('prayers')
        ]);

        db.family = family || [];
        db.readRecords = reading || {};
        db.badges = badges || {};
        db.meditations = meditations || [];
        db.prayers = prayers || [];
        
        // ë°ì´í„° ë¡œë“œ í›„ í•„ìš”í•œ ë Œë”ë§ ë° ì´ˆê¸°í™” ìˆ˜í–‰
        if (db.family.length > 0) {
            initializeDataStructures();
            populateUserDropdowns();
            renderAll();
        } else if (gapi.isConnected) {
            console.warn("ê°€ì¡± ì •ë³´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ 'family_members' íƒ­ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
            alert("ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ 'family_members' ì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
        }

    } catch (error) {
        console.error('ì „ì²´ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ ì‹¤íŒ¨:', error);
        // ì˜¤í”„ë¼ì¸ ë°ì´í„°ë¡œ ë Œë”ë§ ì‹œë„
        renderAll();
    }
}

function initializeDataStructures() {
    db.family.forEach(member => {
        if (!db.badges[member.id]) db.badges[member.id] = [];
        if (!db.readRecords[member.id]) db.readRecords[member.id] = {};
        
        // readingHistoryëŠ” readRecords ê¸°ë°˜ìœ¼ë¡œ ì¬êµ¬ì„±
        if(!db.readingHistory[member.id]) db.readingHistory[member.id] = [];
        // ì´ ë¶€ë¶„ì€ ë” ì •êµí•œ ê¸°ë¡ì´ í•„ìš”í•˜ë‹¤ë©´ í™•ì¥í•´ì•¼ í•¨ (í˜„ì¬ëŠ” ë‚ ì§œ ê¸°ë¡ì´ ì—†ìŒ)
    });
}

function renderAll() {
    renderFamilyDashboard();
    renderMeditations();
    renderPrayers();
    renderBadgeTabs();
    if(document.getElementById('badges-modal').classList.contains('flex')) {
        const activeTab = document.querySelector('.badge-tab.border-blue-600');
        renderBadges(activeTab ? activeTab.dataset.user : 'all');
    }
}


function renderWisdomVerse() {
    const verseEl = document.getElementById('wisdom-verse');
    const randomIndex = Math.floor(Math.random() * db.wisdomVerses.length);
    verseEl.textContent = db.wisdomVerses[randomIndex];
}

function renderFamilyDashboard() {
    const dashboard = document.getElementById('family-dashboard');
    dashboard.innerHTML = '';
    if (!db.family || db.family.length === 0) {
        dashboard.innerHTML = `<p class="col-span-full text-center">ê°€ì¡± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜, ì‹œíŠ¸ì— ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
        return;
    }
    db.family.forEach(member => {
        const userRecords = db.readRecords[member.id] || {};
        const chaptersRead = Object.values(userRecords).reduce((sum, bookData) => {
             // bookDataê°€ ë°°ì—´ì¸ì§€ í™•ì¸ (ì´ì „ ë°ì´í„° êµ¬ì¡° í˜¸í™˜)
            return sum + (Array.isArray(bookData) ? bookData.length : (bookData.chapters ? bookData.chapters.length : 0));
        }, 0);

        const progress = TOTAL_CHAPTERS > 0 ? (chaptersRead / TOTAL_CHAPTERS) * 100 : 0;
        const userBadges = db.badges[member.id] || [];

        const memberDiv = document.createElement('div');
        memberDiv.className = 'flex flex-col items-center relative';
        memberDiv.innerHTML = `
            <img src="${member.photo || 'https://placehold.co/80x80/cccccc/FFFFFF?text=?'}" alt="${member.name} í”„ë¡œí•„ ì‚¬ì§„" class="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-white/50 object-cover shadow-md">
            <div class="font-bold mt-2">${member.title} (${member.name})</div>
            <div class="w-full bg-white/30 rounded-full h-2.5 mt-1">
                <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress.toFixed(2)}%"></div>
            </div>
            <div class="text-xs mt-1">${chaptersRead} / ${TOTAL_CHAPTERS} ì¥</div>
            <div class="flex gap-1 mt-1 flex-wrap justify-center">
                ${userBadges.slice(-3).map(badgeId => {
                    const badge = BADGE_DEFINITIONS[badgeId];
                    return badge ? `<span title="${badge.name}" class="text-lg">${badge.emoji}</span>` : '';
                }).join('')}
                ${userBadges.length > 3 ? `<span class="text-xs text-gray-500">+${userBadges.length - 3}</span>` : ''}
            </div>
        `;
        dashboard.appendChild(memberDiv);
    });
}

function renderBibleBooks() {
    const oldTestamentDiv = document.getElementById('old-testament');
    const newTestamentDiv = document.getElementById('new-testament');
    oldTestamentDiv.innerHTML = '';
    newTestamentDiv.innerHTML = '';

    BIBLE_BOOKS.old.forEach(book => oldTestamentDiv.appendChild(createBookElement(book)));
    BIBLE_BOOKS.new.forEach(book => newTestamentDiv.appendChild(createBookElement(book)));
}

function createBookElement(book) {
    const bookEl = document.createElement('button');
    bookEl.className = 'p-2 text-sm rounded-md shadow-sm transition-all duration-200 accent-bg hover:shadow-lg hover:-translate-y-1';
    bookEl.textContent = book.name;
    bookEl.dataset.bookName = book.name;
    bookEl.addEventListener('click', () => openChapterModal(book));
    return bookEl;
}

function populateUserDropdowns() {
    const meditationUser = document.getElementById('meditation-user');
    const prayerUser = document.getElementById('prayer-user');
    meditationUser.innerHTML = '';
    prayerUser.innerHTML = '';
    db.family.forEach(member => {
        const option = `<option value="${member.id}">${member.name}</option>`;
        meditationUser.innerHTML += option;
        prayerUser.innerHTML += option;
    });
}

function renderMeditations() {
    const list = document.getElementById('meditation-list');
    list.innerHTML = '';
    db.meditations.forEach(item => {
        const user = db.family.find(u => u.id === item.userId);
        const itemEl = document.createElement('div');
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm';
        itemEl.innerHTML = `<strong class="accent-text">${user ? user.name : 'ì•Œìˆ˜ì—†ìŒ'}:</strong> ${item.content}`;
        list.appendChild(itemEl);
    });
    list.scrollTop = list.scrollHeight;
}

function renderPrayers() {
    const list = document.getElementById('prayer-list');
    list.innerHTML = '';
    db.prayers.forEach(item => {
        const user = db.family.find(u => u.id === item.userId);
        const itemEl = document.createElement('div');
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm';
        itemEl.innerHTML = `<strong class="accent-text">${user ? user.name : 'ì•Œìˆ˜ì—†ìŒ'}:</strong> ${item.content}`;
        list.appendChild(itemEl);
    });
    list.scrollTop = list.scrollHeight;
}


// --- ë±ƒì§€ ì‹œìŠ¤í…œ ---
function checkAndAwardBadges(userId) {
    const userBadges = db.badges[userId] || [];
    const newBadges = [];

    const userRecords = db.readRecords[userId] || {};
    const totalChapters = Object.values(userRecords).reduce((sum, bookData) => sum + bookData.length, 0);

    // ì²« ì½ê¸° ë±ƒì§€
    if (!userBadges.includes('first_read') && totalChapters >= 1) {
        newBadges.push('first_read');
    }

    // ì¥ ìˆ˜ ë±ƒì§€
    Object.entries(BADGE_DEFINITIONS).forEach(([badgeId, badge]) => {
        if (badge.condition === 'chapters' && !userBadges.includes(badgeId) && totalChapters >= badge.value) {
            newBadges.push(badgeId);
        }
    });

    // ì„±ê²½ ì™„ë… ë±ƒì§€
    Object.entries(BADGE_DEFINITIONS).forEach(([badgeId, badge]) => {
        if (badge.condition === 'book' && !userBadges.includes(badgeId)) {
            const bookInfo = [...BIBLE_BOOKS.old, ...BIBLE_BOOKS.new].find(b => b.name === badge.value);
            if (bookInfo && userRecords[badge.value] && userRecords[badge.value].length === bookInfo.chapters) {
                newBadges.push(badgeId);
            }
        }
    });

    // TODO: ì—°ì† ì½ê¸° ë±ƒì§€ (readingHistoryì— ë‚ ì§œ ê¸°ë¡ì´ í•„ìš”)

    // ìƒˆ ë±ƒì§€ ì¶”ê°€ ë° ì¶•í•˜
    if (newBadges.length > 0) {
        newBadges.forEach(badgeId => {
            db.badges[userId].push(badgeId);
            showCelebration(userId, badgeId);
            createConfetti();
            // ë±ƒì§€ íšë“ ì •ë³´ ì‹œíŠ¸ì—ë„ ì €ì¥ (ê°œë³„ ì €ì¥)
            gapi.saveData({ type: 'badge', userId, badgeId }).catch(console.error);
        });
        renderAll(); // ë±ƒì§€ íšë“ í›„ í™”ë©´ ì¦‰ì‹œ ê°±ì‹ 
    }
}


function showCelebration(userId, badgeId) {
    const user = db.family.find(u => u.id === userId);
    const badge = BADGE_DEFINITIONS[badgeId];
    if (!user || !badge) return;

    document.getElementById('celebration-title').textContent = `ì¶•í•˜í•©ë‹ˆë‹¤, ${user.name}ë‹˜!`;
    document.getElementById('celebration-message').textContent = `"${badge.name}" ë±ƒì§€ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`;
    document.getElementById('celebration-badge').textContent = badge.emoji;

    const modal = document.getElementById('celebration-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function createConfetti() {
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
    }
}

// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
function setupEventListeners() {
    document.getElementById('theme-select').addEventListener('change', (e) => {
        document.body.className = e.target.value;
    });

    document.getElementById('add-meditation').addEventListener('click', addMeditation);
    document.getElementById('meditation-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addMeditation();
    });

    document.getElementById('add-prayer').addEventListener('click', addPrayer);
    document.getElementById('prayer-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addPrayer();
    });

    document.getElementById('badges-btn').addEventListener('click', openBadgesModal);
    document.getElementById('close-badges-modal').addEventListener('click', closeBadgesModal);
    document.getElementById('close-celebration').addEventListener('click', () => {
        document.getElementById('celebration-modal').classList.add('hidden');
        document.getElementById('celebration-modal').classList.remove('flex');
    });

    document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
    document.getElementById('close-settings-modal').addEventListener('click', closeSettingsModal);
    document.getElementById('test-connection').addEventListener('click', testAndSaveConnection);
    document.getElementById('save-settings').addEventListener('click', saveSettings);
    document.getElementById('sync-btn').addEventListener('click', () => {
        console.log('ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...');
        loadAllDataAndRender();
        alert('ë™ê¸°í™” ì™„ë£Œ!');
    });
}

// --- ëª¨ë‹¬ ë° UI ì œì–´ ---
function openSettingsModal() {
    document.getElementById('script-url').value = gapi.scriptUrl;
    document.getElementById('settings-modal').classList.add('flex');
    document.getElementById('settings-modal').classList.remove('hidden');
}

function closeSettingsModal() {
    document.getElementById('settings-modal').classList.add('hidden');
    document.getElementById('settings-modal').classList.remove('flex');
}

async function testAndSaveConnection() {
    const url = document.getElementById('script-url').value;
    if (!url) {
        alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    gapi.scriptUrl = url;
    updateConnectionStatus('loading');

    try {
        await gapi.testConnection();
        updateConnectionStatus('connected');
        alert('ì—°ê²° ì„±ê³µ!');
        saveSettings(); // ì„±ê³µí•˜ë©´ ë°”ë¡œ ì €ì¥
    } catch (error) {
        updateConnectionStatus('disconnected');
        alert('ì—°ê²° ì‹¤íŒ¨: ' + error.message);
    }
}

function saveSettings() {
    const url = document.getElementById('script-url').value;
    localStorage.setItem('bible_script_url', url);
    gapi.scriptUrl = url;
    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    closeSettingsModal();
    // ì„¤ì • ì €ì¥ í›„ ì•± ë‹¤ì‹œ ì´ˆê¸°í™”
    initializeApp();
}

function renderBadgeTabs() {
    const tabsContainer = document.getElementById('badge-tabs');
    tabsContainer.innerHTML = `<button class="badge-tab px-4 py-2 font-bold text-blue-600 border-b-2 border-blue-600" data-user="all">ì „ì²´</button>`;
    db.family.forEach(member => {
        tabsContainer.innerHTML += `<button class="badge-tab px-4 py-2 hover:text-blue-600" data-user="${member.id}">${member.name}</button>`;
    });

    document.querySelectorAll('.badge-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.badge-tab').forEach(t => t.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600'));
            e.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            renderBadges(e.target.dataset.user);
        });
    });
}

function openBadgesModal() {
    document.getElementById('badges-modal').classList.add('flex');
    document.getElementById('badges-modal').classList.remove('hidden');
    renderBadges('all');
}

function closeBadgesModal() {
    document.getElementById('badges-modal').classList.add('hidden');
    document.getElementById('badges-modal').classList.remove('flex');
}

function renderBadges(userId = 'all') {
    const content = document.getElementById('badges-content');
    content.innerHTML = '';
    const categories = {
        'ì²«ê±¸ìŒ ë° ì¥ ì½ê¸°': ['first_read', 'chapters_100', 'chapters_500'],
        'ì„±ê²½ ì™„ë…': ['book_genesis', 'book_psalms', 'book_john'],
        'ì—°ì† ì½ê¸° (ì¤€ë¹„ì¤‘)': ['streak_3', 'streak_7', 'streak_30']
    };

    if (userId === 'all') {
        Object.entries(categories).forEach(([categoryName, badgeIds]) => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'mb-6';
            categoryDiv.innerHTML = `<h3 class="text-lg font-bold mb-3">${categoryName}</h3>`;
            const badgesGrid = document.createElement('div');
            badgesGrid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';
            badgeIds.forEach(badgeId => {
                const badge = BADGE_DEFINITIONS[badgeId];
                if (!badge) return;
                const earnedBy = db.family.filter(m => db.badges[m.id] && db.badges[m.id].includes(badgeId)).map(m => m.name);
                const badgeEl = document.createElement('div');
                badgeEl.className = `p-4 border rounded-lg text-center ${earnedBy.length > 0 ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-300 badge-locked'}`;
                badgeEl.innerHTML = `
                    <div class="text-3xl mb-2">${badge.emoji}</div>
                    <div class="font-bold">${badge.name}</div>
                    <div class="text-sm text-gray-600">${badge.description}</div>
                    <div class="text-xs mt-2 ${earnedBy.length > 0 ? 'text-green-600' : 'text-gray-400'}">
                        ${earnedBy.length > 0 ? `íšë“: ${earnedBy.join(', ')}` : 'ë¯¸íšë“'}
                    </div>`;
                badgesGrid.appendChild(badgeEl);
            });
            categoryDiv.appendChild(badgesGrid);
            content.appendChild(categoryDiv);
        });
    } else {
        const user = db.family.find(u => u.id === userId);
        const userBadges = db.badges[userId] || [];
        content.innerHTML = `<h3 class="text-lg font-bold mb-4">${user.name}ë‹˜ì˜ ë±ƒì§€ (${userBadges.length}ê°œ)</h3>`;
        const badgesGrid = document.createElement('div');
        badgesGrid.className = 'grid grid-cols-2 md:grid-cols-4 gap-4';
        Object.entries(BADGE_DEFINITIONS).forEach(([badgeId, badge]) => {
            const hasEarned = userBadges.includes(badgeId);
            const badgeEl = document.createElement('div');
            badgeEl.className = `p-4 border rounded-lg text-center ${hasEarned ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-300 badge-locked'}`;
            badgeEl.innerHTML = `
                <div class="text-3xl mb-2">${badge.emoji}</div>
                <div class="font-bold">${badge.name}</div>
                <div class="text-sm text-gray-600">${badge.description}</div>
                <div class="text-xs mt-2 ${hasEarned ? 'text-green-600 font-bold' : 'text-gray-400'}">
                    ${hasEarned ? 'íšë“ ì™„ë£Œ' : 'ë¯¸íšë“'}
                </div>`;
            badgesGrid.appendChild(badgeEl);
        });
        content.appendChild(badgesGrid);
    }
}

async function addMeditation() {
    const userInput = document.getElementById('meditation-user');
    const textInput = document.getElementById('meditation-input');
    if (textInput.value.trim() === '') return;

    const newMeditation = {
        userId: userInput.value,
        date: new Date().toISOString().slice(0, 10),
        content: textInput.value.trim()
    };

    try {
        await gapi.saveMeditation(newMeditation.userId, newMeditation.content);
        db.meditations.push(newMeditation);
        textInput.value = '';
        renderMeditations();
    } catch (error) {
        alert('ë¬µìƒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }
}

async function addPrayer() {
    const userInput = document.getElementById('prayer-user');
    const textInput = document.getElementById('prayer-input');
    if (textInput.value.trim() === '') return;

    const newPrayer = {
        userId: userInput.value,
        date: new Date().toISOString().slice(0, 10),
        content: textInput.value.trim()
    };

    try {
        await gapi.savePrayer(newPrayer.userId, newPrayer.content);
        db.prayers.push(newPrayer);
        textInput.value = '';
        renderPrayers();
    } catch (error) {
        alert('ê¸°ë„ì œëª© ì €ì¥ ì‹¤íŒ¨: ' + error.message);
    }
}

// --- ì¥ ì½ê¸° ëª¨ë‹¬ ê´€ë ¨ ê¸°ëŠ¥ ---
let currentBook = null;
let currentUserForModal = null;

function openChapterModal(book) {
    if (!db.family || db.family.length === 0) {
        alert("ê°€ì¡± ì •ë³´ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        return;
    }
    currentBook = book;
    currentUserForModal = db.family[0].id; 
    
    document.getElementById('modal-title').textContent = book.name;
    
    const modal = document.getElementById('chapter-modal');
    modal.classList.add('flex');
    modal.classList.remove('hidden');
    
    createModalUserSelector();
    updateModalForCurrentUser();

    document.getElementById('close-modal').onclick = closeChapterModal;
}

function createModalUserSelector() {
    const modalHeader = document.querySelector('#chapter-modal h2').parentElement;
    let selectorContainer = document.getElementById('modal-user-selector-container');
    if (!selectorContainer) {
        selectorContainer = document.createElement('div');
        selectorContainer.id = 'modal-user-selector-container';
        selectorContainer.className = 'flex items-center gap-2 mb-4';
        
        selectorContainer.innerHTML = `
            <label for="modal-user-selector">ì²´í¬í•  ì‚¬ëŒ:</label>
            <select id="modal-user-selector" class="p-1 border rounded"></select>
        `;
        
        modalHeader.insertAdjacentElement('afterend', selectorContainer);

        document.getElementById('modal-user-selector').addEventListener('change', (e) => {
            currentUserForModal = e.target.value;
            updateModalForCurrentUser();
        });
    }

    const select = document.getElementById('modal-user-selector');
    select.innerHTML = '';
    db.family.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;
        option.textContent = member.name;
        select.appendChild(option);
    });
    select.value = currentUserForModal;
}

function updateModalForCurrentUser() {
    const modalChapters = document.getElementById('modal-chapters');
    const user = db.family.find(u => u.id === currentUserForModal);
    
    document.getElementById('modal-user-name').textContent = user.name;
    modalChapters.innerHTML = '';

    const userRecordsForBook = (db.readRecords[currentUserForModal] && db.readRecords[currentUserForModal][currentBook.name]) || [];

    for (let i = 1; i <= currentBook.chapters; i++) {
        const chapterBtn = document.createElement('button');
        chapterBtn.textContent = i;
        chapterBtn.dataset.chapter = i;
        chapterBtn.className = 'p-2 rounded border transition-colors duration-200';
        
        if (userRecordsForBook.includes(i)) {
            chapterBtn.classList.add('bg-green-500', 'text-white', 'border-green-500');
        } else {
            chapterBtn.classList.add('bg-white', 'hover:bg-green-100');
        }

        chapterBtn.onclick = () => toggleChapterRead(i, chapterBtn);
        modalChapters.appendChild(chapterBtn);
    }
}

async function toggleChapterRead(chapterNumber, buttonElement) {
    if (!db.readRecords[currentUserForModal]) db.readRecords[currentUserForModal] = {};
    if (!db.readRecords[currentUserForModal][currentBook.name]) db.readRecords[currentUserForModal][currentBook.name] = [];

    const readList = db.readRecords[currentUserForModal][currentBook.name];
    const chapterIndex = readList.indexOf(chapterNumber);

    if (chapterIndex > -1) {
        // ì´ë¯¸ ì½ì—ˆìœ¼ë©´ ì·¨ì†Œ (ì‚­ì œ ë¡œì§ì€ í˜„ì¬ APIì— ì—†ìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì²˜ë¦¬)
        // readList.splice(chapterIndex, 1);
        // buttonElement.classList.remove('bg-green-500', 'text-white', 'border-green-500');
        // buttonElement.classList.add('bg-white', 'hover:bg-green-100');
        alert("ì½ê¸° ì·¨ì†Œ ê¸°ëŠ¥ì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        
    } else {
        // ì½ìŒ ì²˜ë¦¬
        buttonElement.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        try {
            await gapi.saveReading(currentUserForModal, currentBook.name, chapterNumber);
            readList.push(chapterNumber);
            buttonElement.classList.add('bg-green-500', 'text-white', 'border-green-500');
            buttonElement.classList.remove('bg-white', 'hover:bg-green-100');
            
            checkAndAwardBadges(currentUserForModal);
            renderFamilyDashboard();
        } catch(error) {
            alert("ì½ê¸° ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
        } finally {
            buttonElement.disabled = false;
        }
    }
}

function closeChapterModal() {
    document.getElementById('chapter-modal').classList.add('hidden');
    document.getElementById('chapter-modal').classList.remove('flex');
    currentBook = null;
}

</script>
</body>
</html>
