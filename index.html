<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Bible Time for Family</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/SHO8YuH.png">

    <?!= include('Stylesheet'); ?>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="theme-jerusalem">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center gap-4 shadow-xl">
            <div class="loading-spinner"></div>
            <span id="loading-text" class="text-lg font-semibold">처리 중...</span>
        </div>
    </div>

    <div id="app" class="relative p-2 sm:p-4 md:p-8 max-w-6xl mx-auto">
        <div id="header-top-right" class="absolute top-2 right-2 sm:top-4 sm:right-4 md:top-8 md:right-8 flex flex-col items-end gap-2 z-10">
            <div id="connection-status" class="flex items-center justify-center gap-2">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-xs sm:text-sm">연결 중...</span>
            </div>
            <div class="text-xs sm:text-sm">
                <label for="theme-select" class="mr-2">테마:</label>
                <select id="theme-select" class="p-1 rounded border-2 text-xs sm:text-sm" style="border-color: var(--border-color); background-color: var(--bg-accent);">
                    <option value="theme-jerusalem">예루살렘</option>
                    <option value="theme-creation">천지창조</option>
                    <option value="theme-exodus">출애굽</option>
                    <option value="theme-kingdom">왕국</option>
                </select>
            </div>
             <button id="admin-btn" class="mt-2 px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600" title="관리"⚙️ 관리</button>
        </div>

        <header class="text-center pt-20 md:pt-0 mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-myeongjo font-bold accent-text">Bible Time for Family</h1>
            <p class="mt-2 text-base sm:text-lg">우리가족, 말씀으로 하나되는 시간</p>
        </header>

        <div class="main-container shadow-xl rounded-2xl p-3 sm:p-4 md:p-6">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-1 sm:space-x-2 md:space-x-4 overflow-x-auto tab-nav" aria-label="Main Tabs">
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="main">
                        📖 <span class="hidden sm:inline">말씀과 읽기</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="sharing">
                        💬 <span class="hidden sm:inline">묵상과 기도</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="messages">
                        💌 <span class="hidden sm:inline">메시지 보드</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="allowance">
                        💰 <span class="hidden sm:inline">비전 통장</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="stats">
                        📊 <span class="hidden sm:inline">통계와 현황</span>
                    </button>
                </nav>
            </div>

            <div id="content-main" class="tab-content hidden"></div>
            <div id="content-sharing" class="tab-content hidden"></div>
            <div id="content-messages" class="tab-content hidden"></div>
            <div id="content-allowance" class="tab-content hidden"></div>
            <div id="content-stats" class="tab-content hidden"></div>
        </div>
    </div>

    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="close-chapter-modal" class="text-3xl">&times;</button>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <label for="modal-user-selector">체크할 사람:</label>
                <select id="modal-user-selector" class="p-1 border rounded"></select>
            </div>
            <div id="modal-chapters" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 p-2 accent-bg rounded custom-scrollbar"></div>
        </div>
    </div>
    
    <div id="allowance-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="allowance-modal-title" class="text-2xl font-bold">용돈 인출하기</h2>
                <button id="close-allowance-modal" class="text-3xl">&times;</button>
            </div>
            <div id="allowance-modal-content"></div>
        </div>
    </div>
    
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
        </div>

<script>
// =================================================================
// Bible Time for Family - Client-side JavaScript (Complete)
// =================================================================

// --- 1. 전역 설정 및 변수 ---

const API_CONFIG = {
    scriptUrl: 'https://script.google.com/macros/s/AKfycbxx29G-6qp5r4XjRS_z6NxuFkIuHlfkZna-SP_aEHCmwtRk5f-LspCNzBhs0dAuI9E-eA/exec',
    apiKey: 'bible_family_default'
};

const BIBLE_BOOKS = { 
  old: [ { name: '창세기', chapters: 50 }, { name: '출애굽기', chapters: 40 }, { name: '레위기', chapters: 27 }, { name: '민수기', chapters: 36 }, { name: '신명기', chapters: 34 }, { name: '여호수아', chapters: 24 }, { name: '사사기', chapters: 21 }, { name: '룻기', chapters: 4 }, { name: '사무엘상', chapters: 31 }, { name: '사무엘하', chapters: 24 }, { name: '열왕기상', chapters: 22 }, { name: '열왕기하', chapters: 25 }, { name: '역대상', chapters: 29 }, { name: '역대하', chapters: 36 }, { name: '에스라', chapters: 10 }, { name: '느헤미야', chapters: 13 }, { name: '에스더', chapters: 10 }, { name: '욥기', chapters: 42 }, { name: '시편', chapters: 150 }, { name: '잠언', chapters: 31 }, { name: '전도서', chapters: 12 }, { name: '아가', chapters: 8 }, { name: '이사야', chapters: 66 }, { name: '예레미야', chapters: 52 }, { name: '예레미야애가', chapters: 5 }, { name: '에스겔', chapters: 48 }, { name: '다니엘', chapters: 12 }, { name: '호세아', chapters: 14 }, { name: '요엘', chapters: 3 }, { name: '아모스', chapters: 9 }, { name: '오바댜', chapters: 1 }, { name: '요나', chapters: 4 }, { name: '미가', chapters: 7 }, { name: '나훔', chapters: 3 }, { name: '하박국', chapters: 3 }, { name: '스바냐', chapters: 3 }, { name: '학개', chapters: 2 }, { name: '스가랴', chapters: 14 }, { name: '말라기', chapters: 4 } ], 
  new: [ { name: '마태복음', chapters: 28 }, { name: '마가복음', chapters: 16 }, { name: '누가복음', chapters: 24 }, { name: '요한복음', chapters: 21 }, { name: '사도행전', chapters: 28 }, { name: '로마서', chapters: 16 }, { name: '고린도전서', chapters: 16 }, { name: '고린도후서', chapters: 13 }, { name: '갈라디아서', chapters: 6 }, { name: '에베소서', chapters: 6 }, { name: '빌립보서', chapters: 4 }, { name: '골로새서', chapters: 4 }, { name: '데살로니가전서', chapters: 5 }, { name: '데살로니가후서', chapters: 3 }, { name: '디모데전서', chapters: 6 }, { name: '디모데후서', chapters: 4 }, { name: '디도서', chapters: 3 }, { name: '빌레몬서', chapters: 1 }, { name: '히브리서', chapters: 13 }, { name: '야고보서', chapters: 5 }, { name: '베드로전서', chapters: 5 }, { name: '베드로후서', chapters: 3 }, { name: '요한1서', chapters: 5 }, { name: '요한2서', chapters: 1 }, { name: '요한3서', chapters: 1 }, { name: '유다서', chapters: 1 }, { name: '요한계시록', chapters: 22 } ] 
};

let gapi;
let db = {
    family: [],
    reading_records: {},
    meditations: [],
    prayers: [],
    messages: [],
    comments: [],
    allowance_ledger: []
};
let currentUserForModal = null;
let currentBook = null;
const allowanceTargetIds = ['hayul', 'hajun']; // 용돈 시스템 적용 대상 ID

// --- 2. 애플리케이션 초기화 및 메인 로직 ---

document.addEventListener('DOMContentLoaded', () => {
    gapi = new EnhancedGoogleSheetsAPI();
    initializeApp();
    setupEventListeners();
});

async function initializeApp() {
    showLoadingState(true, '데이터 로딩 중...');
    try {
        await gapi.loadAllData();
        if (db.family.length > 0) {
            currentUserForModal = db.family[0].id;
        }
        renderAllTabs();
        populateUserDropdowns();
        switchMainTab('main'); // 초기 탭 설정
        updateConnectionStatus(true);
    } catch (error) {
        console.error('초기화 실패:', error);
        updateConnectionStatus(false);
        alert('데이터를 불러오는 데 실패했습니다. 오프라인 상태이거나 Apps Script URL을 확인해주세요.');
    } finally {
        showLoadingState(false);
    }
}

// --- 3. API 통신 클래스 (A-안: 서버 우선 동기화) ---

class EnhancedGoogleSheetsAPI {
    constructor() {
        this.scriptUrl = API_CONFIG.scriptUrl;
        this.apiKey = API_CONFIG.apiKey;
    }

    async _request(action, params = {}) {
        updateConnectionStatus(true, true); // isConnecting = true
        const url = new URL(this.scriptUrl);
        url.searchParams.set('action', action);
        url.searchParams.set('apiKey', this.apiKey);
        Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'API 요청 실패');
            updateConnectionStatus(true);
            return result.data;
        } catch (error) {
            updateConnectionStatus(false);
            console.error(`API Error (${action}):`, error);
            throw error;
        }
    }

    async loadAllData() {
        const data = await this._request('loadAll');
        Object.keys(data).forEach(key => {
            db[key] = data[key] || (key === 'reading_records' ? {} : []);
        });
    }

    async performAction(action, params) {
        showLoadingState(true, '서버와 통신 중...');
        try {
            await this._request(action, params);
            await this.loadAllData();
            renderAllTabs();
            populateUserDropdowns();
        } catch (error) {
            alert(`${action} 작업 실패: ${error.message}`);
            // 실패 시에도 최신 데이터로 화면을 다시 그려서 동기화 시도
            await this.loadAllData();
            renderAllTabs();
        } finally {
            showLoadingState(false);
        }
    }
}

// --- 4. 탭별 콘텐츠 렌더링 ---

function renderAllTabs() {
    renderMainTab();
    renderSharingTab();
    renderMessagesTab();
    renderAllowanceTab();
    renderStatsTab();
}

function renderMainTab() {
    const container = document.getElementById('content-main');
    container.innerHTML = `
        <section class="mb-8 text-center p-6 border-2 border-dashed" style="border-color: var(--border-color);">
            <h2 class="text-xl font-bold font-myeongjo accent-text mb-2">오늘의 지혜 말씀</h2>
            <p id="wisdom-verse" class="text-lg"></p>
        </section>
        <section id="leaderboard" class="mb-8"></section>
        <section id="family-dashboard" class="mb-8 accent-bg rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center"></section>
        <section class="space-y-4">
            <details class="group">
                <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <span class="group-open:hidden">📖 구약 성경 펼치기 ▼</span><span class="hidden group-open:inline">📖 구약 성경 접기 ▲</span>
                </summary>
                <div id="old-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 mt-4 p-2"></div>
            </details>
            <details class="group">
                <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <span class="group-open:hidden">📖 신약 성경 펼치기 ▼</span><span class="hidden group-open:inline">📖 신약 성경 접기 ▲</span>
                </summary>
                <div id="new-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 mt-4 p-2"></div>
            </details>
        </section>
    `;
    renderWisdomVerse();
    renderLeaderboard();
    renderFamilyDashboard();
    renderBibleBooks();
}

function renderSharingTab() {
    const container = document.getElementById('content-sharing');
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="accent-bg rounded-lg p-4">
                <h3 class="text-xl font-bold mb-3">💬 가족 묵상 나눔</h3>
                <div id="meditation-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="meditation-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                    <input type="text" id="meditation-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="오늘의 묵상을 나눠보세요...">
                    <button onclick="addGenericItem('meditation')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">등록</button>
                </div>
            </div>
            <div class="accent-bg rounded-lg p-4">
                <h3 class="text-xl font-bold mb-3">🙏 가족 기도 노트</h3>
                <div id="prayer-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="prayer-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                    <input type="text" id="prayer-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="함께 기도할 제목을 나눠요...">
                    <button onclick="addGenericItem('prayer')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">등록</button>
                </div>
            </div>
        </div>
    `;
    renderMeditations();
    renderPrayers();
}

function renderMessagesTab() {
    const container = document.getElementById('content-messages');
    container.innerHTML = `
         <section class="accent-bg rounded-lg p-4">
            <h3 class="text-xl font-bold mb-3">💌 가족 메시지 보드</h3>
            <div id="message-board-list" class="h-96 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-4"></div>
            <div class="flex flex-col sm:flex-row gap-2">
                <select id="message-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                <textarea id="message-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="가족에게 남길 메시지를 작성하세요..." rows="1"></textarea>
                <button onclick="addGenericItem('message')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">메시지 남기기</button>
            </div>
        </section>
    `;
    renderMessageBoard();
}

function renderAllowanceTab() {
    const container = document.getElementById('content-allowance');
    const allowanceUsers = db.family.filter(u => allowanceTargetIds.includes(u.id));

    if (allowanceUsers.length === 0) {
        container.innerHTML = `<div class="text-center p-8 text-gray-500">용돈 시스템이 설정된 사용자가 없습니다.</div>`;
        return;
    }

    let cardsHTML = allowanceUsers.map(user => {
        const userLedger = db.allowance_ledger.filter(item => item.user_id === user.id);
        const balance = userLedger.reduce((sum, item) => sum + Number(item.amount), 0);
        const totalEarned = userLedger.filter(item => item.type === '적립').reduce((sum, item) => sum + Number(item.amount), 0);
        return `
            <div class="allowance-card rounded-lg p-6 flex flex-col items-center text-center">
                <img src="${user.photo || 'https://placehold.co/100x100'}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg" referrerpolicy="no-referrer">
                <h4 class="text-2xl font-bold mt-4">${user.name}</h4>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">현재 잔액</p>
                    <p class="text-4xl font-bold accent-text">${balance.toLocaleString()}원</p>
                </div>
                <div class="mt-2 text-sm">
                    <span>총 적립액: ${totalEarned.toLocaleString()}원</span>
                </div>
                <button onclick="openWithdrawModal('${user.id}', '${user.name}', ${balance})" class="mt-6 bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600 transition">
                    인출하기
                </button>
            </div>
        `;
    }).join('');

    const recentActivityHTML = `
        <div class="mt-8">
            <h4 class="text-xl font-bold mb-3 text-center">최근 활동 내역</h4>
            <div class="accent-bg rounded-lg p-4 max-h-64 overflow-y-auto custom-scrollbar">
                <table class="allowance-history-table text-sm">
                    <thead><tr><th>시간</th><th>이름</th><th>내용</th><th>금액</th></tr></thead>
                    <tbody>
                        ${db.allowance_ledger.slice().reverse().slice(0, 10).map(item => `
                            <tr>
                                <td class="whitespace-nowrap">${new Date(item.timestamp).toLocaleDateString('ko-KR')}</td>
                                <td>${item.name}</td>
                                <td>${item.description}</td>
                                <td class="${item.type === '적립' ? 'transaction-deposit font-bold' : 'transaction-withdrawal'}">
                                    ${Number(item.amount).toLocaleString()}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    container.innerHTML = `
        <div class="text-center mb-6">
            <h3 class="text-3xl font-bold font-myeongjo">✨ 비전 통장 ✨</h3>
            <p class="mt-1 text-gray-600">말씀 읽기로 차곡차곡 쌓이는 우리의 비전!</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            ${cardsHTML}
        </div>
        ${recentActivityHTML}
    `;
}

function renderStatsTab() {
    // 통계 탭 렌더링 로직 (향후 구현)
    const container = document.getElementById('content-stats');
    container.innerHTML = `<div class="text-center p-8 text-gray-500">통계 및 현황 페이지는 준비 중입니다.</div>`;
}

// --- 5. 컴포넌트 렌더링 헬퍼 함수 ---

function renderWisdomVerse() {
    const verses = [ "자녀들아 주 안에서 너희 부모에게 순종하라 이것이 옳으니라 (에베소서 6:1)","여호와는 나의 목자시니 내게 부족함이 없으리로다 (시편 23:1)","주 너의 하나님을 사랑하고 또한 네 이웃을 네 자신 같이 사랑하라 (마태복음 22:37-39)","항상 기뻐하라 쉬지 말고 기도하라 범사에 감사하라 (데살로니가전서 5:16-18)","수고하고 무거운 짐 진 자들아 다 내게로 오라 내가 너희를 쉬게 하리라 (마태복음 11:28)" ];
    const verseElement = document.getElementById('wisdom-verse');
    if (verseElement) {
        verseElement.textContent = verses[Math.floor(Math.random() * verses.length)];
    }
}

function renderLeaderboard() {
    const container = document.getElementById('leaderboard');
    if (!container) return;
    // 리더보드 렌더링 로직
    container.innerHTML = `<div class="text-center p-4 accent-bg rounded-lg">리더보드 준비 중</div>`;
}

function renderFamilyDashboard() {
    const container = document.getElementById('family-dashboard');
    if (!container || !db.family) return;
    container.innerHTML = db.family.map(member => {
        const userRecords = db.reading_records[member.id] || {};
        const totalRead = Object.values(userRecords).reduce((sum, book) => sum + (book.chapters?.length || 0), 0);
        return `
            <div class="flex flex-col items-center cursor-pointer hover:opacity-80 transition" onclick="openProgressModal('${member.id}')">
                <img src="${member.photo || 'https://placehold.co/80x80'}" alt="${member.name}" class="w-20 h-20 rounded-full border-4 border-white/50 object-cover shadow-md" referrerpolicy="no-referrer">
                <div class="font-bold mt-2">${member.title} (${member.name})</div>
                <div class="text-sm mt-1">총 ${totalRead}장 읽음</div>
            </div>
        `;
    }).join('');
}

function renderBibleBooks() {
    const oldDiv = document.getElementById('old-testament');
    const newDiv = document.getElementById('new-testament');
    if (!oldDiv || !newDiv) return;

    const createEl = (book) => `<button class="p-2 text-sm rounded-md shadow-sm transition-all duration-200 accent-bg hover:shadow-lg hover:-translate-y-1" onclick="openChapterModal('${book.name}')">${book.name}</button>`;
    
    oldDiv.innerHTML = BIBLE_BOOKS.old.map(createEl).join('');
    newDiv.innerHTML = BIBLE_BOOKS.new.map(createEl).join('');
}

function renderMeditations() {
    const container = document.getElementById('meditation-list');
    if (!container) return;
    container.innerHTML = (db.meditations || []).slice().reverse().map(item => `
        <div class="p-2 mb-2 rounded bg-white/70 text-sm">
            <div><strong>${item.user_name || item.user_id}:</strong> ${item.content}</div>
            <div class="text-right text-gray-500 text-xs flex items-center justify-end gap-2 mt-1">
                <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                <button class="text-gray-500 hover:text-red-500" onclick="likeItem('meditation', '${item.id}')">👍 ${item.like_count || 0}</button>
            </div>
        </div>
    `).join('');
}

function renderPrayers() {
    const container = document.getElementById('prayer-list');
    if (!container) return;
    container.innerHTML = (db.prayers || []).slice().reverse().map(item => `
        <div class="p-2 mb-2 rounded bg-white/70 text-sm">
            <div><strong>${item.user_name || item.user_id}:</strong> ${item.content}</div>
            <div class="text-right text-gray-500 text-xs flex items-center justify-end gap-2 mt-1">
                <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                 <button class="text-gray-500 hover:text-red-500" onclick="likeItem('prayer', '${item.id}')">👍 ${item.like_count || 0}</button>
            </div>
        </div>
    `).join('');
}

function renderMessageBoard() {
    const container = document.getElementById('message-board-list');
    if (!container) return;

    const sortedMessages = (db.messages || []).slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    if (sortedMessages.length === 0) {
        container.innerHTML = `<div class="text-center text-gray-500 p-8">가족에게 첫 메시지를 남겨보세요! 👋</div>`;
        return;
    }

    container.innerHTML = sortedMessages.map(message => {
        const user = db.family.find(u => u.id === message.user_id);
        return `
            <div class="p-3 bg-white/80 rounded-lg shadow-sm">
                <div class="flex items-start gap-3">
                    <img src="${user?.photo || 'https://placehold.co/40x40'}" class="w-10 h-10 rounded-full object-cover" referrerpolicy="no-referrer">
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${user?.name || message.user_name}</span>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp).toLocaleString('ko-KR')}</span>
                        </div>
                        <p class="mt-1 text-sm whitespace-pre-wrap">${message.content}</p>
                        <div class="mt-2 flex items-center gap-4 text-xs">
                            <button class="text-gray-600 hover:text-red-500" onclick="likeItem('message', '${message.id}')">👍 ${message.like_count || 0}</button>
                            <button class="text-gray-600 hover:text-blue-500" onclick="toggleCommentForm('comment-form-${message.id}')">💬 댓글 달기</button>
                        </div>
                    </div>
                </div>
                <div id="comments-for-${message.id}" class="ml-12 mt-3 space-y-3">
                    ${renderComments(message.id, null)}
                </div>
                <div id="comment-form-${message.id}" class="ml-12 mt-3 hidden">
                    <div class="flex gap-2">
                        <textarea id="comment-input-${message.id}" class="flex-grow p-2 text-sm rounded-md min-w-0" placeholder="댓글을 입력하세요..." rows="1"></textarea>
                        <button class="bg-white/80 hover:bg-white p-2 rounded-md shadow text-sm" onclick="addComment('${message.id}', null)">등록</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderComments(messageId, parentId) {
    return (db.comments || [])
        .filter(c => c.message_id === messageId && (c.parent_id || null) === parentId)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
        .map(comment => {
            const user = db.family.find(u => u.id === comment.user_id);
            return `
                <div class="flex items-start gap-2">
                    <img src="${user?.photo || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded-full object-cover mt-1" referrerpolicy="no-referrer">
                    <div class="flex-grow bg-gray-100 p-2 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm">${user?.name || comment.user_name}</span>
                        </div>
                        <p class="mt-1 text-sm whitespace-pre-wrap">${comment.content}</p>
                        <div class="mt-1 flex items-center gap-3 text-xs">
                            <button class="text-gray-500 hover:text-red-500" onclick="likeItem('comment', '${comment.id}')">👍 ${comment.like_count || 0}</button>
                            <button class="text-gray-500 hover:text-blue-500" onclick="toggleCommentForm('comment-form-${comment.id}')">↪️ 답글</button>
                        </div>
                        <div id="replies-to-${comment.id}" class="mt-2 space-y-2">
                             ${renderComments(messageId, comment.id)}
                        </div>
                         <div id="comment-form-${comment.id}" class="mt-2 hidden">
                            <div class="flex gap-2">
                                <textarea id="comment-input-${comment.id}" class="flex-grow p-2 text-xs rounded-md min-w-0" placeholder="@${user?.name || comment.user_name}에게 답글..." rows="1"></textarea>
                                <button class="bg-white hover:bg-white/80 p-1 px-2 rounded-md shadow text-xs" onclick="addComment('${messageId}', '${comment.id}')">등록</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
}


// --- 6. 이벤트 핸들러 및 액션 함수 ---

function setupEventListeners() {
    document.querySelector('.tab-nav').addEventListener('click', e => {
        const tabButton = e.target.closest('.main-tab');
        if (tabButton) switchMainTab(tabButton.dataset.tab);
    });

    document.getElementById('theme-select').addEventListener('change', e => {
        document.body.className = e.target.value;
    });

    document.getElementById('close-chapter-modal').addEventListener('click', closeChapterModal);
    document.getElementById('close-allowance-modal').addEventListener('click', closeWithdrawModal);
    
    // 키보드 ESC로 모달 닫기
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            closeChapterModal();
            closeWithdrawModal();
        }
    });
}

function switchMainTab(tabName) {
    document.querySelectorAll('.main-tab').forEach(tab => {
        tab.classList.toggle('tab-active', tab.dataset.tab === tabName);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('hidden', content.id !== `content-${tabName}`);
    });
}

async function toggleChapterRead(bookName, chapter, userId) {
    const userRecords = db.reading_records[userId]?.[bookName]?.chapters || [];
    const isRead = userRecords.includes(chapter);
    const action = isRead ? 'delete' : 'save';
    const userName = db.family.find(u => u.id === userId)?.name || userId;
    await gapi.performAction(action, { type: 'reading', userId, userName, bookName, chapter });
}

async function addGenericItem(type) {
    const userInput = document.getElementById(`${type}-user`);
    const textInput = document.getElementById(`${type}-input`);
    const content = textInput.value.trim();
    if (!content) return;

    const userId = userInput.value;
    const userName = db.family.find(u => u.id === userId)?.name || userId;
    
    await gapi.performAction('save', { type, userId, userName, content });
    textInput.value = '';
}

async function addComment(messageId, parentId) {
    const inputId = parentId ? `comment-input-${parentId}` : `comment-input-${messageId}`;
    const textInput = document.getElementById(inputId);
    const content = textInput.value.trim();
    if (!content) return;

    const userId = document.getElementById('message-user').value;
    const userName = db.family.find(u => u.id === userId)?.name || userId;

    await gapi.performAction('save', { type: 'comment', userId, userName, content, messageId, parentId });
    textInput.value = '';
}

async function likeItem(type, id) {
    await gapi.performAction('like', { type, id });
}

function openWithdrawModal(userId, userName, balance) {
    const modal = document.getElementById('allowance-modal');
    document.getElementById('allowance-modal-title').textContent = `${userName} 용돈 인출하기`;
    const contentDiv = document.getElementById('allowance-modal-content');
    contentDiv.innerHTML = `
        <p class="mb-4">현재 잔액: <strong class="text-xl">${balance.toLocaleString()}원</strong></p>
        <div class="flex flex-col gap-2">
            <label for="withdraw-amount" class="font-semibold">인출할 금액</label>
            <input type="number" id="withdraw-amount" class="p-2 border rounded-md w-full" placeholder="금액을 입력하세요" max="${balance}">
            <button onclick="handleWithdraw('${userId}', '${userName}')" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600 transition">
                인출 실행
            </button>
        </div>
    `;
    modal.classList.remove('hidden');
}

async function handleWithdraw(userId, userName) {
    const amountInput = document.getElementById('withdraw-amount');
    const amount = parseInt(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
        alert('올바른 금액을 입력하세요.');
        return;
    }
    await gapi.performAction('withdraw', { userId, userName, amount });
    closeWithdrawModal();
}

// --- 7. UI 헬퍼 및 기타 함수 ---

function showLoadingState(isLoading, message = '처리 중...') {
    const overlay = document.getElementById('loading-overlay');
    if (isLoading) {
        document.getElementById('loading-text').textContent = message;
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
    } else {
        overlay.classList.remove('hidden');
        overlay.classList.remove('flex');
    }
}

function updateConnectionStatus(isOnline, isConnecting = false) {
    const indicator = document.getElementById('status-indicator');
    const text = document.getElementById('status-text');
    indicator.classList.remove('animate-pulse');

    if (isConnecting) {
        indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
        text.textContent = '연결 중...';
    } else if (isOnline) {
        indicator.className = 'w-3 h-3 rounded-full bg-green-500';
        text.textContent = '온라인';
    } else {
        indicator.className = 'w-3 h-3 rounded-full bg-red-500';
        text.textContent = '오프라인';
    }
}

function populateUserDropdowns() {
    const selectors = ['meditation-user', 'prayer-user', 'message-user', 'modal-user-selector'];
    selectors.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            const currentVal = select.value;
            select.innerHTML = db.family.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            if(currentVal) select.value = currentVal;
        }
    });
}

function openChapterModal(bookName) {
    currentBook = BIBLE_BOOKS.old.find(b => b.name === bookName) || BIBLE_BOOKS.new.find(b => b.name === bookName);
    if (!currentBook) return;

    const modal = document.getElementById('chapter-modal');
    document.getElementById('modal-title').textContent = currentBook.name;
    document.getElementById('modal-user-selector').value = currentUserForModal;
    renderModalChapters();
    modal.classList.remove('hidden');
}

function renderModalChapters() {
    const container = document.getElementById('modal-chapters');
    const selectedUserId = document.getElementById('modal-user-selector').value;
    const userChapters = db.reading_records[selectedUserId]?.[currentBook.name]?.chapters || [];
    
    container.innerHTML = Array.from({ length: currentBook.chapters }, (_, i) => i + 1).map(chapter => {
        const isRead = userChapters.includes(chapter);
        return `<button class="p-2 rounded border transition-colors duration-200 ${isRead ? 'bg-green-500 text-white' : 'bg-white hover:bg-green-100'}" onclick="toggleChapterRead('${currentBook.name}', ${chapter}, '${selectedUserId}')">${chapter}</button>`;
    }).join('');
}

function toggleCommentForm(formId) {
    document.getElementById(formId)?.classList.toggle('hidden');
}


function closeChapterModal() { document.getElementById('chapter-modal').classList.add('hidden'); }
function closeWithdrawModal() { document.getElementById('allowance-modal').classList.add('hidden'); }

</script>
</body>
</html>
