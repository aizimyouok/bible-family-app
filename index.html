<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Bible Time for Family</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/SHO8YuH.png">

    <?!= include('Stylesheet'); ?>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="theme-jerusalem">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 flex items-center gap-4 shadow-xl">
            <div class="loading-spinner"></div>
            <span id="loading-text" class="text-lg font-semibold">ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>

    <div id="app" class="relative p-2 sm:p-4 md:p-8 max-w-6xl mx-auto">
        <div id="header-top-right" class="absolute top-2 right-2 sm:top-4 sm:right-4 md:top-8 md:right-8 flex flex-col items-end gap-2 z-10">
            <div id="connection-status" class="flex items-center justify-center gap-2">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-xs sm:text-sm">ì—°ê²° ì¤‘...</span>
            </div>
            <div class="text-xs sm:text-sm">
                <label for="theme-select" class="mr-2">í…Œë§ˆ:</label>
                <select id="theme-select" class="p-1 rounded border-2 text-xs sm:text-sm" style="border-color: var(--border-color); background-color: var(--bg-accent);">
                    <option value="theme-jerusalem">ì˜ˆë£¨ì‚´ë ˜</option>
                    <option value="theme-creation">ì²œì§€ì°½ì¡°</option>
                    <option value="theme-exodus">ì¶œì• êµ½</option>
                    <option value="theme-kingdom">ì™•êµ­</option>
                </select>
            </div>
             <button id="admin-btn" class="mt-2 px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600" title="ê´€ë¦¬"âš™ï¸ ê´€ë¦¬</button>
        </div>

        <header class="text-center pt-20 md:pt-0 mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-myeongjo font-bold accent-text">Bible Time for Family</h1>
            <p class="mt-2 text-base sm:text-lg">ìš°ë¦¬ê°€ì¡±, ë§ì”€ìœ¼ë¡œ í•˜ë‚˜ë˜ëŠ” ì‹œê°„</p>
        </header>

        <div class="main-container shadow-xl rounded-2xl p-3 sm:p-4 md:p-6">
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-1 sm:space-x-2 md:space-x-4 overflow-x-auto tab-nav" aria-label="Main Tabs">
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="main">
                        ğŸ“– <span class="hidden sm:inline">ë§ì”€ê³¼ ì½ê¸°</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="sharing">
                        ğŸ’¬ <span class="hidden sm:inline">ë¬µìƒê³¼ ê¸°ë„</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="messages">
                        ğŸ’Œ <span class="hidden sm:inline">ë©”ì‹œì§€ ë³´ë“œ</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="allowance">
                        ğŸ’° <span class="hidden sm:inline">ë¹„ì „ í†µì¥</span>
                    </button>
                    <button class="main-tab whitespace-nowrap py-3 px-2 sm:px-3 md:px-4 border-b-2 font-medium text-xs sm:text-sm flex-shrink-0" data-tab="stats">
                        ğŸ“Š <span class="hidden sm:inline">í†µê³„ì™€ í˜„í™©</span>
                    </button>
                </nav>
            </div>

            <div id="content-main" class="tab-content hidden"></div>
            <div id="content-sharing" class="tab-content hidden"></div>
            <div id="content-messages" class="tab-content hidden"></div>
            <div id="content-allowance" class="tab-content hidden"></div>
            <div id="content-stats" class="tab-content hidden"></div>
        </div>
    </div>

    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold"></h2>
                <button id="close-chapter-modal" class="text-3xl">&times;</button>
            </div>
            <div class="flex items-center gap-2 mb-4">
                <label for="modal-user-selector">ì²´í¬í•  ì‚¬ëŒ:</label>
                <select id="modal-user-selector" class="p-1 border rounded"></select>
            </div>
            <div id="modal-chapters" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 p-2 accent-bg rounded custom-scrollbar"></div>
        </div>
    </div>
    
    <div id="allowance-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="allowance-modal-title" class="text-2xl font-bold">ìš©ëˆ ì¸ì¶œí•˜ê¸°</h2>
                <button id="close-allowance-modal" class="text-3xl">&times;</button>
            </div>
            <div id="allowance-modal-content"></div>
        </div>
    </div>
    
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-40">
        </div>

<script>
// =================================================================
// Bible Time for Family - Client-side JavaScript (Complete)
// =================================================================

// --- 1. ì „ì—­ ì„¤ì • ë° ë³€ìˆ˜ ---

const API_CONFIG = {
    scriptUrl: 'https://script.google.com/macros/s/AKfycbxx29G-6qp5r4XjRS_z6NxuFkIuHlfkZna-SP_aEHCmwtRk5f-LspCNzBhs0dAuI9E-eA/exec',
    apiKey: 'bible_family_default'
};

const BIBLE_BOOKS = { 
  old: [ { name: 'ì°½ì„¸ê¸°', chapters: 50 }, { name: 'ì¶œì• êµ½ê¸°', chapters: 40 }, { name: 'ë ˆìœ„ê¸°', chapters: 27 }, { name: 'ë¯¼ìˆ˜ê¸°', chapters: 36 }, { name: 'ì‹ ëª…ê¸°', chapters: 34 }, { name: 'ì—¬í˜¸ìˆ˜ì•„', chapters: 24 }, { name: 'ì‚¬ì‚¬ê¸°', chapters: 21 }, { name: 'ë£»ê¸°', chapters: 4 }, { name: 'ì‚¬ë¬´ì—˜ìƒ', chapters: 31 }, { name: 'ì‚¬ë¬´ì—˜í•˜', chapters: 24 }, { name: 'ì—´ì™•ê¸°ìƒ', chapters: 22 }, { name: 'ì—´ì™•ê¸°í•˜', chapters: 25 }, { name: 'ì—­ëŒ€ìƒ', chapters: 29 }, { name: 'ì—­ëŒ€í•˜', chapters: 36 }, { name: 'ì—ìŠ¤ë¼', chapters: 10 }, { name: 'ëŠí—¤ë¯¸ì•¼', chapters: 13 }, { name: 'ì—ìŠ¤ë”', chapters: 10 }, { name: 'ìš¥ê¸°', chapters: 42 }, { name: 'ì‹œí¸', chapters: 150 }, { name: 'ì ì–¸', chapters: 31 }, { name: 'ì „ë„ì„œ', chapters: 12 }, { name: 'ì•„ê°€', chapters: 8 }, { name: 'ì´ì‚¬ì•¼', chapters: 66 }, { name: 'ì˜ˆë ˆë¯¸ì•¼', chapters: 52 }, { name: 'ì˜ˆë ˆë¯¸ì•¼ì• ê°€', chapters: 5 }, { name: 'ì—ìŠ¤ê²”', chapters: 48 }, { name: 'ë‹¤ë‹ˆì—˜', chapters: 12 }, { name: 'í˜¸ì„¸ì•„', chapters: 14 }, { name: 'ìš”ì—˜', chapters: 3 }, { name: 'ì•„ëª¨ìŠ¤', chapters: 9 }, { name: 'ì˜¤ë°”ëŒœ', chapters: 1 }, { name: 'ìš”ë‚˜', chapters: 4 }, { name: 'ë¯¸ê°€', chapters: 7 }, { name: 'ë‚˜í›”', chapters: 3 }, { name: 'í•˜ë°•êµ­', chapters: 3 }, { name: 'ìŠ¤ë°”ëƒ', chapters: 3 }, { name: 'í•™ê°œ', chapters: 2 }, { name: 'ìŠ¤ê°€ë´', chapters: 14 }, { name: 'ë§ë¼ê¸°', chapters: 4 } ], 
  new: [ { name: 'ë§ˆíƒœë³µìŒ', chapters: 28 }, { name: 'ë§ˆê°€ë³µìŒ', chapters: 16 }, { name: 'ëˆ„ê°€ë³µìŒ', chapters: 24 }, { name: 'ìš”í•œë³µìŒ', chapters: 21 }, { name: 'ì‚¬ë„í–‰ì „', chapters: 28 }, { name: 'ë¡œë§ˆì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„ì „ì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„í›„ì„œ', chapters: 13 }, { name: 'ê°ˆë¼ë””ì•„ì„œ', chapters: 6 }, { name: 'ì—ë² ì†Œì„œ', chapters: 6 }, { name: 'ë¹Œë¦½ë³´ì„œ', chapters: 4 }, { name: 'ê³¨ë¡œìƒˆì„œ', chapters: 4 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ', chapters: 5 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ', chapters: 3 }, { name: 'ë””ëª¨ë°ì „ì„œ', chapters: 6 }, { name: 'ë””ëª¨ë°í›„ì„œ', chapters: 4 }, { name: 'ë””ë„ì„œ', chapters: 3 }, { name: 'ë¹Œë ˆëª¬ì„œ', chapters: 1 }, { name: 'íˆë¸Œë¦¬ì„œ', chapters: 13 }, { name: 'ì•¼ê³ ë³´ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œì „ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œí›„ì„œ', chapters: 3 }, { name: 'ìš”í•œ1ì„œ', chapters: 5 }, { name: 'ìš”í•œ2ì„œ', chapters: 1 }, { name: 'ìš”í•œ3ì„œ', chapters: 1 }, { name: 'ìœ ë‹¤ì„œ', chapters: 1 }, { name: 'ìš”í•œê³„ì‹œë¡', chapters: 22 } ] 
};

let gapi;
let db = {
    family: [],
    reading_records: {},
    meditations: [],
    prayers: [],
    messages: [],
    comments: [],
    allowance_ledger: []
};
let currentUserForModal = null;
let currentBook = null;
const allowanceTargetIds = ['hayul', 'hajun']; // ìš©ëˆ ì‹œìŠ¤í…œ ì ìš© ëŒ€ìƒ ID

// --- 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ë° ë©”ì¸ ë¡œì§ ---

document.addEventListener('DOMContentLoaded', () => {
    gapi = new EnhancedGoogleSheetsAPI();
    initializeApp();
    setupEventListeners();
});

async function initializeApp() {
    showLoadingState(true, 'ë°ì´í„° ë¡œë”© ì¤‘...');
    try {
        await gapi.loadAllData();
        if (db.family.length > 0) {
            currentUserForModal = db.family[0].id;
        }
        renderAllTabs();
        populateUserDropdowns();
        switchMainTab('main'); // ì´ˆê¸° íƒ­ ì„¤ì •
        updateConnectionStatus(true);
    } catch (error) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        updateConnectionStatus(false);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤í”„ë¼ì¸ ìƒíƒœì´ê±°ë‚˜ Apps Script URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    } finally {
        showLoadingState(false);
    }
}

// --- 3. API í†µì‹  í´ë˜ìŠ¤ (A-ì•ˆ: ì„œë²„ ìš°ì„  ë™ê¸°í™”) ---

class EnhancedGoogleSheetsAPI {
    constructor() {
        this.scriptUrl = API_CONFIG.scriptUrl;
        this.apiKey = API_CONFIG.apiKey;
    }

    async _request(action, params = {}) {
        updateConnectionStatus(true, true); // isConnecting = true
        const url = new URL(this.scriptUrl);
        url.searchParams.set('action', action);
        url.searchParams.set('apiKey', this.apiKey);
        Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'API ìš”ì²­ ì‹¤íŒ¨');
            updateConnectionStatus(true);
            return result.data;
        } catch (error) {
            updateConnectionStatus(false);
            console.error(`API Error (${action}):`, error);
            throw error;
        }
    }

    async loadAllData() {
        const data = await this._request('loadAll');
        Object.keys(data).forEach(key => {
            db[key] = data[key] || (key === 'reading_records' ? {} : []);
        });
    }

    async performAction(action, params) {
        showLoadingState(true, 'ì„œë²„ì™€ í†µì‹  ì¤‘...');
        try {
            await this._request(action, params);
            await this.loadAllData();
            renderAllTabs();
            populateUserDropdowns();
        } catch (error) {
            alert(`${action} ì‘ì—… ì‹¤íŒ¨: ${error.message}`);
            // ì‹¤íŒ¨ ì‹œì—ë„ ìµœì‹  ë°ì´í„°ë¡œ í™”ë©´ì„ ë‹¤ì‹œ ê·¸ë ¤ì„œ ë™ê¸°í™” ì‹œë„
            await this.loadAllData();
            renderAllTabs();
        } finally {
            showLoadingState(false);
        }
    }
}

// --- 4. íƒ­ë³„ ì½˜í…ì¸  ë Œë”ë§ ---

function renderAllTabs() {
    renderMainTab();
    renderSharingTab();
    renderMessagesTab();
    renderAllowanceTab();
    renderStatsTab();
}

function renderMainTab() {
    const container = document.getElementById('content-main');
    container.innerHTML = `
        <section class="mb-8 text-center p-6 border-2 border-dashed" style="border-color: var(--border-color);">
            <h2 class="text-xl font-bold font-myeongjo accent-text mb-2">ì˜¤ëŠ˜ì˜ ì§€í˜œ ë§ì”€</h2>
            <p id="wisdom-verse" class="text-lg"></p>
        </section>
        <section id="leaderboard" class="mb-8"></section>
        <section id="family-dashboard" class="mb-8 accent-bg rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center"></section>
        <section class="space-y-4">
            <details class="group">
                <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <span class="group-open:hidden">ğŸ“– êµ¬ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span><span class="hidden group-open:inline">ğŸ“– êµ¬ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                </summary>
                <div id="old-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 mt-4 p-2"></div>
            </details>
            <details class="group">
                <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                    <span class="group-open:hidden">ğŸ“– ì‹ ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span><span class="hidden group-open:inline">ğŸ“– ì‹ ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                </summary>
                <div id="new-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2 mt-4 p-2"></div>
            </details>
        </section>
    `;
    renderWisdomVerse();
    renderLeaderboard();
    renderFamilyDashboard();
    renderBibleBooks();
}

function renderSharingTab() {
    const container = document.getElementById('content-sharing');
    container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="accent-bg rounded-lg p-4">
                <h3 class="text-xl font-bold mb-3">ğŸ’¬ ê°€ì¡± ë¬µìƒ ë‚˜ëˆ”</h3>
                <div id="meditation-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="meditation-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                    <input type="text" id="meditation-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="ì˜¤ëŠ˜ì˜ ë¬µìƒì„ ë‚˜ëˆ ë³´ì„¸ìš”...">
                    <button onclick="addGenericItem('meditation')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">ë“±ë¡</button>
                </div>
            </div>
            <div class="accent-bg rounded-lg p-4">
                <h3 class="text-xl font-bold mb-3">ğŸ™ ê°€ì¡± ê¸°ë„ ë…¸íŠ¸</h3>
                <div id="prayer-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="prayer-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                    <input type="text" id="prayer-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="í•¨ê»˜ ê¸°ë„í•  ì œëª©ì„ ë‚˜ëˆ ìš”...">
                    <button onclick="addGenericItem('prayer')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">ë“±ë¡</button>
                </div>
            </div>
        </div>
    `;
    renderMeditations();
    renderPrayers();
}

function renderMessagesTab() {
    const container = document.getElementById('content-messages');
    container.innerHTML = `
         <section class="accent-bg rounded-lg p-4">
            <h3 class="text-xl font-bold mb-3">ğŸ’Œ ê°€ì¡± ë©”ì‹œì§€ ë³´ë“œ</h3>
            <div id="message-board-list" class="h-96 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2 space-y-4"></div>
            <div class="flex flex-col sm:flex-row gap-2">
                <select id="message-user" class="p-2 rounded-md w-full sm:w-auto"></select>
                <textarea id="message-input" class="flex-grow p-2 rounded-md min-w-0" placeholder="ê°€ì¡±ì—ê²Œ ë‚¨ê¸¸ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." rows="1"></textarea>
                <button onclick="addGenericItem('message')" class="bg-white/80 hover:bg-white p-2 rounded-md shadow whitespace-nowrap">ë©”ì‹œì§€ ë‚¨ê¸°ê¸°</button>
            </div>
        </section>
    `;
    renderMessageBoard();
}

function renderAllowanceTab() {
    const container = document.getElementById('content-allowance');
    const allowanceUsers = db.family.filter(u => allowanceTargetIds.includes(u.id));

    if (allowanceUsers.length === 0) {
        container.innerHTML = `<div class="text-center p-8 text-gray-500">ìš©ëˆ ì‹œìŠ¤í…œì´ ì„¤ì •ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
    }

    let cardsHTML = allowanceUsers.map(user => {
        const userLedger = db.allowance_ledger.filter(item => item.user_id === user.id);
        const balance = userLedger.reduce((sum, item) => sum + Number(item.amount), 0);
        const totalEarned = userLedger.filter(item => item.type === 'ì ë¦½').reduce((sum, item) => sum + Number(item.amount), 0);
        return `
            <div class="allowance-card rounded-lg p-6 flex flex-col items-center text-center">
                <img src="${user.photo || 'https://placehold.co/100x100'}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg" referrerpolicy="no-referrer">
                <h4 class="text-2xl font-bold mt-4">${user.name}</h4>
                <div class="mt-4">
                    <p class="text-sm text-gray-500">í˜„ì¬ ì”ì•¡</p>
                    <p class="text-4xl font-bold accent-text">${balance.toLocaleString()}ì›</p>
                </div>
                <div class="mt-2 text-sm">
                    <span>ì´ ì ë¦½ì•¡: ${totalEarned.toLocaleString()}ì›</span>
                </div>
                <button onclick="openWithdrawModal('${user.id}', '${user.name}', ${balance})" class="mt-6 bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600 transition">
                    ì¸ì¶œí•˜ê¸°
                </button>
            </div>
        `;
    }).join('');

    const recentActivityHTML = `
        <div class="mt-8">
            <h4 class="text-xl font-bold mb-3 text-center">ìµœê·¼ í™œë™ ë‚´ì—­</h4>
            <div class="accent-bg rounded-lg p-4 max-h-64 overflow-y-auto custom-scrollbar">
                <table class="allowance-history-table text-sm">
                    <thead><tr><th>ì‹œê°„</th><th>ì´ë¦„</th><th>ë‚´ìš©</th><th>ê¸ˆì•¡</th></tr></thead>
                    <tbody>
                        ${db.allowance_ledger.slice().reverse().slice(0, 10).map(item => `
                            <tr>
                                <td class="whitespace-nowrap">${new Date(item.timestamp).toLocaleDateString('ko-KR')}</td>
                                <td>${item.name}</td>
                                <td>${item.description}</td>
                                <td class="${item.type === 'ì ë¦½' ? 'transaction-deposit font-bold' : 'transaction-withdrawal'}">
                                    ${Number(item.amount).toLocaleString()}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    container.innerHTML = `
        <div class="text-center mb-6">
            <h3 class="text-3xl font-bold font-myeongjo">âœ¨ ë¹„ì „ í†µì¥ âœ¨</h3>
            <p class="mt-1 text-gray-600">ë§ì”€ ì½ê¸°ë¡œ ì°¨ê³¡ì°¨ê³¡ ìŒ“ì´ëŠ” ìš°ë¦¬ì˜ ë¹„ì „!</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            ${cardsHTML}
        </div>
        ${recentActivityHTML}
    `;
}

function renderStatsTab() {
    // í†µê³„ íƒ­ ë Œë”ë§ ë¡œì§ (í–¥í›„ êµ¬í˜„)
    const container = document.getElementById('content-stats');
    container.innerHTML = `<div class="text-center p-8 text-gray-500">í†µê³„ ë° í˜„í™© í˜ì´ì§€ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>`;
}

// --- 5. ì»´í¬ë„ŒíŠ¸ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜ ---

function renderWisdomVerse() {
    const verses = [ "ìë…€ë“¤ì•„ ì£¼ ì•ˆì—ì„œ ë„ˆí¬ ë¶€ëª¨ì—ê²Œ ìˆœì¢…í•˜ë¼ ì´ê²ƒì´ ì˜³ìœ¼ë‹ˆë¼ (ì—ë² ì†Œì„œ 6:1)","ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤ (ì‹œí¸ 23:1)","ì£¼ ë„ˆì˜ í•˜ë‚˜ë‹˜ì„ ì‚¬ë‘í•˜ê³  ë˜í•œ ë„¤ ì´ì›ƒì„ ë„¤ ìì‹  ê°™ì´ ì‚¬ë‘í•˜ë¼ (ë§ˆíƒœë³µìŒ 22:37-39)","í•­ìƒ ê¸°ë»í•˜ë¼ ì‰¬ì§€ ë§ê³  ê¸°ë„í•˜ë¼ ë²”ì‚¬ì— ê°ì‚¬í•˜ë¼ (ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ 5:16-18)","ìˆ˜ê³ í•˜ê³  ë¬´ê±°ìš´ ì§ ì§„ ìë“¤ì•„ ë‹¤ ë‚´ê²Œë¡œ ì˜¤ë¼ ë‚´ê°€ ë„ˆí¬ë¥¼ ì‰¬ê²Œ í•˜ë¦¬ë¼ (ë§ˆíƒœë³µìŒ 11:28)" ];
    const verseElement = document.getElementById('wisdom-verse');
    if (verseElement) {
        verseElement.textContent = verses[Math.floor(Math.random() * verses.length)];
    }
}

function renderLeaderboard() {
    const container = document.getElementById('leaderboard');
    if (!container) return;
    // ë¦¬ë”ë³´ë“œ ë Œë”ë§ ë¡œì§
    container.innerHTML = `<div class="text-center p-4 accent-bg rounded-lg">ë¦¬ë”ë³´ë“œ ì¤€ë¹„ ì¤‘</div>`;
}

function renderFamilyDashboard() {
    const container = document.getElementById('family-dashboard');
    if (!container || !db.family) return;
    container.innerHTML = db.family.map(member => {
        const userRecords = db.reading_records[member.id] || {};
        const totalRead = Object.values(userRecords).reduce((sum, book) => sum + (book.chapters?.length || 0), 0);
        return `
            <div class="flex flex-col items-center cursor-pointer hover:opacity-80 transition" onclick="openProgressModal('${member.id}')">
                <img src="${member.photo || 'https://placehold.co/80x80'}" alt="${member.name}" class="w-20 h-20 rounded-full border-4 border-white/50 object-cover shadow-md" referrerpolicy="no-referrer">
                <div class="font-bold mt-2">${member.title} (${member.name})</div>
                <div class="text-sm mt-1">ì´ ${totalRead}ì¥ ì½ìŒ</div>
            </div>
        `;
    }).join('');
}

function renderBibleBooks() {
    const oldDiv = document.getElementById('old-testament');
    const newDiv = document.getElementById('new-testament');
    if (!oldDiv || !newDiv) return;

    const createEl = (book) => `<button class="p-2 text-sm rounded-md shadow-sm transition-all duration-200 accent-bg hover:shadow-lg hover:-translate-y-1" onclick="openChapterModal('${book.name}')">${book.name}</button>`;
    
    oldDiv.innerHTML = BIBLE_BOOKS.old.map(createEl).join('');
    newDiv.innerHTML = BIBLE_BOOKS.new.map(createEl).join('');
}

function renderMeditations() {
    const container = document.getElementById('meditation-list');
    if (!container) return;
    container.innerHTML = (db.meditations || []).slice().reverse().map(item => `
        <div class="p-2 mb-2 rounded bg-white/70 text-sm">
            <div><strong>${item.user_name || item.user_id}:</strong> ${item.content}</div>
            <div class="text-right text-gray-500 text-xs flex items-center justify-end gap-2 mt-1">
                <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                <button class="text-gray-500 hover:text-red-500" onclick="likeItem('meditation', '${item.id}')">ğŸ‘ ${item.like_count || 0}</button>
            </div>
        </div>
    `).join('');
}

function renderPrayers() {
    const container = document.getElementById('prayer-list');
    if (!container) return;
    container.innerHTML = (db.prayers || []).slice().reverse().map(item => `
        <div class="p-2 mb-2 rounded bg-white/70 text-sm">
            <div><strong>${item.user_name || item.user_id}:</strong> ${item.content}</div>
            <div class="text-right text-gray-500 text-xs flex items-center justify-end gap-2 mt-1">
                <span>${new Date(item.timestamp).toLocaleDateString()}</span>
                 <button class="text-gray-500 hover:text-red-500" onclick="likeItem('prayer', '${item.id}')">ğŸ‘ ${item.like_count || 0}</button>
            </div>
        </div>
    `).join('');
}

function renderMessageBoard() {
    const container = document.getElementById('message-board-list');
    if (!container) return;

    const sortedMessages = (db.messages || []).slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    if (sortedMessages.length === 0) {
        container.innerHTML = `<div class="text-center text-gray-500 p-8">ê°€ì¡±ì—ê²Œ ì²« ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ‘‹</div>`;
        return;
    }

    container.innerHTML = sortedMessages.map(message => {
        const user = db.family.find(u => u.id === message.user_id);
        return `
            <div class="p-3 bg-white/80 rounded-lg shadow-sm">
                <div class="flex items-start gap-3">
                    <img src="${user?.photo || 'https://placehold.co/40x40'}" class="w-10 h-10 rounded-full object-cover" referrerpolicy="no-referrer">
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${user?.name || message.user_name}</span>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp).toLocaleString('ko-KR')}</span>
                        </div>
                        <p class="mt-1 text-sm whitespace-pre-wrap">${message.content}</p>
                        <div class="mt-2 flex items-center gap-4 text-xs">
                            <button class="text-gray-600 hover:text-red-500" onclick="likeItem('message', '${message.id}')">ğŸ‘ ${message.like_count || 0}</button>
                            <button class="text-gray-600 hover:text-blue-500" onclick="toggleCommentForm('comment-form-${message.id}')">ğŸ’¬ ëŒ“ê¸€ ë‹¬ê¸°</button>
                        </div>
                    </div>
                </div>
                <div id="comments-for-${message.id}" class="ml-12 mt-3 space-y-3">
                    ${renderComments(message.id, null)}
                </div>
                <div id="comment-form-${message.id}" class="ml-12 mt-3 hidden">
                    <div class="flex gap-2">
                        <textarea id="comment-input-${message.id}" class="flex-grow p-2 text-sm rounded-md min-w-0" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
                        <button class="bg-white/80 hover:bg-white p-2 rounded-md shadow text-sm" onclick="addComment('${message.id}', null)">ë“±ë¡</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderComments(messageId, parentId) {
    return (db.comments || [])
        .filter(c => c.message_id === messageId && (c.parent_id || null) === parentId)
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
        .map(comment => {
            const user = db.family.find(u => u.id === comment.user_id);
            return `
                <div class="flex items-start gap-2">
                    <img src="${user?.photo || 'https://placehold.co/32x32'}" class="w-8 h-8 rounded-full object-cover mt-1" referrerpolicy="no-referrer">
                    <div class="flex-grow bg-gray-100 p-2 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm">${user?.name || comment.user_name}</span>
                        </div>
                        <p class="mt-1 text-sm whitespace-pre-wrap">${comment.content}</p>
                        <div class="mt-1 flex items-center gap-3 text-xs">
                            <button class="text-gray-500 hover:text-red-500" onclick="likeItem('comment', '${comment.id}')">ğŸ‘ ${comment.like_count || 0}</button>
                            <button class="text-gray-500 hover:text-blue-500" onclick="toggleCommentForm('comment-form-${comment.id}')">â†ªï¸ ë‹µê¸€</button>
                        </div>
                        <div id="replies-to-${comment.id}" class="mt-2 space-y-2">
                             ${renderComments(messageId, comment.id)}
                        </div>
                         <div id="comment-form-${comment.id}" class="mt-2 hidden">
                            <div class="flex gap-2">
                                <textarea id="comment-input-${comment.id}" class="flex-grow p-2 text-xs rounded-md min-w-0" placeholder="@${user?.name || comment.user_name}ì—ê²Œ ë‹µê¸€..." rows="1"></textarea>
                                <button class="bg-white hover:bg-white/80 p-1 px-2 rounded-md shadow text-xs" onclick="addComment('${messageId}', '${comment.id}')">ë“±ë¡</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
}


// --- 6. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ì•¡ì…˜ í•¨ìˆ˜ ---

function setupEventListeners() {
    document.querySelector('.tab-nav').addEventListener('click', e => {
        const tabButton = e.target.closest('.main-tab');
        if (tabButton) switchMainTab(tabButton.dataset.tab);
    });

    document.getElementById('theme-select').addEventListener('change', e => {
        document.body.className = e.target.value;
    });

    document.getElementById('close-chapter-modal').addEventListener('click', closeChapterModal);
    document.getElementById('close-allowance-modal').addEventListener('click', closeWithdrawModal);
    
    // í‚¤ë³´ë“œ ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            closeChapterModal();
            closeWithdrawModal();
        }
    });
}

function switchMainTab(tabName) {
    document.querySelectorAll('.main-tab').forEach(tab => {
        tab.classList.toggle('tab-active', tab.dataset.tab === tabName);
    });
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('hidden', content.id !== `content-${tabName}`);
    });
}

async function toggleChapterRead(bookName, chapter, userId) {
    const userRecords = db.reading_records[userId]?.[bookName]?.chapters || [];
    const isRead = userRecords.includes(chapter);
    const action = isRead ? 'delete' : 'save';
    const userName = db.family.find(u => u.id === userId)?.name || userId;
    await gapi.performAction(action, { type: 'reading', userId, userName, bookName, chapter });
}

async function addGenericItem(type) {
    const userInput = document.getElementById(`${type}-user`);
    const textInput = document.getElementById(`${type}-input`);
    const content = textInput.value.trim();
    if (!content) return;

    const userId = userInput.value;
    const userName = db.family.find(u => u.id === userId)?.name || userId;
    
    await gapi.performAction('save', { type, userId, userName, content });
    textInput.value = '';
}

async function addComment(messageId, parentId) {
    const inputId = parentId ? `comment-input-${parentId}` : `comment-input-${messageId}`;
    const textInput = document.getElementById(inputId);
    const content = textInput.value.trim();
    if (!content) return;

    const userId = document.getElementById('message-user').value;
    const userName = db.family.find(u => u.id === userId)?.name || userId;

    await gapi.performAction('save', { type: 'comment', userId, userName, content, messageId, parentId });
    textInput.value = '';
}

async function likeItem(type, id) {
    await gapi.performAction('like', { type, id });
}

function openWithdrawModal(userId, userName, balance) {
    const modal = document.getElementById('allowance-modal');
    document.getElementById('allowance-modal-title').textContent = `${userName} ìš©ëˆ ì¸ì¶œí•˜ê¸°`;
    const contentDiv = document.getElementById('allowance-modal-content');
    contentDiv.innerHTML = `
        <p class="mb-4">í˜„ì¬ ì”ì•¡: <strong class="text-xl">${balance.toLocaleString()}ì›</strong></p>
        <div class="flex flex-col gap-2">
            <label for="withdraw-amount" class="font-semibold">ì¸ì¶œí•  ê¸ˆì•¡</label>
            <input type="number" id="withdraw-amount" class="p-2 border rounded-md w-full" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" max="${balance}">
            <button onclick="handleWithdraw('${userId}', '${userName}')" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600 transition">
                ì¸ì¶œ ì‹¤í–‰
            </button>
        </div>
    `;
    modal.classList.remove('hidden');
}

async function handleWithdraw(userId, userName) {
    const amountInput = document.getElementById('withdraw-amount');
    const amount = parseInt(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
        alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }
    await gapi.performAction('withdraw', { userId, userName, amount });
    closeWithdrawModal();
}

// --- 7. UI í—¬í¼ ë° ê¸°íƒ€ í•¨ìˆ˜ ---

function showLoadingState(isLoading, message = 'ì²˜ë¦¬ ì¤‘...') {
    const overlay = document.getElementById('loading-overlay');
    if (isLoading) {
        document.getElementById('loading-text').textContent = message;
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
    } else {
        overlay.classList.remove('hidden');
        overlay.classList.remove('flex');
    }
}

function updateConnectionStatus(isOnline, isConnecting = false) {
    const indicator = document.getElementById('status-indicator');
    const text = document.getElementById('status-text');
    indicator.classList.remove('animate-pulse');

    if (isConnecting) {
        indicator.className = 'w-3 h-3 rounded-full bg-yellow-500';
        text.textContent = 'ì—°ê²° ì¤‘...';
    } else if (isOnline) {
        indicator.className = 'w-3 h-3 rounded-full bg-green-500';
        text.textContent = 'ì˜¨ë¼ì¸';
    } else {
        indicator.className = 'w-3 h-3 rounded-full bg-red-500';
        text.textContent = 'ì˜¤í”„ë¼ì¸';
    }
}

function populateUserDropdowns() {
    const selectors = ['meditation-user', 'prayer-user', 'message-user', 'modal-user-selector'];
    selectors.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
            const currentVal = select.value;
            select.innerHTML = db.family.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            if(currentVal) select.value = currentVal;
        }
    });
}

function openChapterModal(bookName) {
    currentBook = BIBLE_BOOKS.old.find(b => b.name === bookName) || BIBLE_BOOKS.new.find(b => b.name === bookName);
    if (!currentBook) return;

    const modal = document.getElementById('chapter-modal');
    document.getElementById('modal-title').textContent = currentBook.name;
    document.getElementById('modal-user-selector').value = currentUserForModal;
    renderModalChapters();
    modal.classList.remove('hidden');
}

function renderModalChapters() {
    const container = document.getElementById('modal-chapters');
    const selectedUserId = document.getElementById('modal-user-selector').value;
    const userChapters = db.reading_records[selectedUserId]?.[currentBook.name]?.chapters || [];
    
    container.innerHTML = Array.from({ length: currentBook.chapters }, (_, i) => i + 1).map(chapter => {
        const isRead = userChapters.includes(chapter);
        return `<button class="p-2 rounded border transition-colors duration-200 ${isRead ? 'bg-green-500 text-white' : 'bg-white hover:bg-green-100'}" onclick="toggleChapterRead('${currentBook.name}', ${chapter}, '${selectedUserId}')">${chapter}</button>`;
    }).join('');
}

function toggleCommentForm(formId) {
    document.getElementById(formId)?.classList.toggle('hidden');
}


function closeChapterModal() { document.getElementById('chapter-modal').classList.add('hidden'); }
function closeWithdrawModal() { document.getElementById('allowance-modal').classList.add('hidden'); }

</script>
</body>
</html>
