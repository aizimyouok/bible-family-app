<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Time for Family</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/your-favicon.png">
    <link rel="shortcut icon" href="https://i.imgur.com/your-favicon.png">
    <link rel="apple-touch-icon" href="https://i.imgur.com/your-favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nanum+Myeongjo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-myeongjo { font-family: 'Nanum Myeongjo', serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c5a992; border-radius: 10px; }
        .theme-creation { --bg-main: #f0f4f8; --bg-container: #ffffff; --bg-accent: #e6f0e6; --text-primary: #2c3e50; --text-accent: #1e8449; --border-color: #d4e6d4; }
        .theme-jerusalem { --bg-main: #fdfaf6; --bg-container: #ffffff; --bg-accent: #f8f1e9; --text-primary: #5a4b42; --text-accent: #8d6e63; --border-color: #d7ccc8; }
        body { background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.5s, color 0.5s; }
        .main-container { background-color: var(--bg-container); transition: background-color 0.5s; }
        .accent-bg { background-color: var(--bg-accent); transition: background-color 0.5s; }
        .accent-text { color: var(--text-accent); transition: color 0.5s; }
        .border-custom { border-color: var(--border-color); transition: border-color 0.5s; }
        .progress-bar-fill { background-color: var(--text-accent); transition: background-color 0.5s, width 0.3s ease-in-out; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading { animation: spin 1s linear infinite; }
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .status-loading { color: #f59e0b; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="theme-jerusalem">

    <div id="app" class="p-4 md:p-8 max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-myeongjo font-bold accent-text">Bible Time for Family</h1>
            <p class="mt-2 text-lg">ìš°ë¦¬ê°€ì¡±, ë§ì”€ìœ¼ë¡œ í•˜ë‚˜ë˜ëŠ” ì‹œê°„</p>
            <div id="connection-status" class="mt-2 flex items-center justify-center gap-2">
                <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-sm">ì—°ê²° í™•ì¸ ì¤‘...</span>
                <button id="sync-btn" class="ml-2 px-2 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 hidden">ğŸ”„ ë™ê¸°í™”</button>
            </div>
            <div class="mt-4 flex justify-center items-center gap-4 flex-wrap">
                <div>
                    <label for="theme-select" class="mr-2">í…Œë§ˆ ì„ íƒ:</label>
                    <select id="theme-select" class="p-1 rounded border-custom border-2 accent-bg">
                        <option value="theme-jerusalem">ì˜ˆë£¨ì‚´ë ˜ (í™ê³¼ ëŒ)</option>
                        <option value="theme-creation">ì²œì§€ì°½ì¡° (í•˜ëŠ˜ê³¼ í’€)</option>
                    </select>
                </div>
                <button id="badges-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg transition-all">ğŸ† ë±ƒì§€ ì»¬ë ‰ì…˜</button>
            </div>
        </header>

        <div class="main-container shadow-xl rounded-2xl p-4 md:p-6">
            <section id="family-dashboard" class="mb-8 accent-bg rounded-lg p-4 grid grid-cols-2 md:grid-cols-4 gap-4 items-center text-center"></section>
            <section class="mb-8 text-center p-6 border-2 border-dashed border-custom rounded-lg">
                <h2 class="text-xl font-bold font-myeongjo accent-text mb-2">ì˜¤ëŠ˜ì˜ ì§€í˜œ ë§ì”€</h2>
                <p id="wisdom-verse" class="text-lg"></p>
            </section>
            
            <section class="mb-8 space-y-4">
                <details class="group">
                    <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                        <span class="group-open:hidden">ğŸ“– êµ¬ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span>
                        <span class="hidden group-open:inline">ğŸ“– êµ¬ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                    </summary>
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold mb-3 text-center accent-text">êµ¬ì•½ (39ê¶Œ)</h3>
                        <div id="old-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                    </div>
                </details>
                <details class="group">
                    <summary class="text-2xl font-bold text-center cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition">
                        <span class="group-open:hidden">ğŸ“– ì‹ ì•½ ì„±ê²½ í¼ì¹˜ê¸° â–¼</span>
                        <span class="hidden group-open:inline">ğŸ“– ì‹ ì•½ ì„±ê²½ ì ‘ê¸° â–²</span>
                    </summary>
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold mb-3 text-center accent-text">ì‹ ì•½ (27ê¶Œ)</h3>
                        <div id="new-testament" class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                    </div>
                </details>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">ğŸ’¬ ê°€ì¡± ë¬µìƒ ë‚˜ëˆ”</h3>
                    <div id="meditation-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2"></div>
                    <div class="flex gap-2">
                        <select id="meditation-user" class="p-2 border-custom border rounded-md"></select>
                        <input type="text" id="meditation-input" class="flex-grow p-2 border-custom border rounded-md" placeholder="ì˜¤ëŠ˜ì˜ ë¬µìƒì„ ë‚˜ëˆ ë³´ì„¸ìš”...">
                        <button id="add-meditation" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                    </div>
                </div>
                <div class="accent-bg rounded-lg p-4">
                    <h3 class="text-xl font-bold mb-3">ğŸ™ ê°€ì¡± ê¸°ë„ ë…¸íŠ¸</h3>
                    <div id="prayer-list" class="h-64 overflow-y-auto custom-scrollbar pr-2 mb-3 bg-white/50 rounded p-2"></div>
                    <div class="flex gap-2">
                        <select id="prayer-user" class="p-2 border-custom border rounded-md"></select>
                        <input type="text" id="prayer-input" class="flex-grow p-2 border-custom border rounded-md" placeholder="í•¨ê»˜ ê¸°ë„í•  ì œëª©ì„ ë‚˜ëˆ ìš”...">
                        <button id="add-prayer" class="bg-white/80 hover:bg-white p-2 rounded-md shadow">ë“±ë¡</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-2xl font-bold"></h2><button id="close-modal" class="text-3xl">&times;</button></div>
            <div id="modal-user-selector-container" class="flex items-center gap-2 mb-4"><label for="modal-user-selector">ì²´í¬í•  ì‚¬ëŒ:</label><select id="modal-user-selector" class="p-1 border rounded"></select></div>
            <div id="modal-chapters" class="flex-grow overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2 p-2 accent-bg rounded custom-scrollbar"></div>
        </div>
    </div>
    <div id="badges-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">ğŸ† ìš°ë¦¬ ê°€ì¡± ë±ƒì§€ ì»¬ë ‰ì…˜</h2><button id="close-badges-modal" class="text-3xl">&times;</button></div>
            <div id="badge-tabs" class="flex mb-4 border-b"></div><div id="badges-content" class="flex-grow overflow-y-auto custom-scrollbar"></div>
        </div>
    </div>
    <div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-30">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4"><h2 id="progress-modal-title" class="text-2xl font-bold">ìƒì„¸ ì§„í–‰ í˜„í™©</h2><button id="close-progress-modal" class="text-3xl">&times;</button></div>
            <div id="progress-modal-content" class="flex-grow overflow-y-auto custom-scrollbar pr-4"></div>
        </div>
    </div>

<script>
// --- êµ¬ê¸€ ì‹œíŠ¸ API í´ë˜ìŠ¤ ---
class GoogleSheetsAPI {
    constructor() {
        this.scriptUrl = 'https://script.google.com/macros/s/AKfycbwb4-NMBFNYhv94HGJwCXF1mAbKR-ixmWLS77t-2F3yB_a7q2QsEJatwLCmgIGfc3FXLg/exec';
        this.isConnected = false;
    }
    async _request(action, params = {}) {
        const url = new URL(this.scriptUrl);
        url.searchParams.set('action', action);
        for (const key in params) { url.searchParams.set(key, params[key]); }
        try {
            const response = await fetch(url.toString());
            if (!response.ok) throw new Error(`Server Error: ${response.status}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'API ìš”ì²­ ì‹¤íŒ¨');
            this.isConnected = true;
            return result;
        } catch (error) {
            this.isConnected = false;
            updateConnectionStatus('disconnected');
            console.error(`API Error (${action}):`, error);
            throw error;
        }
    }
    async testConnection() { await this._request('test'); return true; }
    async loadAllData() {
        const result = await this._request('loadAll');
        for (const sheetName in result.data) {
            localStorage.setItem(`bible_${sheetName}`, JSON.stringify(result.data[sheetName]));
        }
        return result.data;
    }
    async saveData(params) { return this._request('save', params); }
    async deleteData(params) { return this._request('delete', params); }
    async editData(params) { return this._request('edit', params); }
}

// --- ë°ì´í„° ë° ì„¤ì • ---
const BIBLE_BOOKS = { old: [ { name: 'ì°½ì„¸ê¸°', chapters: 50 }, { name: 'ì¶œì• êµ½ê¸°', chapters: 40 }, { name: 'ë ˆìœ„ê¸°', chapters: 27 }, { name: 'ë¯¼ìˆ˜ê¸°', chapters: 36 }, { name: 'ì‹ ëª…ê¸°', chapters: 34 }, { name: 'ì—¬í˜¸ìˆ˜ì•„', chapters: 24 }, { name: 'ì‚¬ì‚¬ê¸°', chapters: 21 }, { name: 'ë£»ê¸°', chapters: 4 }, { name: 'ì‚¬ë¬´ì—˜ìƒ', chapters: 31 }, { name: 'ì‚¬ë¬´ì—˜í•˜', chapters: 24 }, { name: 'ì—´ì™•ê¸°ìƒ', chapters: 22 }, { name: 'ì—´ì™•ê¸°í•˜', chapters: 25 }, { name: 'ì—­ëŒ€ìƒ', chapters: 29 }, { name: 'ì—­ëŒ€í•˜', chapters: 36 }, { name: 'ì—ìŠ¤ë¼', chapters: 10 }, { name: 'ëŠí—¤ë¯¸ì•¼', chapters: 13 }, { name: 'ì—ìŠ¤ë”', chapters: 10 }, { name: 'ìš¥ê¸°', chapters: 42 }, { name: 'ì‹œí¸', chapters: 150 }, { name: 'ì ì–¸', chapters: 31 }, { name: 'ì „ë„ì„œ', chapters: 12 }, { name: 'ì•„ê°€', chapters: 8 }, { name: 'ì´ì‚¬ì•¼', chapters: 66 }, { name: 'ì˜ˆë ˆë¯¸ì•¼', chapters: 52 }, { name: 'ì˜ˆë ˆë¯¸ì•¼ì• ê°€', chapters: 5 }, { name: 'ì—ìŠ¤ê²”', chapters: 48 }, { name: 'ë‹¤ë‹ˆì—˜', chapters: 12 }, { name: 'í˜¸ì„¸ì•„', chapters: 14 }, { name: 'ìš”ì—˜', chapters: 3 }, { name: 'ì•„ëª¨ìŠ¤', chapters: 9 }, { name: 'ì˜¤ë°”ëŒœ', chapters: 1 }, { name: 'ìš”ë‚˜', chapters: 4 }, { name: 'ë¯¸ê°€', chapters: 7 }, { name: 'ë‚˜í›”', chapters: 3 }, { name: 'í•˜ë°•êµ­', chapters: 3 }, { name: 'ìŠ¤ë°”ëƒ', chapters: 3 }, { name: 'í•™ê°œ', chapters: 2 }, { name: 'ìŠ¤ê°€ë´', chapters: 14 }, { name: 'ë§ë¼ê¸°', chapters: 4 } ], new: [ { name: 'ë§ˆíƒœë³µìŒ', chapters: 28 }, { name: 'ë§ˆê°€ë³µìŒ', chapters: 16 }, { name: 'ëˆ„ê°€ë³µìŒ', chapters: 24 }, { name: 'ìš”í•œë³µìŒ', chapters: 21 }, { name: 'ì‚¬ë„í–‰ì „', chapters: 28 }, { name: 'ë¡œë§ˆì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„ì „ì„œ', chapters: 16 }, { name: 'ê³ ë¦°ë„í›„ì„œ', chapters: 13 }, { name: 'ê°ˆë¼ë””ì•„ì„œ', chapters: 6 }, { name: 'ì—ë² ì†Œì„œ', chapters: 6 }, { name: 'ë¹Œë¦½ë³´ì„œ', chapters: 4 }, { name: 'ê³¨ë¡œìƒˆì„œ', chapters: 4 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ', chapters: 5 }, { name: 'ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ', chapters: 3 }, { name: 'ë””ëª¨ë°ì „ì„œ', chapters: 6 }, { name: 'ë””ëª¨ë°í›„ì„œ', chapters: 4 }, { name: 'ë””ë„ì„œ', chapters: 3 }, { name: 'ë¹Œë ˆëª¬ì„œ', chapters: 1 }, { name: 'íˆë¸Œë¦¬ì„œ', chapters: 13 }, { name: 'ì•¼ê³ ë³´ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œì „ì„œ', chapters: 5 }, { name: 'ë² ë“œë¡œí›„ì„œ', chapters: 3 }, { name: 'ìš”í•œ1ì„œ', chapters: 5 }, { name: 'ìš”í•œ2ì„œ', chapters: 1 }, { name: 'ìš”í•œ3ì„œ', chapters: 1 }, { name: 'ìœ ë‹¤ì„œ', chapters: 1 }, { name: 'ìš”í•œê³„ì‹œë¡', chapters: 22 } ] };
let gapi = new GoogleSheetsAPI();
let db = { family: [], readRecords: {}, badges: {}, meditations: [], prayers: [] };
let currentUserForModal = null;
let currentBook = null;

// --- ì•± ì´ˆê¸°í™” ë° ë Œë”ë§ ---
document.addEventListener('DOMContentLoaded', async () => {
    setupEventListeners();
    renderWisdomVerse();
    renderBibleBooks();
    await initializeApp();
});

async function initializeApp() {
    updateConnectionStatus('loading');
    try {
        await gapi.testConnection();
        updateConnectionStatus('connected');
        await loadAllDataAndRender();
    } catch (error) {
        updateConnectionStatus('disconnected');
        alert("ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ í‘œì‹œë©ë‹ˆë‹¤.");
    }
}

async function loadAllDataAndRender() {
    try {
        const allData = await gapi.loadAllData();
        db = { ...db, ...allData };
        if (db.family && db.family.length > 0) {
            currentUserForModal = db.family[0].id;
            populateUserDropdowns();
            renderAll();
        } else if (gapi.isConnected) {
            alert("ê°€ì¡± ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ì˜ 'family_members' ì‹œíŠ¸ì— ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
        }
    } catch (error) { console.error('ì „ì²´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error); }
}

function renderAll() {
    renderFamilyDashboard();
    renderMeditations();
    renderPrayers();
}

function updateConnectionStatus(status) {
    const indicator = document.getElementById('status-indicator');
    const text = document.getElementById('status-text');
    const syncBtn = document.getElementById('sync-btn');
    indicator.classList.remove('loading');
    switch (status) {
        case 'connected': indicator.className = 'w-3 h-3 rounded-full bg-green-500'; text.textContent = 'ì˜¨ë¼ì¸'; syncBtn.classList.remove('hidden'); break;
        case 'disconnected': indicator.className = 'w-3 h-3 rounded-full bg-red-500'; text.textContent = 'ì˜¤í”„ë¼ì¸'; syncBtn.classList.add('hidden'); break;
        case 'loading': indicator.className = 'w-3 h-3 rounded-full bg-yellow-500 loading'; text.textContent = 'ì—°ê²° ì¤‘...'; syncBtn.classList.add('hidden'); break;
    }
}

function renderFamilyDashboard() {
    const dashboard = document.getElementById('family-dashboard');
    dashboard.innerHTML = '';
    if (!db.family || db.family.length === 0) return;
    const totalChapters = BIBLE_BOOKS.old.reduce((s, b) => s + b.chapters, 0) + BIBLE_BOOKS.new.reduce((s, b) => s + b.chapters, 0);
    db.family.forEach(member => {
        const userRecords = db.readRecords[member.id] || {};
        const chaptersRead = Object.values(userRecords).reduce((sum, chapters) => sum + chapters.length, 0);
        const progress = totalChapters > 0 ? (chaptersRead / totalChapters) * 100 : 0;
        const memberDiv = document.createElement('div');
        memberDiv.className = 'flex flex-col items-center cursor-pointer hover:opacity-80 transition';
        memberDiv.onclick = () => openProgressModal(member.id);
        memberDiv.innerHTML = `<img src="${member.photo || 'https://placehold.co/80x80/cccccc/FFFFFF?text=?'}" alt="${member.name}" class="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-white/50 object-cover shadow-md"><div class="font-bold mt-2">${member.title} (${member.name})</div><div class="w-full bg-white/30 rounded-full h-2.5 mt-1"><div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress.toFixed(2)}%"></div></div><div class="text-xs mt-1">${chaptersRead} / ${totalChapters} ì¥</div>`;
        dashboard.appendChild(memberDiv);
    });
}

function renderWisdomVerse() {
    const verses = [ "íƒœì´ˆì— í•˜ë‚˜ë‹˜ì´ ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹œë‹ˆë¼ (ì°½ 1:1)", "í•­ìƒ ê¸°ë»í•˜ë¼ ì‰¬ì§€ ë§ê³  ê¸°ë„í•˜ë¼ ë²”ì‚¬ì— ê°ì‚¬í•˜ë¼ (ì‚´ì „ 5:16-18)" ];
    document.getElementById('wisdom-verse').textContent = verses[Math.floor(Math.random() * verses.length)];
}
function renderBibleBooks() {
    const oldDiv = document.getElementById('old-testament');
    const newDiv = document.getElementById('new-testament');
    oldDiv.innerHTML = ''; newDiv.innerHTML = '';
    const createEl = (book) => {
        const el = document.createElement('button');
        el.className = 'p-2 text-sm rounded-md shadow-sm transition-all duration-200 accent-bg hover:shadow-lg hover:-translate-y-1';
        el.textContent = book.name;
        el.onclick = () => openChapterModal(book);
        return el;
    };
    BIBLE_BOOKS.old.forEach(book => oldDiv.appendChild(createEl(book)));
    BIBLE_BOOKS.new.forEach(book => newDiv.appendChild(createEl(book)));
}

function populateUserDropdowns() {
    const meditationUser = document.getElementById('meditation-user');
    const prayerUser = document.getElementById('prayer-user');
    const modalUser = document.getElementById('modal-user-selector');
    meditationUser.innerHTML = ''; prayerUser.innerHTML = ''; modalUser.innerHTML = '';
    db.family.forEach(member => {
        const option = `<option value="${member.id}">${member.name}</option>`;
        meditationUser.innerHTML += option;
        prayerUser.innerHTML += option;
        modalUser.innerHTML += option;
    });
}

function renderMeditations() {
    const list = document.getElementById('meditation-list');
    list.innerHTML = '';
    const currentUserId = document.getElementById('meditation-user').value;
    db.meditations.forEach(item => {
        const user = db.family.find(u => u.id === item.userId);
        const itemEl = document.createElement('div');
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm';
        let buttons = (item.userId === currentUserId) ? `<div class="inline-block ml-2"><button onclick="editMeditation('${item.id}')" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</button> <button onclick="deleteMeditation('${item.id}')" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button></div>` : '';
        itemEl.innerHTML = `<div><strong class="accent-text">${user ? user.name : '?'}:</strong> ${item.content}</div><div class="text-right text-gray-500 text-xs">${new Date(parseInt(item.id)).toLocaleDateString()} ${buttons}</div>`;
        list.appendChild(itemEl);
    });
    list.scrollTop = list.scrollHeight;
}
function renderPrayers() {
    const list = document.getElementById('prayer-list');
    list.innerHTML = '';
    const currentUserId = document.getElementById('prayer-user').value;
    db.prayers.forEach(item => {
        const user = db.family.find(u => u.id === item.userId);
        const itemEl = document.createElement('div');
        itemEl.className = 'p-2 mb-2 rounded bg-white/70 text-sm';
        let buttons = (item.userId === currentUserId) ? `<div class="inline-block ml-2"><button onclick="editPrayer('${item.id}')" class="text-xs text-blue-600 hover:underline">ìˆ˜ì •</button> <button onclick="deletePrayer('${item.id}')" class="text-xs text-red-600 hover:underline">ì‚­ì œ</button></div>` : '';
        itemEl.innerHTML = `<div><strong class="accent-text">${user ? user.name : '?'}:</strong> ${item.content}</div><div class="text-right text-gray-500 text-xs">${new Date(parseInt(item.id)).toLocaleDateString()} ${buttons}</div>`;
        list.appendChild(itemEl);
    });
    list.scrollTop = list.scrollHeight;
}

function setupEventListeners() {
    document.getElementById('theme-select').addEventListener('change', (e) => { document.body.className = e.target.value; });
    document.getElementById('add-meditation').addEventListener('click', addMeditation);
    document.getElementById('meditation-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addMeditation(); });
    document.getElementById('meditation-user').addEventListener('change', renderMeditations);
    document.getElementById('add-prayer').addEventListener('click', addPrayer);
    document.getElementById('prayer-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') addPrayer(); });
    document.getElementById('prayer-user').addEventListener('change', renderPrayers);
    document.getElementById('badges-btn').addEventListener('click', openBadgesModal);
    document.getElementById('close-badges-modal').addEventListener('click', closeBadgesModal);
    document.getElementById('sync-btn').addEventListener('click', () => { initializeApp(); alert('ë™ê¸°í™” ì™„ë£Œ!'); });
    document.getElementById('close-modal').onclick = closeChapterModal;
    document.getElementById('modal-user-selector').addEventListener('change', (e) => { currentUserForModal = e.target.value; updateModalForCurrentUser(); });
    document.getElementById('close-progress-modal').onclick = closeProgressModal;
}

async function addMeditation() {
    const userInput = document.getElementById('meditation-user');
    const textInput = document.getElementById('meditation-input');
    if (textInput.value.trim() === '') return;
    try {
        const result = await gapi.saveData({ type: 'meditation', userId: userInput.value, content: textInput.value.trim() });
        db.meditations.push(result.data);
        textInput.value = '';
        renderMeditations();
    } catch (error) { alert('ë¬µìƒ ì €ì¥ ì‹¤íŒ¨: ' + error.message); }
}
async function deleteMeditation(id) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await gapi.deleteData({ type: 'meditation', id: id });
        db.meditations = db.meditations.filter(item => item.id !== id);
        renderMeditations();
    } catch (error) { alert('ë¬µìƒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message); }
}
async function editMeditation(id) {
    const item = db.meditations.find(item => item.id === id);
    const newContent = prompt('ë¬µìƒ ë‚´ìš© ìˆ˜ì •:', item.content);
    if (newContent === null || newContent.trim() === '' || newContent.trim() === item.content) return;
    try {
        await gapi.editData({ type: 'meditation', id: id, content: newContent.trim() });
        item.content = newContent.trim();
        renderMeditations();
    } catch (error) { alert('ë¬µìƒ ìˆ˜ì • ì‹¤íŒ¨: ' + error.message); }
}
async function addPrayer() {
    const userInput = document.getElementById('prayer-user');
    const textInput = document.getElementById('prayer-input');
    if (textInput.value.trim() === '') return;
    try {
        const result = await gapi.saveData({ type: 'prayer', userId: userInput.value, content: textInput.value.trim() });
        db.prayers.push(result.data);
        textInput.value = '';
        renderPrayers();
    } catch (error) { alert('ê¸°ë„ì œëª© ì €ì¥ ì‹¤íŒ¨: ' + error.message); }
}
async function deletePrayer(id) {
    if (!confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
        await gapi.deleteData({ type: 'prayer', id: id });
        db.prayers = db.prayers.filter(item => item.id !== id);
        renderPrayers();
    } catch (error) { alert('ê¸°ë„ì œëª© ì‚­ì œ ì‹¤íŒ¨: ' + error.message); }
}
async function editPrayer(id) {
    const item = db.prayers.find(item => item.id === id);
    const newContent = prompt('ê¸°ë„ì œëª© ìˆ˜ì •:', item.content);
    if (newContent === null || newContent.trim() === '' || newContent.trim() === item.content) return;
    try {
        await gapi.editData({ type: 'prayer', id: id, content: newContent.trim() });
        item.content = newContent.trim();
        renderPrayers();
    } catch (error) { alert('ê¸°ë„ì œëª© ìˆ˜ì • ì‹¤íŒ¨: ' + error.message); }
}

function openBadgesModal() {
    document.getElementById('badges-modal').classList.remove('hidden');
    renderBadges('all');
}
function closeBadgesModal() {
    document.getElementById('badges-modal').classList.add('hidden');
}
function renderBadges(userId = 'all') { /* ë±ƒì§€ ë Œë”ë§ ë¡œì§ */ }

function openProgressModal(userId) {
    const user = db.family.find(u => u.id === userId);
    const userRecords = db.readRecords[userId] || {};
    if (!user) return;
    document.getElementById('progress-modal-title').textContent = `${user.name}ë‹˜ì˜ ì§„í–‰ í˜„í™©`;
    const contentDiv = document.getElementById('progress-modal-content');
    contentDiv.innerHTML = '';
    const allBooks = [...BIBLE_BOOKS.old, ...BIBLE_BOOKS.new];
    allBooks.forEach(book => {
        const readChapters = userRecords[book.name] || [];
        const progress = book.chapters > 0 ? (readChapters.length / book.chapters) * 100 : 0;
        const bookDiv = document.createElement('div');
        bookDiv.className = 'mb-3';
        bookDiv.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-bold">${book.name}</span><span class="text-sm text-gray-600">${readChapters.length} / ${book.chapters} ì¥</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="progress-bar-fill h-2.5 rounded-full" style="width: ${progress.toFixed(2)}%"></div></div>`;
        contentDiv.appendChild(bookDiv);
    });
    document.getElementById('progress-modal').classList.remove('hidden');
}
function closeProgressModal() {
    document.getElementById('progress-modal').classList.add('hidden');
}

function openChapterModal(book) {
    if (!db.family || db.family.length === 0) return;
    currentBook = book;
    document.getElementById('modal-title').textContent = book.name;
    document.getElementById('modal-user-selector').value = currentUserForModal;
    updateModalForCurrentUser();
    document.getElementById('chapter-modal').classList.remove('hidden');
}
function updateModalForCurrentUser() {
    const modalChapters = document.getElementById('modal-chapters');
    modalChapters.innerHTML = '';
    const userRecordsForBook = (db.readRecords[currentUserForModal] && db.readRecords[currentUserForModal][currentBook.name]) || [];
    for (let i = 1; i <= currentBook.chapters; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `p-2 rounded border transition-colors duration-200 ${userRecordsForBook.includes(i) ? 'bg-green-500 text-white border-green-500' : 'bg-white hover:bg-green-100'}`;
        btn.onclick = () => toggleChapterRead(i, btn);
        modalChapters.appendChild(btn);
    }
}
function toggleChapterRead(chapterNumber, buttonElement) {
    if (!db.readRecords[currentUserForModal]) db.readRecords[currentUserForModal] = {};
    if (!db.readRecords[currentUserForModal][currentBook.name]) db.readRecords[currentUserForModal][currentBook.name] = [];
    const readList = db.readRecords[currentUserForModal][currentBook.name];
    const chapterIndex = readList.indexOf(chapterNumber);
    const params = { type: 'reading', userId: currentUserForModal, bookName: currentBook.name, chapter: chapterNumber };
    if (chapterIndex > -1) {
        readList.splice(chapterIndex, 1);
        buttonElement.className = 'p-2 rounded border transition-colors duration-200 bg-white hover:bg-green-100';
    } else {
        readList.push(chapterNumber);
        buttonElement.className = 'p-2 rounded border transition-colors duration-200 bg-green-500 text-white border-green-500';
    }
    renderFamilyDashboard();
    const apiCall = (chapterIndex > -1) ? gapi.deleteData(params) : gapi.saveData(params);
    apiCall.catch(error => {
        alert(`ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì½ê¸° ìƒíƒœë¥¼ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
        const originalIndex = readList.indexOf(chapterNumber);
        if (originalIndex > -1) { readList.splice(originalIndex, 1); } else { readList.push(chapterNumber); }
        buttonElement.className = `p-2 rounded border transition-colors duration-200 ${readList.includes(chapterNumber) ? 'bg-green-500 text-white border-green-500' : 'bg-white hover:bg-green-100'}`;
        renderFamilyDashboard();
    });
}
function closeChapterModal() { document.getElementById('chapter-modal').classList.add('hidden'); }
</script>
</body>
</html>
